# RT-Threadå…¥é—¨å­¦ä¹ ç¬”è®°åˆ†äº«

â€‹	å‰è¨€ï¼šåœ¨å­¦ä¹ äº†51å•ç‰‡æœºï¼Œstm32ä»¥åï¼Œé€æ­¥å¯¹è£¸æœºå¼€å‘çš„æ–¹å¼æœ‰äº†äº†è§£ï¼Œè£¸æœºå¼€å‘ç®€å•ç²—æš´ï¼Œä¹Ÿæ˜¯æœ€é€‚åˆæ–°æ‰‹å…¥é—¨å­¦ä¹ åµŒå…¥å¼çš„ä¸€ç§å¼€å‘æ–¹å¼ï¼Œç¬”è€…åœ¨å‚åŠ äº†è¥¿é—¨å­åµŒå…¥å¼çš„æ—¶å€™æ¥è§¦åˆ°äº†ä¸€ç‚¹ç‚¹åŸºäºè£¸æœºå¼€å‘çš„è°ƒåº¦å™¨å¼€å‘ï¼Œæˆ‘ä¹ æƒ¯äºæŠŠä»–å«åšé«˜çº§ä¸€ç‚¹çš„è£¸æœºå¼€å‘ï¼Œå½“æ—¶åªæ˜¯æ¥è§¦äº†ä¸€ç‚¹ç‚¹ä»»åŠ¡è°ƒåº¦å™¨ï¼Œè§‰å¾—è›®æœ‰æ„æ€ï¼Œåœ¨æš‘å‡å‚åŠ å®Œç”µèµ›ä»¥åï¼Œæƒ³ç€è¶æ­¤æœºä¼šï¼Œè¶çƒ­æ‰“é“å­¦ä¹ ä¸€ä¸‹å®æ—¶æ“ä½œç³»ç»Ÿï¼Œæ­¤ç¬”è®°ä¹Ÿæ˜¯ä½œä¸ºå­¦ä¹ åˆ†äº«ï¼Œä¸€å®šæœ‰éå¸¸å¤šéœ€è¦æ”¹æ­£çš„åœ°æ–¹ï¼Œæ¬¢è¿å„ä½ä¸€èµ·æ¢è®¨ï¼Œä¸€èµ·ä½“éªŒåµŒå…¥å¼ çš„é­…åŠ›ã€‚æœ¬ç¬”è®°æ˜¯åŸºäºè¥¿é—¨å­åµŒå…¥å¼å¼€å‘æ¿çš„GD32F429VEè¿›è¡Œçš„ã€‚

## RT-Threadç¬¬ä¸€ä¸ªç¨‹åº-çº¿ç¨‹

1.æ‰“å¼€RT-Threadå®˜æ–¹IDE

![image-20250915195042412](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915195042412.png)

2.æ–°å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶

![image-20250915195253494](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915195253494.png)

3.é€‰æ‹©èŠ¯ç‰‡ï¼Œé€‰æ‹©è·¯å¾„ï¼Œæ‰“å¼€ä¸²å£1ï¼Œä½¿ç”¨DAPçƒ§å½•

![image-20250915195734264](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915195734264.png)

4.å¾—åˆ°æ­¤ç•Œé¢ï¼Œçœ‹åˆ°æœ‰ä¸»å‡½æ•°ï¼Œcubemxé…ç½®

![image-20250915200031262](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915200031262.png)

5.ç‚¹å‡»ä¸Šæ–¹Cubemxï¼Œå¼€å§‹é…ç½®

é…ç½®æ—¶é’Ÿï¼Œé…ç½®ä¸²å£

![image-20250915200504027](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915200504027.png)

![image-20250915200604123](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915200604123.png)

![image-20250915201115711](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201115711.png)

![image-20250915201124957](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201124957.png)

![image-20250915201147244](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201147244.png)

![image-20250915201203335](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201203335.png)

6.é…ç½®å®Œæˆä»¥åï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢æœ‰ä¸€ä¸ªCubemxçš„æ–‡ä»¶

![image-20250915201246165](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201246165.png)

7.å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªmain.cï¼Œä½†æ˜¯ä¸ä¼šå†²çª

![image-20250915201526439](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915201526439.png)

åŸå› ï¼š

1. **RT-Thread Studioä¸STM32CubeMXçš„æ•´åˆæ¨¡å¼ï¼š**
    å½“æ‚¨åœ¨RT-Thread Studioä¸­ä½¿ç”¨CubeMXç”Ÿæˆä»£ç æ—¶ï¼Œé€šå¸¸ä¼šå°†CubeMXä½œä¸ºRT-Threadé¡¹ç›®çš„ä¸€ä¸ªé…ç½®å·¥å…·ã€‚CubeMXä¼šç”Ÿæˆä¸€å¥—å®Œæ•´çš„HALåº“åˆå§‹åŒ–ä»£ç ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªå®ƒè‡ªå·±çš„ `main.c` æ–‡ä»¶ï¼ˆä½äº `cubemx/Src/main.c`ï¼‰ã€‚è¿™ä¸ª `main.c` æ–‡ä»¶åŒ…å«CubeMXç”Ÿæˆçš„ `int main(void)` å‡½æ•°ä»¥åŠå„ç§å¤–è®¾çš„ `MX_Init` å‡½æ•°è°ƒç”¨ã€‚

2. **ä¸¤ä¸ª `main.c` çš„è§’è‰²ï¼š**

   - **`application/main.c` (RT-Thread åº”ç”¨ç¨‹åºå…¥å£):** è¿™æ˜¯RT-Threadé¡¹ç›®çš„çœŸæ­£åº”ç”¨ç¨‹åºå…¥å£ç‚¹ã€‚å®ƒé€šå¸¸åŒ…å«RT-Threadçš„ `main` å‡½æ•°ï¼Œè´Ÿè´£ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆåŒ…æ‹¬è°ƒç”¨CubeMXç”Ÿæˆçš„åˆå§‹åŒ–å‡½æ•°ï¼‰ã€åˆ›å»ºä»»åŠ¡ã€å¯åŠ¨è°ƒåº¦å™¨ç­‰ã€‚æ‚¨çš„å¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ä»£ç ä¼šåœ¨è¿™é‡Œæˆ–ç”±å®ƒè°ƒç”¨çš„å…¶ä»–æ–‡ä»¶ä¸­å®ç°ã€‚
   - **`cubemx/Src/main.c` (CubeMX ç”Ÿæˆçš„åŸå§‹å…¥å£):** è¿™ä¸ªæ–‡ä»¶æ˜¯CubeMXç‹¬ç«‹ç”Ÿæˆæ—¶çš„åŸå§‹å…¥å£ã€‚å®ƒä¹ŸåŒ…å«ä¸€ä¸ª `int main(void)` å‡½æ•°ã€‚

3. **ä¸ºä»€ä¹ˆæ²¡æœ‰å†²çªï¼Ÿâ€”â€”æ„å»ºç³»ç»Ÿçš„å·¥ä½œï¼š**
    å†²çªä¹‹æ‰€ä»¥æ²¡æœ‰å‘ç”Ÿï¼Œæ˜¯å› ä¸ºRT-Thread Studioçš„**æ„å»ºç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯åŸºäºSConsæˆ–Makefileï¼‰è¢«é…ç½®ä¸ºåªç¼–è¯‘å’Œé“¾æ¥ `application/main.c`ï¼Œè€Œå¿½ç•¥æˆ–ä¸ç¼–è¯‘ `cubemx/Src/main.c`**ã€‚

   - **æ’é™¤ç¼–è¯‘ï¼š** æœ€å¸¸è§çš„æƒ…å†µæ˜¯ï¼Œ`cubemx/Src/main.c` æ–‡ä»¶è¢«æ˜ç¡®åœ°ä»é¡¹ç›®çš„ç¼–è¯‘åˆ—è¡¨ä¸­æ’é™¤ã€‚è¿™æ„å‘³ç€è™½ç„¶æ–‡ä»¶å­˜åœ¨äºé¡¹ç›®ç›®å½•ä¸­ï¼Œä½†æ„å»ºå·¥å…·ï¼ˆç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ï¼‰æ ¹æœ¬ä¸ä¼šå»å¤„ç†å®ƒã€‚
   - **ä»£ç ç§»æ¤ä¸è°ƒç”¨ï¼š** è™½ç„¶ `cubemx/Src/main.c` æœ¬èº«å¯èƒ½æ²¡æœ‰è¢«ç¼–è¯‘ï¼Œä½†å…¶ä¸­ç”±CubeMXç”Ÿæˆçš„**å¤–è®¾åˆå§‹åŒ–å‡½æ•°**ï¼ˆä¾‹å¦‚ `MX_GPIO_Init()`, `MX_USART1_UART_Init()`, `SystemClock_Config()` ç­‰ï¼‰çš„ä»£ç æ˜¯è‡³å…³é‡è¦çš„ã€‚åœ¨RT-Thread Studioç”Ÿæˆçš„é¡¹ç›®ä¸­ï¼Œè¿™äº›å‡½æ•°é€šå¸¸ä¼šè¢«**å¤åˆ¶åˆ°æˆ–ç”± `application/main.c` (æˆ– `board.c`) æ–‡ä»¶ä¸­çš„ `main` å‡½æ•°æˆ–è€… `rt_hw_board_init()` å‡½æ•°è°ƒç”¨**ï¼Œä»¥å®Œæˆç¡¬ä»¶çš„åˆå§‹åŒ–ã€‚

   ä»æ‚¨çš„é¡¹ç›®ç»“æ„å›¾æ¥çœ‹ï¼Œ`application/main.c` æ˜¯åœ¨ `application` ç›®å½•ä¸‹ï¼Œå¹¶ä¸”åœ¨é¡¹ç›®æµè§ˆå™¨ä¸­å¯è§ã€‚è€Œ `cubemx/Src/main.c` ä¹Ÿåœ¨ `cubemx/Src` ç›®å½•ä¸‹ã€‚æ‚¨æ‰“å¼€å¹¶ç¼–è¾‘çš„é€šå¸¸æ˜¯ `application/main.c`ï¼Œè¿™ä¹Ÿæ˜¯æ‚¨ç¼–å†™åº”ç”¨ä»£ç çš„åœ°æ–¹ã€‚

**æ€»ç»“æ¥è¯´ï¼š**

ä¸¤ä¸ª `main.c` æ–‡ä»¶å­˜åœ¨ï¼Œä½†åªæœ‰ `application/main.c` æ–‡ä»¶åŠå…¶åŒ…å«çš„ `main` å‡½æ•°ä¼šè¢«ç¼–è¯‘å’Œé“¾æ¥åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚`cubemx/Src/main.c` æ–‡ä»¶è¦ä¹ˆè¢«æ„å»ºç³»ç»Ÿç›´æ¥å¿½ç•¥ï¼Œè¦ä¹ˆå…¶å†…éƒ¨çš„ `main` å‡½æ•°è¢«æ¡ä»¶ç¼–è¯‘å®ç¦ç”¨ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯ä½œä¸ºCubeMXç”Ÿæˆåˆå§‹åŒ–ä»£ç çš„å®¹å™¨ã€‚RT-Threadçš„æ„å»ºç³»ç»Ÿä¼šå°†å¿…è¦çš„åˆå§‹åŒ–å‡½æ•°ä»CubeMXç”Ÿæˆçš„ä»£ç ä¸­æå–å‡ºæ¥ï¼Œå¹¶åœ¨RT-Threadè‡ªå·±çš„å¯åŠ¨æµç¨‹ä¸­è°ƒç”¨ã€‚

### ä¹¦å†™ç¬¬ä¸€ä¸ªç¨‹åºä»£ç -æ‰“å°

ä»£ç 

```
* åˆ›å»ºçº¿ç¨‹ç¤ºä¾‹ /
static rt_thread_t tid1 = RT_NULL;

static void thread1_entry(void* parameter)
{
		int count = 0;
		while (1)
	{
		rt_kprintf("Thread 1 is running, count: %d\n", count);
		count +;
		rt_thread_mdelay(1000); / ä¼‘æ¯ 1 ç§’
	}
}

int main(void)
{
 * åˆ›å»ºçº¿ç¨‹ 1 /
	tid1 = rt_thread_create("thread1",
	thread1_entry, RT_NULL,
	1024, 20, 10);
	* å¯åŠ¨çº¿ç¨‹ /
		if (tid1 != RT_NULL)
	{
		rt_thread_startup(tid1);
	}
	return 0;
}
```

![image-20250915202106240](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915202106240.png)

ä¸‹è½½ç¨‹åº

![image-20250915202221954](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915202221954.png)

æ‰“å¼€ä¸²å£åŠ©æ‰‹,è§‚å¯Ÿç°è±¡ï¼Œæ¯ç§’æ‰“å°ä¸€æ¬¡

![image-20250915202715832](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915202715832.png)

### è¿™ä¸ªçº¿ç¨‹æ˜¯æ€æ ·å·¥ä½œçš„ï¼Ÿ

1.åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹æ˜¯ç»“æ„ä½“rt-thread![image-20250915203102762](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915203102762.png)

![image-20250915203117035](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915203117035.png)

rt-threadç»“æ„ä½“çš„å‚æ•°å¾ˆå¤šï¼ŒåŸå› ï¼š

`rt_thread` ç»“æ„ä½“ç¡®å®åŒ…å«äº†å¾ˆå¤šå‚æ•°ã€‚è¿™ä½“ç°äº†RT-Threadä½œä¸ºä¸€æ¬¾æˆç†Ÿçš„å®æ—¶æ“ä½œç³»ç»Ÿï¼ˆRTOSï¼‰å¯¹çº¿ç¨‹è¿›è¡Œå…¨é¢ç®¡ç†å’Œæ§åˆ¶çš„éœ€è¦ã€‚

è¿™äº›å‚æ•°çš„è®¾ç½®æ˜¯ä¸ºäº†æ»¡è¶³å®æ—¶è°ƒåº¦ã€èµ„æºç®¡ç†ã€åŒæ­¥é€šä¿¡ã€é”™è¯¯å¤„ç†ä»¥åŠä¸åŒåº”ç”¨åœºæ™¯ï¼ˆå¦‚å¤šæ ¸ã€ä¿¡å·ã€æ¨¡å—åŒ–ç­‰ï¼‰çš„å¤æ‚éœ€æ±‚ã€‚ä¸‹é¢æˆ‘å°†è¿™äº›å‚æ•°è¿›è¡Œåˆ†ç±»ï¼Œå¹¶ç®€è¦è§£é‡Šå®ƒä»¬çš„ä½œç”¨ï¼š

1. **åŸºæœ¬ä¿¡æ¯å’Œå¯¹è±¡ç®¡ç† (`rt object` éƒ¨åˆ†)**
   - `name[RT_NAME_MAX]`: çº¿ç¨‹çš„åç§°ï¼Œç”¨äºè°ƒè¯•å’Œç®¡ç†ã€‚
   - `type`: å¯¹è±¡ç±»å‹ï¼Œæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚
   - `flags`: çº¿ç¨‹çš„å„ç§å±æ€§æ ‡å¿—ï¼Œä¾‹å¦‚æ˜¯å¦æ˜¯åŠ¨æ€åˆ›å»ºã€æ˜¯å¦éœ€è¦æ¸…ç†ç­‰ã€‚
   - `list`: ç”¨äºå°†çº¿ç¨‹é“¾æ¥åˆ°å…¨å±€å¯¹è±¡åˆ—è¡¨ä¸­ã€‚
   - `tlist`: ç”¨äºå°†çº¿ç¨‹é“¾æ¥åˆ°å„ç§çº¿ç¨‹çŠ¶æ€ï¼ˆå°±ç»ªã€æŒ‚èµ·ç­‰ï¼‰é“¾è¡¨ä¸­ã€‚
   - `module_id` (å¦‚æœ `RT_USING_MODULE` å¼€å¯): ç”¨äºæ¨¡å—åŒ–ï¼ˆLWPï¼‰ç®¡ç†ï¼Œå…³è”çº¿ç¨‹æ‰€å±çš„æ¨¡å—ã€‚
2. **æ ˆå’Œæ‰§è¡Œä¸Šä¸‹æ–‡ (`stack point and entry` éƒ¨åˆ†)**
   - `sp`: æ ˆæŒ‡é’ˆï¼Œä¿å­˜çº¿ç¨‹åˆ‡æ¢æ—¶çš„CPUå¯„å­˜å™¨ä¿¡æ¯ï¼Œæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒã€‚
   - `entry`: çº¿ç¨‹çš„å…¥å£å‡½æ•°åœ°å€ï¼Œå³çº¿ç¨‹å¼€å§‹æ‰§è¡Œçš„åœ°æ–¹ã€‚
   - `parameter`: ä¼ é€’ç»™çº¿ç¨‹å…¥å£å‡½æ•°çš„å‚æ•°ã€‚
   - `stack_addr`: çº¿ç¨‹æ ˆçš„èµ·å§‹åœ°å€ã€‚
   - `stack_size`: çº¿ç¨‹æ ˆçš„å¤§å°ã€‚
3. **çŠ¶æ€å’Œé”™è¯¯å¤„ç†**
   - `error`: çº¿ç¨‹æœ€è¿‘ä¸€æ¬¡æ“ä½œçš„é”™è¯¯ç ã€‚
   - `stat`: çº¿ç¨‹çš„å½“å‰çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼šåˆå§‹åŒ–ã€å°±ç»ªã€è¿è¡Œã€æŒ‚èµ·ã€é˜»å¡ã€é€€å‡ºï¼‰ã€‚
4. **è°ƒåº¦å’Œä¼˜å…ˆçº§**
   - `current_priority`: çº¿ç¨‹å½“å‰çš„ä¼˜å…ˆçº§ã€‚
   - `number`, `high_mask`, `number_mask` (å¦‚æœ `RT_THREAD_PRIORITY_MAX > 32`): ç”¨äºé«˜æ•ˆçš„å°±ç»ªçº¿ç¨‹æŸ¥æ‰¾ç®—æ³•ã€‚
   - `init_tick`: çº¿ç¨‹åˆå§‹åŒ–æ—¶çš„ç³»ç»Ÿæ—¶é’ŸèŠ‚æ‹æ•°ã€‚
   - `remaining_tick`: çº¿ç¨‹åœ¨å½“å‰æ—¶é—´ç‰‡ä¸­å‰©ä½™çš„èŠ‚æ‹æ•°ï¼Œç”¨äºæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ã€‚
5. **å¤šæ ¸æ”¯æŒ (SMP, å¦‚æœ `RT_USING_SMP` å¼€å¯)**
   - `bind_cpu`: çº¿ç¨‹ç»‘å®šåˆ°çš„CPUæ ¸å¿ƒï¼ˆå¦‚æœæ”¯æŒï¼‰ã€‚
   - `oncpu`: çº¿ç¨‹å½“å‰æ­£åœ¨å“ªä¸ªCPUæ ¸å¿ƒä¸Šè¿è¡Œã€‚
   - `scheduler_lock_nest`, `cpus_lock_nest`, `critical_lock_nest`: ç”¨äºåµŒå¥—é”è®¡æ•°ï¼Œç®¡ç†å¤šæ ¸ç¯å¢ƒä¸‹çš„è°ƒåº¦å™¨å’ŒCPUé”å®šã€‚
6. **äº‹ä»¶é›† (å¦‚æœ `RT_USING_EVENT` å¼€å¯)**
   - `event_set`: çº¿ç¨‹æ­£åœ¨ç­‰å¾…çš„äº‹ä»¶é›†ã€‚
   - `event_info`: äº‹ä»¶æ ‡å¿—ï¼Œè¡¨ç¤ºç­‰å¾…äº‹ä»¶çš„æ¨¡å¼ï¼ˆä¸/æˆ–ï¼‰ã€‚
7. **ä¿¡å· (å¦‚æœ `RT_USING_SIGNALS` å¼€å¯)**
   - `sig_pending`: çº¿ç¨‹å¾…å¤„ç†çš„ä¿¡å·ã€‚
   - `sig_mask`: çº¿ç¨‹å±è”½çš„ä¿¡å·ã€‚
   - `sig_ret`: ä»ä¿¡å·å¤„ç†å‡½æ•°è¿”å›æ—¶çš„æ ˆæŒ‡é’ˆã€‚
   - `sig_vectors`: ä¿¡å·å¤„ç†å‡½æ•°çš„å‘é‡è¡¨ã€‚
   - `si_list`: ä¿¡å·ä¿¡æ¯åˆ—è¡¨ã€‚
8. **CPUä½¿ç”¨ç‡ç»Ÿè®¡ (å¦‚æœ `RT_USING_CPU_USAGE` å¼€å¯)**
   - `duration_tick`: çº¿ç¨‹è¿è¡Œæ‰€æ¶ˆè€—çš„CPUèŠ‚æ‹æ•°ï¼Œç”¨äºè®¡ç®—CPUä½¿ç”¨ç‡ã€‚
9. **POSIX Pthreads å…¼å®¹ (å¦‚æœ `RT_USING_PTHREADS` å¼€å¯)**
   - `pthread_data`: POSIX Pthreads ç›¸å…³çš„æ•°æ®ã€‚
10. **çº¿ç¨‹è‡ªå¸¦å®šæ—¶å™¨**
    - `thread_timer`: æ¯ä¸ªçº¿ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªå†…ç½®çš„å®šæ—¶å™¨ï¼Œç”¨äºå®ç°è¶…æ—¶ç­‰å¾…ç­‰åŠŸèƒ½ã€‚
11. **çº¿ç¨‹é€€å‡ºæ¸…ç†**
    - `cleanup`: çº¿ç¨‹é€€å‡ºæ—¶è°ƒç”¨çš„æ¸…ç†å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾çº¿ç¨‹å ç”¨çš„èµ„æºã€‚
12. **è½»é‡çº§è¿›ç¨‹ (LWP, å¦‚æœ `RT_USING_LWP` å¼€å¯)**
    - `lwp`: æŒ‡å‘æ‰€å±çš„è½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼‰ç»“æ„ä½“çš„æŒ‡é’ˆã€‚
13. **ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®**
    - `user_data`: ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çš„æ•°æ®åŸŸï¼Œæ–¹ä¾¿å°†ä¸€äº›åº”ç”¨å±‚æ•°æ®ç»‘å®šåˆ°çº¿ç¨‹å¯¹è±¡ä¸Šã€‚

ä»è¿™ä¸ªåˆ†è§£å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨RTOSä¸­ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„â€œæ‰§è¡Œæµâ€ï¼Œå®ƒè¿˜éœ€è¦æ‰¿è½½å¤§é‡çš„ç®¡ç†ä¿¡æ¯ï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆåœ°è°ƒåº¦ã€åŒæ­¥ã€é€šä¿¡ï¼Œå¹¶æä¾›å„ç§é«˜çº§åŠŸèƒ½ã€‚å‚æ•°å¤šï¼Œä¹Ÿæ„å‘³ç€åŠŸèƒ½å¼ºå¤§å’Œç®¡ç†ç»†è‡´ã€‚



2.ç¼–å†™å…¥å£å‡½æ•°ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼Œæˆ‘è¿™ä¸ªçº¿ç¨‹æ˜¯æ¥å¹²å•¥çš„ï¼Œéœ€è¦å®Œæˆä»€ä¹ˆå·¥ä½œ

![image-20250915203324463](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915203324463.png)



3.ä¸»å‡½æ•°è°ƒç”¨

![image-20250915203423099](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915203423099.png)

åˆ›å»ºçº¿ç¨‹çš„å‡½æ•°ï¼šrt_thread_create

```
rt_thread_t rt_thread_create(const char *name,//åç§°
	void (*entry)(void *parameter),//å…¥å£å‡½æ•°
	void *parameter,//å…¥å£å‚æ•°
	rt_uint32_t stack_size,//å †æ ˆå¤§å°
	rt_uint8_t priority,//ä¼˜å…ˆçº§
	rt_uint32_t tick);//æ—¶é—´ç‰‡
```

ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

ï¼š`rt_thread_create` æ˜¯ RT-Thread å®æ—¶æ“ä½œç³»ç»Ÿä¸­ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„ API å‡½æ•°ï¼Œç”¨äº**åŠ¨æ€åˆ›å»ºä¸€ä¸ªçº¿ç¨‹**ã€‚

å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š

1. **åˆ†é…çº¿ç¨‹èµ„æº**ï¼šä¸ºæ–°çº¿ç¨‹åˆ†é…å†…å­˜ç©ºé—´ï¼ŒåŒ…æ‹¬çº¿ç¨‹æ§åˆ¶å—ï¼ˆTCBï¼Œ`rt_thread_t` ç±»å‹ï¼‰å’Œçº¿ç¨‹æ ˆã€‚
2. **åˆå§‹åŒ–çº¿ç¨‹**ï¼šåˆå§‹åŒ–çº¿ç¨‹çš„å„é¡¹å±æ€§ï¼Œå¦‚çº¿ç¨‹åã€å…¥å£å‡½æ•°ã€è¿è¡Œå‚æ•°ã€æ ˆå¤§å°ã€ä¼˜å…ˆçº§å’Œæ—¶é—´ç‰‡ç­‰ã€‚
3. **å°†çº¿ç¨‹åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—**ï¼šåˆ›å»ºæˆåŠŸçš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚

è®©æˆ‘ä»¬è¯¦ç»†è§£æä¸€ä¸‹ `rt_thread_create` å‡½æ•°çš„å„ä¸ªå‚æ•°ï¼š

```c
rt_thread_t rt_thread_create(const char *name,
                             void (*entry)(void *parameter),
                             void        *parameter,
                             rt_uint32_t  stack_size,
                             rt_uint8_t   priority,
                             rt_uint32_t  tick);
```

1. **`const char \*name`**:
   - **ä½œç”¨**ï¼šçº¿ç¨‹çš„åç§°ã€‚
   - **è¯´æ˜**ï¼šè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†çº¿ç¨‹ã€‚åœ¨è°ƒè¯•å’Œä½¿ç”¨ RT-Thread çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚ FinSHï¼‰æ—¶ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹åæ¥æŸ¥çœ‹æˆ–æ“ä½œç‰¹å®šçš„çº¿ç¨‹ï¼Œéå¸¸æ–¹ä¾¿ã€‚é•¿åº¦é€šå¸¸æœ‰é™åˆ¶ï¼ˆå¦‚ `RT_NAME_MAX`ï¼‰ï¼Œå»ºè®®èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ã€‚åœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `"thread1"`ã€‚
2. **`void (\*entry)(void \*parameter)`**:
   - **ä½œç”¨**ï¼šçº¿ç¨‹çš„å…¥å£å‡½æ•°ï¼ˆæˆ–ç§°çº¿ç¨‹ä¸»å‡½æ•°ï¼‰ã€‚
   - **è¯´æ˜**ï¼šè¿™æ˜¯çº¿ç¨‹å¼€å§‹æ‰§è¡Œçš„ä»£ç ä½ç½®ã€‚å½“çº¿ç¨‹è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šä»è¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€è¡Œå¼€å§‹è¿è¡Œã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼ˆå¦‚ `while(1)`ï¼‰ï¼Œä»¥ä¿è¯çº¿ç¨‹æŒç»­è¿è¡Œã€‚åœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `thread1_entry`ã€‚
3. **`void \*parameter`**:
   - **ä½œç”¨**ï¼šä¼ é€’ç»™çº¿ç¨‹å…¥å£å‡½æ•°çš„å‚æ•°ã€‚
   - **è¯´æ˜**ï¼šå½“çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œè¿™ä¸ªå‚æ•°ä¼šè¢«ä½œä¸º `entry` å‡½æ•°çš„ `parameter` å‚æ•°ä¼ å…¥ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥ä¼ é€’ä»»ä½•è‡ªå®šä¹‰çš„æ•°æ®æˆ–ç»“æ„ä½“æŒ‡é’ˆç»™çº¿ç¨‹ï¼Œä»¥ä¾¿çº¿ç¨‹å¯ä»¥æ ¹æ®è¿™äº›æ•°æ®è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰§è¡Œç‰¹å®šæ“ä½œã€‚å¦‚æœä¸éœ€è¦ä¼ é€’å‚æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸º `RT_NULL`ï¼Œåœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `RT_NULL`ã€‚
4. **`rt_uint32_t stack_size`**:
   - **ä½œç”¨**ï¼šçº¿ç¨‹æ ˆçš„å¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ã€‚
   - **è¯´æ˜**ï¼šçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨æ ˆæ¥å­˜å‚¨å±€éƒ¨å˜é‡ã€å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡ã€ä¸­æ–­è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚è¿™ä¸ªå‚æ•°å†³å®šäº†ä¸ºçº¿ç¨‹åˆ†é…å¤šå°‘å†…å­˜ä½œä¸ºå…¶ç§æœ‰æ ˆç©ºé—´ã€‚å¦‚æœæ ˆå¤ªå°ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ï¼Œç³»ç»Ÿå´©æºƒï¼›å¦‚æœæ ˆå¤ªå¤§ï¼Œä¼šæµªè´¹å†…å­˜èµ„æºã€‚éœ€è¦æ ¹æ®çº¿ç¨‹çš„å¤æ‚åº¦å’Œæ·±åº¦è¿›è¡Œåˆç†è¯„ä¼°ã€‚åœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `1024`ï¼ˆå­—èŠ‚ï¼‰ã€‚
5. **`rt_uint8_t priority`**:
   - **ä½œç”¨**ï¼šçº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚
   - **è¯´æ˜**ï¼šRT-Thread æ”¯æŒ 256 ä¸ªä¼˜å…ˆçº§ï¼ˆ0-250 ç”¨äºç”¨æˆ·çº¿ç¨‹ï¼Œè¶Šå°çš„æ•°å­—ä»£è¡¨è¶Šé«˜çš„ä¼˜å…ˆçº§ï¼‰ã€‚ä¼˜å…ˆçº§å†³å®šäº†çº¿ç¨‹è¢«è°ƒåº¦æ‰§è¡Œçš„ä¼˜å…ˆé¡ºåºã€‚é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¼šä¼˜å…ˆäºä½ä¼˜å…ˆçº§çš„çº¿ç¨‹æ‰§è¡Œã€‚åœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `20`ã€‚
6. **`rt_uint32_t tick`**:
   - **ä½œç”¨**ï¼šçº¿ç¨‹çš„æ—¶é—´ç‰‡ï¼ˆå•ä½ï¼šç³»ç»Ÿæ—¶é’ŸèŠ‚æ‹ï¼Œtickï¼‰ã€‚
   - **è¯´æ˜**ï¼šå½“å¤šä¸ªç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹å¤„äºå°±ç»ªæ€æ—¶ï¼Œè°ƒåº¦å™¨ä¼šè½®æµæ‰§è¡Œå®ƒä»¬ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œ `tick` ä¸ªç³»ç»Ÿæ—¶é’ŸèŠ‚æ‹åï¼Œä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹æ‰§è¡Œã€‚è¿™ä¸ªå‚æ•°åªå¯¹åŒä¼˜å…ˆçº§çš„çº¿ç¨‹è½®è½¬è°ƒåº¦æœ‰æ„ä¹‰ã€‚å¦‚æœçº¿ç¨‹åœ¨æ—¶é—´ç‰‡ç”¨å®Œå‰ä¸»åŠ¨è°ƒç”¨äº†é˜»å¡å‡½æ•°ï¼ˆå¦‚ `rt_thread_mdelay`ã€ä¿¡å·é‡ç­‰ï¼‰ï¼Œåˆ™ä¼šç«‹å³è®©å‡º CPUã€‚åœ¨ä½ çš„ä¾‹å­ä¸­æ˜¯ `10`ã€‚

**è¿”å›å€¼**ï¼š

- æˆåŠŸæ—¶è¿”å›æŒ‡å‘æ–°åˆ›å»ºçº¿ç¨‹æ§åˆ¶å—çš„æŒ‡é’ˆï¼ˆ`rt_thread_t`ï¼‰ã€‚
- å¤±è´¥æ—¶è¿”å› `RT_NULL`ï¼ˆä¾‹å¦‚ï¼Œå†…å­˜ä¸è¶³æˆ–å‚æ•°ä¸åˆæ³•ï¼‰ã€‚

**ä½¿ç”¨æµç¨‹**ï¼š

é€šå¸¸ï¼Œ`rt_thread_create` å’Œ `rt_thread_startup` é…åˆä½¿ç”¨ï¼š

1. **`rt_thread_create(...)`**ï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–çº¿ç¨‹ï¼Œåˆ†é…èµ„æºï¼Œä½†ä¸ç«‹å³è¿è¡Œã€‚çº¿ç¨‹æ­¤æ—¶å¤„äºâ€œåˆå§‹åŒ–â€çŠ¶æ€ã€‚
2. **`rt_thread_startup(tid)`**ï¼šå¯åŠ¨çº¿ç¨‹ã€‚å°†çº¿ç¨‹ä»â€œåˆå§‹åŒ–â€çŠ¶æ€è½¬æ¢ä¸ºâ€œå°±ç»ªâ€çŠ¶æ€ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°è°ƒåº¦å™¨çš„å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚ä¹‹åï¼Œè°ƒåº¦å™¨å°±å¯ä»¥æ ¹æ®çº¿ç¨‹çš„ä¼˜å…ˆçº§è¿›è¡Œè°ƒåº¦æ‰§è¡Œäº†ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œ`rt_thread_create` æ˜¯ RT-Thread ä¸­åŠ¨æ€åˆ›å»ºå¹¶é…ç½®çº¿ç¨‹çš„å…³é”®å‡½æ•°ï¼Œä¸ºå¤šä»»åŠ¡å¹¶å‘æä¾›äº†åŸºç¡€ã€‚



å…¥å£å‡½æ•°é‡Œé¢ï¼Œä¸ºä»€ä¹ˆè¦delay1ç§’ï¼Ÿ

ï¼šè¿™ä¸ª `rt_thread_mdelay(1000);` çš„ä½œç”¨æ˜¯è®©å½“å‰çº¿ç¨‹ï¼ˆ`thread1`ï¼‰ä¼‘çœ 1000æ¯«ç§’ï¼ˆå³1ç§’ï¼‰ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªé‡è¦çš„åŸå› ï¼š

1. **é¿å…CPUç©ºè½¬å’Œèµ„æºè€—å°½ï¼ˆPreventing CPU Hoggingï¼‰**ï¼š
    å¦‚æœæ²¡æœ‰è¿™ä¸ªå»¶æ—¶ï¼Œ`while(1)` å¾ªç¯ä¼šä»¥æé«˜çš„é€Ÿåº¦æ‰§è¡Œï¼Œä¸æ–­åœ°æ‰“å°æ¶ˆæ¯å¹¶å¢åŠ è®¡æ•°ã€‚è¿™å°†å¯¼è‡´ `thread1` çº¿ç¨‹å‡ ä¹ç‹¬å CPUæ—¶é—´ï¼Œä¸ç»™å…¶ä»–çº¿ç¨‹æˆ–ç³»ç»Ÿä»»åŠ¡ç•™å‡ºæ‰§è¡Œçš„æœºä¼šï¼Œé€ æˆCPUèµ„æºçš„ä¸¥é‡æµªè´¹å’Œç³»ç»Ÿå“åº”è¿Ÿé’ã€‚
2. **è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ï¼ˆYielding CPU to Other Threadsï¼‰**ï¼š
    RT-Threadæ˜¯ä¸€ä¸ªå®æ—¶æ“ä½œç³»ç»Ÿï¼Œå®ƒé€šè¿‡è°ƒåº¦å™¨æ¥ç®¡ç†å’Œåˆ‡æ¢çº¿ç¨‹çš„æ‰§è¡Œã€‚å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `rt_thread_mdelay()` è¿›å…¥ä¼‘çœ çŠ¶æ€æ—¶ï¼Œå®ƒä¼šä¸»åŠ¨æ”¾å¼ƒCPUçš„ä½¿ç”¨æƒï¼Œè°ƒåº¦å™¨å°±ä¼šæœ‰æœºä¼šé€‰æ‹©å°±ç»ªé˜Ÿåˆ—ä¸­çš„å…¶ä»–çº¿ç¨‹æ¥æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ç³»ç»Ÿä¸­çš„å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå…¬å¹³åœ°å…±äº«CPUèµ„æºï¼Œå®ç°å¹¶å‘æ‰§è¡Œã€‚
3. **æ§åˆ¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼ˆControlling Task Execution Frequencyï¼‰**ï¼š
    åœ¨è®¸å¤šå®æ—¶åº”ç”¨ä¸­ï¼ŒæŸäº›ä»»åŠ¡ä¸éœ€è¦æŒç»­é«˜é€Ÿè¿è¡Œï¼Œè€Œæ˜¯éœ€è¦ä»¥ä¸€å®šçš„å‘¨æœŸæˆ–é¢‘ç‡æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæ¯ç§’é’Ÿè¯»å–ä¸€æ¬¡ä¼ æ„Ÿå™¨æ•°æ®ã€æ¯ç§’é’Ÿæ›´æ–°ä¸€æ¬¡æ˜¾ç¤ºç­‰ã€‚é€šè¿‡è®¾ç½®å»¶æ—¶ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé—´éš”ï¼Œä½¿å…¶æŒ‰ç…§é¢„æœŸçš„é¢‘ç‡å·¥ä½œã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°±æ˜¯æ¯ç§’æ‰“å°ä¸€æ¬¡è®¡æ•°ã€‚
4. **æé«˜å¯è§‚å¯Ÿæ€§ï¼ˆImproving Observabilityï¼‰**ï¼š
    å¦‚æœ `thread1` ä¸åœåœ°æ‰“å°ï¼Œæ§åˆ¶å°ä¼šè¿…é€Ÿè¢«åˆ·å±ï¼Œæˆ‘ä»¬å¾ˆéš¾çœ‹æ¸…æ¯ä¸€æ¡æ¶ˆæ¯ã€‚æœ‰äº†1ç§’çš„å»¶æ—¶ï¼Œè¾“å‡ºä¼šå˜å¾—æœ‰èŠ‚å¥ï¼Œæ–¹ä¾¿å¼€å‘è€…è§‚å¯Ÿçº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å’Œè®¡æ•°å˜åŒ–ã€‚
5. **èŠ‚çœèƒ½æºï¼ˆEnergy Savingï¼‰**ï¼š
    åœ¨æŸäº›ä½åŠŸè€—åº”ç”¨ä¸­ï¼Œè®©çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼ˆè€Œä¸æ˜¯ç©ºè½¬ï¼‰å¯ä»¥å‡å°‘CPUçš„æ´»è·ƒæ—¶é—´ï¼Œä»è€Œé™ä½æ•´ä½“ç³»ç»Ÿçš„åŠŸè€—ã€‚

æ€»ä¹‹ï¼Œ`rt_thread_mdelay(1000);` æ˜¯åœ¨RTOSç¼–ç¨‹ä¸­ä¸€ç§éå¸¸å¸¸è§ä¸”é‡è¦çš„æ“ä½œï¼Œç”¨äºåè°ƒçº¿ç¨‹æ‰§è¡Œã€ç®¡ç†CPUèµ„æºã€æ§åˆ¶ä»»åŠ¡é¢‘ç‡ä»¥åŠä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚





## RT-Threadç¬¬äºŒä¸ªç¨‹åº-LEDæ§åˆ¶çº¿ç¨‹

1.ä»£ç 

```
#include <rtthread.h> / å¼•å…¥ RT-Thread å¤´æ–‡ä»¶
#define LED_STACK_SIZE 512 / æ ˆå¤§å°
#define LED_PRIORITY 25 / çº¿ç¨‹ä¼˜å…ˆçº§
#define LED_TICK 5 / æ—¶é—´ç‰‡å¤§å°

/ 1. å®šä¹‰ LED æ§åˆ¶çº¿ç¨‹çš„å…¥å£å‡½æ•°
void led_thread_entry(void *parameter)
{
		rt_kprintf("LED Thread Running .\n"); / è¾“å‡ºçº¿ç¨‹è¿è¡Œæç¤º
		while (1)
	{
	* æ§åˆ¶ LED çš„ç‚¹äº®ä¸ç†„ç­ /
	rt_pin_write(LED_PIN, PIN_HIGH); / ç‚¹äº® LED
	rt_thread_mdelay(500); / å»¶æ—¶ 500 ms
	rt_pin_write(LED_PIN, PIN_LOW); / ç†„ç­ LED
	rt_thread_mdelay(500); / å†å»¶æ—¶ 500 ms
	}
}

/ 2. åœ¨ä¸»å‡½æ•°ä¸­åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
int main(void)
{
	/ ä½¿ç”¨ rt_thread_create åˆ›å»º LED æ§åˆ¶çº¿ç¨‹
	rt_thread_t led_thread = rt_thread_create("led_ctrl", / çº¿ç¨‹åï¼Œä¾¿äºè°ƒè¯•æ—¶æŸ¥çœ‹
	led_thread_entry, / çº¿ç¨‹å…¥å£å‡½æ•°
	RT_NULL, / çº¿ç¨‹å…¥å£å‚æ•°ï¼Œä¸éœ€è¦å‚æ•°æ—¶è®¾ä¸º RT_NULL
	LED_STACK_SIZE, / æ ˆå¤§å°512 å­—èŠ‚
	LED_PRIORITY, / ä¼˜å…ˆçº§25
	LED_TICK); / æ—¶é—´ç‰‡å¤§å° 5
	/ å¦‚æœçº¿ç¨‹åˆ›å»ºæˆåŠŸï¼Œåˆ™å¯åŠ¨è¯¥çº¿ç¨‹
		if (led_thread = RT_NULL)
	{
		rt_thread_startup(led_thread); / å¯åŠ¨çº¿ç¨‹
	}
return 0;
}
```

2.ä¸Šè¿°ä»£ç æœ‰é—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹è®¸å¤šé—®é¢˜

ç¬¬ä¸€ï¼Œéœ€è¦åŠ ä¸Š`#include <rtdevice.h>`è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œå¦åˆ™`PIN_HIGH`ä¼šå¤±æ•ˆï¼Œæœªå®šä¹‰

![image-20250915211945720](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915211945720.png)

ç¬¬äºŒï¼Œcubemxé…ç½®äº†PD8ï¼Œä¸ä»£è¡¨ç€rtä¸»å‡½æ•°å†…å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦é‡æ–°é…ç½®rté‡Œé¢çš„æ¥å£

![image-20250915212035935](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915212035935.png)

![image-20250915212051734](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250915212051734.png)

3.æ³¨æ„ç‚¹ï¼š

è¯¦ç»†è§£é‡Šä¸€ä¸‹ **ä¸ºä»€ä¹ˆåœ¨ RT-Thread é‡Œä¸èƒ½ç›´æ¥æŒ‡æœ› CubeMX çš„ GPIO é…ç½®ç”Ÿæ•ˆ**ï¼Œä»¥åŠ **ä»¥åæ€ä¹ˆç”¨ CubeMX + RT-Thread ç»“åˆ** æ‰çœäº‹ã€‚

------

**1. ä¸ºä»€ä¹ˆ CubeMX é…ç½®ä¼šå¤±æ•ˆï¼Ÿ**

RT-Thread çš„ **BSPï¼ˆæ¿çº§æ”¯æŒåŒ…ï¼‰** åœ¨å¯åŠ¨æ—¶é€šå¸¸ä¼š**é‡æ–°åˆå§‹åŒ–æ‰€æœ‰å¤–è®¾**ï¼ŒåŒ…æ‹¬ GPIOã€‚

æ¯”å¦‚ STM32 BSP å¯åŠ¨æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```
main() â†’ rtthread_startup()
            â†’ rtcomponents_init()
                 â†’ PIN é©±åŠ¨åˆå§‹åŒ–ï¼ˆdrv_gpio.cï¼‰
                        â†’ HAL_GPIO_Init() é‡æ–°é…ç½®æ‰€æœ‰å·²å¯ç”¨çš„ pins
```

è¿™æ„å‘³ç€ï¼š

- ä½ åœ¨ **CubeMX é‡Œè®¾ç½®çš„ GPIO æ¨¡å¼**ï¼ˆæ¯”å¦‚ PD8 è¾“å‡ºï¼‰ä¼šåœ¨ BSP å¯åŠ¨æ—¶è¢« `drv_gpio.c` å†é…ç½®ä¸€æ¬¡ï¼ˆæœ‰æ—¶ä¼šè¦†ç›–æˆé»˜è®¤è¾“å…¥æ¨¡å¼ï¼‰ã€‚
- è¿™ç§è¦†ç›–æœ‰ä¸¤ä¸ªç›®çš„ï¼š
  1. è®©æ‰€æœ‰å¼•è„šå’Œ PIN è®¾å¤‡é©±åŠ¨çš„æ˜ å°„ä¸€è‡´ (`GET_PIN` å®ç”¨å¾—ä¸Š)
  2. ç»Ÿä¸€é€šè¿‡ RT-Thread API ç®¡ç† GPIOï¼Œè·¨å¹³å°æ–¹ä¾¿

------

**2. é‚£æˆ‘å°±ä¸èƒ½ç”¨ CubeMX äº†å—ï¼Ÿ**

ä¸æ˜¯ ğŸ˜„ï¼Œä½ å¯ä»¥è¿™ä¹ˆä½¿ç”¨ï¼š

- **ç”¨ CubeMX ç”Ÿæˆå¤–è®¾åˆå§‹åŒ–ä»£ç **ï¼ˆSPIã€I2Cã€UARTã€å®šæ—¶å™¨ç­‰ï¼‰
- **GPIO å¼•è„šåŠŸèƒ½çš„é…ç½®äº¤ç»™ RT-Thread API (`rt_pin_mode`) æ¥åš**
- å¯¹äºéœ€è¦åœ¨ `drv_gpio` åˆå§‹åŒ–é‡Œå°±è®¾ç½®å¥½çš„ç‰¹æ®Š pinsï¼Œå¯ä»¥ç›´æ¥æ”¹ BSP çš„ `board.c` æˆ– `drv_gpio.c`

------

**3. ä»¥åå†™ç¨‹åºçš„æœ€ä½³å®è·µ**

æ–¹æ³• Aï¼ˆå®Œå…¨ RT-Thread é£æ ¼ï¼Œæ¨èï¼‰

- CubeMX ç”¨æ¥é…é™¤ GPIO ä»¥å¤–çš„å¤–è®¾ï¼ˆUART/SPI/I2C...ï¼‰
- GPIO ç”¨ `rt_pin_mode` è®¾ç½®æ¨¡å¼ï¼Œç”¨ `rt_pin_write` æ§åˆ¶
- **å¥½å¤„**ï¼šè·¨å¹³å°ä»£ç ä¸ç”¨æ”¹

```c
#define LED_PIN GET_PIN(D, 8)

int main(void)
{
    rt_pin_mode(LED_PIN, PIN_MODE_OUTPUT);
    while(1)
    {
        rt_pin_write(LED_PIN, PIN_LOW);
        rt_thread_mdelay(500);
        rt_pin_write(LED_PIN, PIN_HIGH);
        rt_thread_mdelay(500);
    }
}
```

------

æ–¹æ³• Bï¼ˆçº¯ HAL é£æ ¼ï¼‰

- ä¸ç”¨ `rt_pin_*` ç³»åˆ— API
- ç”¨ CubeMX é… GPIO + HAL_GPIO_WritePin
- ç¼ºç‚¹ï¼šä»£ç ä¸å¯è·¨ RTOS å¹³å°ï¼Œåªèƒ½ STM32 ç”¨ï¼Œç§»æ¤åˆ°åˆ«çš„èŠ¯ç‰‡è¦æ”¹ã€‚

```c
int main(void)
{
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_8, GPIO_PIN_RESET);
    HAL_Delay(500);
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_8, GPIO_PIN_SET);
    HAL_Delay(500);
}
```

------

æ–¹æ³• Cï¼ˆCubeMX é…å¤§éƒ¨åˆ†ï¼ŒRT-Thread æ¥ç®¡ï¼‰

- CubeMX ç”Ÿæˆçš„ `MX_GPIO_Init()` å…ˆè®¾ç½®ä¸€äº›æ¨¡å¼
- åœ¨ RT-Thread é‡Œè°ƒç”¨ `rt_pin_mode` è¦†ç›–ä¸ªåˆ«ç‰¹æ®Šå¼•è„š
- **åœºæ™¯**ï¼šæœ‰äº› GPIO è¦åœ¨å¾ˆæ—©ï¼ˆBSP åˆå§‹åŒ–å‰ï¼‰å°±ç”¨ï¼Œå…¶ä»–çš„ç”¨ RT-Thread ç®¡ç†

------

**4. æˆ‘çš„å»ºè®®**

å¦‚æœä½ ä»¥ååœ¨ RT-Thread é‡Œå†™ç¨‹åºï¼Œè€Œä¸”æƒ³è¦**ä»£ç å¯ç§»æ¤æ€§å¼º**ã€BSP å’Œåº”ç”¨è§£è€¦ï¼Œé‚£ä¹ˆï¼š

- **CubeMXï¼š** ä¸»è¦ç”¨å®ƒç”»æ—¶é’Ÿæ ‘ã€å¤–è®¾å¼•è„šå¤ç”¨ã€DMA é…ç½®
- **GPIOï¼š** ç»Ÿä¸€äº¤ç»™ RT-Thread çš„ pin é©±åŠ¨ç®¡ç†ï¼ˆ`rt_pin_mode` + `rt_pin_write`ï¼‰
- å¦‚æœä¸€å®šè¦ç›´æ¥ç”¨ HAL æ§åˆ¶æŸä¸ªå¼•è„šï¼Œé‚£å°±ä¸è¦å¯¹å®ƒè°ƒç”¨ `rt_pin_*`ï¼Œä¿æŒå•ä¸€å®ç°è·¯å¾„

------

âœ… è¿™æ ·åšçš„å¥½å¤„ï¼š

1. è·¨å¹³å°ï¼šæ¯”å¦‚ä» STM32 æ¢åˆ° NXP Kinetisï¼Œåªè¦æ¢ BSPï¼Œä¸ç”¨æ”¹ä¸šåŠ¡ä»£ç 
2. ä¸ä¼šå‘ç”Ÿ CubeMX é…è¿‡ï¼Œä½† RT-Thread èµ·ä¸æ¥çš„æƒ…å†µ
3. å¼•è„šå’Œ `GET_PIN()` æ˜ å°„æ¸…æ™°ï¼Œæ–¹ä¾¿ç»´æŠ¤





## RT-Threadç¬¬ä¸‰ä¸ªç¨‹åº --- åˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹

1.ä»£ç 

```
#include <rtthread.h>

#define THREAD_PRIORITY 25
#define THREAD_STACK_SIZE 1024
#define THREAD_TIMESLICE 5

static rt_thread_t tid1 = RT_NULL;
static rt_thread_t tid2 = RT_NULL;
/* çº¿ç¨‹ 1 å…¥å£ */
static void thread1_entry(void* parameter)
{
		int count = 0;
		while (count < 10)
	{
		rt_kprintf("Thread 1 is running, count: %d\n", count);
		count ++;
		rt_thread_mdelay(1000); // æ¯ç§’æ‰“å°ä¸€æ¬¡
	}
}

/* çº¿ç¨‹ 2 å…¥å£ */
static void thread2_entry(void* parameter)
{
		int count = 0;
		while (count < 10)
	{
		rt_kprintf("Thread 2 is running, count: %d\n", count);
		count ++;
		rt_thread_mdelay(1000); // æ¯ç§’æ‰“å°ä¸€æ¬¡
	}
}

int main(void)
{
/* åˆ›å»ºçº¿ç¨‹ 1 */
		tid1 = rt_thread_create("thread1",
				thread1_entry, RT_NULL,
				THREAD_STACK_SIZE, THREAD_PRIORITY,
				THREAD_TIMESLICE);
/* åˆ›å»ºçº¿ç¨‹ 2 */
		tid2 = rt_thread_create("thread2",
		thread2_entry, RT_NULL,
		THREAD_STACK_SIZE, THREAD_PRIORITY,
		THREAD_TIMESLICE);
/* å¯åŠ¨çº¿ç¨‹ */
if (tid1 = RT_NULL) rt_thread_startup(tid1);
if (tid2 = RT_NULL) rt_thread_startup(tid2);
return 0;
}

```

æ€»ç»“ï¼š

å¥½çš„ ğŸ‘
 æˆ‘å¸®ä½ å°†è¿™ä¸ª**ç¬¬ä¸‰ä¸ªçº¿ç¨‹å®éªŒï¼šåˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹**çš„å†…å®¹æ•´ç†æˆä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„ **Markdown å­¦ä¹ ç¬”è®°**ï¼Œä½ ä»¥åå¯ä»¥ç›´æ¥æ”¾åˆ°æ–‡æ¡£é‡Œç•™ä½œ RT-Thread å­¦ä¹ è®°å½•ã€‚

å®éªŒä¸‰ï¼šåˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹

1. å®éªŒç›®çš„

- å­¦ä¹ ä½¿ç”¨ `rt_thread_create()` åˆ›å»ºå¤šä¸ªçº¿ç¨‹
- æŒæ¡çº¿ç¨‹çš„å¯åŠ¨ `rt_thread_startup()` æ–¹æ³•
- è§‚å¯Ÿ RT-Thread åœ¨ç›¸åŒä¼˜å…ˆçº§æ—¶çš„æ—¶é—´ç‰‡è½®è¯¢è°ƒåº¦æ•ˆæœ

------

2. å®éªŒä»£ç 

```c
#include <rtthread.h>

#define THREAD_PRIORITY 25      // çº¿ç¨‹ä¼˜å…ˆçº§
#define THREAD_STACK_SIZE 1024  // æ ˆå¤§å°
#define THREAD_TIMESLICE 5      // æ—¶é—´ç‰‡å¤§å°

static rt_thread_t tid1 = RT_NULL;
static rt_thread_t tid2 = RT_NULL;

/* çº¿ç¨‹ 1 å…¥å£ */
static void thread1_entry(void* parameter)
{
    int count = 0;
    while (count < 10)
    {
        rt_kprintf("Thread 1 is running, count: %d\n", count);
        count++;
        rt_thread_mdelay(1000); // ä¼‘çœ  1 ç§’
    }
}

/* çº¿ç¨‹ 2 å…¥å£ */
static void thread2_entry(void* parameter)
{
    int count = 0;
    while (count < 10)
    {
        rt_kprintf("Thread 2 is running, count: %d\n", count);
        count++;
        rt_thread_mdelay(1000); // ä¼‘çœ  1 ç§’
    }
}

int main(void)
{
    /* åˆ›å»ºçº¿ç¨‹ 1 */
    tid1 = rt_thread_create("thread1",
                            thread1_entry, RT_NULL,
                            THREAD_STACK_SIZE, THREAD_PRIORITY,
                            THREAD_TIMESLICE);

    /* åˆ›å»ºçº¿ç¨‹ 2 */
    tid2 = rt_thread_create("thread2",
                            thread2_entry, RT_NULL,
                            THREAD_STACK_SIZE, THREAD_PRIORITY,
                            THREAD_TIMESLICE);

    /* å¯åŠ¨çº¿ç¨‹ */
    if (tid1 != RT_NULL) rt_thread_startup(tid1);
    if (tid2 != RT_NULL) rt_thread_startup(tid2);

    return 0;
}
```

------

3. å…³é”® API ä»‹ç»

| å‡½æ•°                                                         | ä½œç”¨                                     |
| ------------------------------------------------------------ | ---------------------------------------- |
| `rt_thread_create(name, entry, parameter, stack_size, priority, timeslice)` | åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œè¿”å›çº¿ç¨‹å¥æŸ„           |
| `rt_thread_startup(thread)`                                  | å¯åŠ¨æŒ‡å®šçº¿ç¨‹ï¼Œçº¿ç¨‹ä¼šè¿›å…¥å°±ç»ªæ€           |
| `rt_thread_mdelay(ms)`                                       | ä½¿å½“å‰çº¿ç¨‹å»¶æ—¶æŒ‡å®šæ¯«ç§’æ•°ï¼Œå¹¶ä¸»åŠ¨è®©å‡º CPU |
| `rt_kprintf(fmt, ...)`                                       | RT-Thread ä¸‹çš„è°ƒè¯•è¾“å‡ºå‡½æ•°               |

**å‚æ•°è¯´æ˜**

- `name`ï¼šçº¿ç¨‹åå­—ï¼ˆè°ƒè¯•æ—¶å¯è§ï¼‰
- `entry`ï¼šçº¿ç¨‹å…¥å£å‡½æ•°ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰
- `parameter`ï¼šä¼ å…¥çº¿ç¨‹çš„å‚æ•°ï¼ˆæœ¬ä¾‹ä¸­ä¸ºç©ºï¼‰
- `stack_size`ï¼šçº¿ç¨‹æ ˆå¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰
- `priority`ï¼šä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- `timeslice`ï¼šæ—¶é—´ç‰‡å¤§å°ï¼ˆå•ä½ï¼štickï¼‰

------

4. ä»£ç é€»è¾‘

1. åœ¨ `main()` ä¸­åˆ†åˆ«ç”¨ `rt_thread_create()` åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼š
   - `thread1`ï¼šæ‰“å° **Thread 1 is running**
   - `thread2`ï¼šæ‰“å° **Thread 2 is running**
2. è®¾ç½®ç›¸åŒçš„ä¼˜å…ˆçº§ï¼ˆ25ï¼‰å’Œæ—¶é—´ç‰‡ï¼ˆ5 ticksï¼‰
3. å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹åï¼ŒRT-Thread ä¼šè°ƒåº¦å®ƒä»¬æŒ‰ç…§æ—¶é—´ç‰‡è½®æµè¿è¡Œ
4. æ¯ä¸ªçº¿ç¨‹è®¡æ•°åˆ° 10 æ¬¡åé€€å‡º

------

5. æ³¨æ„äº‹é¡¹

- **å¯åŠ¨é¡ºåº bug**ï¼šåŸä»£ç é‡Œ `if (tid1 != RT_NULL) rt_thread_startup(tid2);` å’Œ `if (tid2 != RT_NULL) rt_thread_startup(tid1);` å¯åŠ¨çš„æ˜¯åçš„ï¼Œåº”æ”¹æˆï¼š

  ```c
  if (tid1 != RT_NULL) rt_thread_startup(tid1);
  if (tid2 != RT_NULL) rt_thread_startup(tid2);
  ```

- å¦‚æœä¸¤ä¸ªçº¿ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œè°ƒåº¦æ–¹å¼ä¸º**æ—¶é—´ç‰‡è½®è½¬**ï¼›
   å¦‚æœä¼˜å…ˆçº§ä¸åŒï¼Œä¼˜å…ˆè¿è¡Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ï¼Œä½ä¼˜å…ˆçº§çº¿ç¨‹ä¼šè¢«æŠ¢å ã€‚

- å¦‚æœè¦è®©çº¿ç¨‹åå¤è¿è¡Œï¼Œä¸è¦é™åˆ¶ `count < 10`ï¼Œç›´æ¥ç”¨ `while (1)` å®ç°å¾ªç¯ã€‚

------

6. å®éªŒç°è±¡

- ä¸²å£æ‰“å°è¾“å‡ºç±»ä¼¼ï¼š

```
Thread 1 is running, count: 0
Thread 2 is running, count: 0
Thread 1 is running, count: 1
Thread 2 is running, count: 1
...
```

- ä¸¤ä¸ªçº¿ç¨‹ä¼šäº¤æ›¿è¾“å‡ºï¼Œé—´éš”å¤§çº¦ 1 ç§’ã€‚

------

7. æœ¬ä¾‹å­¦ä¹ è¦ç‚¹

- å­¦ä¼šåœ¨ RT-Thread ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹
- ç†è§£ä¼˜å…ˆçº§ä¸æ—¶é—´ç‰‡çš„å…³ç³»
- å­¦ä¼šä½¿ç”¨ `rt_thread_mdelay()` è¿›è¡Œå»¶æ—¶ä¸è®©å‡º CPU
- æŒæ¡çº¿ç¨‹å¯åŠ¨ `rt_thread_startup()` çš„æ­£ç¡®ç”¨æ³•

------

âœ… **å»ºè®®ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼š
 ç”¨ä¸åŒä¼˜å…ˆçº§æµ‹è¯• **æŠ¢å å¼è°ƒåº¦**ï¼Œæ¯”å¦‚æŠŠ Thread 1 çš„ä¼˜å…ˆçº§è°ƒæˆ 20ï¼ˆé«˜ï¼‰ï¼ŒThread 2 ä¿æŒ 25ï¼Œè§‚å¯Ÿ Thread 1 æ˜¯å¦ä¼šè¿ç»­è¿è¡Œç›´åˆ°é˜»å¡ã€‚

## 



## RT-Thread--çº¿ç¨‹åŒæ­¥

1.RT-Threadè·å–æ—¶é’Ÿçš„å‡½æ•°ï¼Œ`rt_tick_get`

å…¶ä¸­rt_tickç±»ä¼¼äºstm32é‡Œé¢çš„`uwTick`,è€Œ`rt_tick_get`ç±»ä¼¼äº `HAL_GetTick`

![image-20250916165255851](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916165255851.png)

2.æˆ‘ä»¬åœ¨RTä¸­å¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨å®šæ—¶å™¨

RT-Threadæä¾›äº†åˆ›å»ºäº†å®šæ—¶å™¨çš„å‡½æ•°--`rt_timer_create`

å¥½çš„ï¼Œä½ è´´çš„è¿™ä¸ªå‡½æ•°æ˜¯ RT-Thread é‡Œâ€œè½¯ä»¶å®šæ—¶å™¨â€åˆ›å»ºæ¥å£ä¹‹ä¸€ã€‚
 æˆ‘ç»™ä½ åˆ†ä¸¤éƒ¨åˆ†è®²ï¼š**â‘ `rt_timer_create()` å‡½æ•°çš„ä½œç”¨å’Œå‚æ•°**ï¼Œ**â‘¡`rt_timer_t` è¿™ä¸ªç»“æ„ä½“æ˜¯ä»€ä¹ˆ**ã€‚

------

â‘  `rt_timer_create()` ä»‹ç»

å‡½æ•°åŸå‹ï¼š

```c
rt_timer_t rt_timer_create(const char* name,
                           void (*timeout)(void* parameter),
                           void* parameter,
                           rt_tick_t time,
                           rt_uint8_t flag);
```

åŠŸèƒ½

- ç”¨äº **åŠ¨æ€åˆ›å»ºä¸€ä¸ªè½¯ä»¶å®šæ—¶å™¨**ï¼ˆRT-Thread çš„è½¯ä»¶å®šæ—¶å™¨æ˜¯åŸºäºç³»ç»Ÿ tick æ¥å·¥ä½œçš„ï¼‰ã€‚
- åˆ›å»ºæˆåŠŸåï¼Œè¿”å›ä¸€ä¸ª `rt_timer_t` ç±»å‹ï¼ˆæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª `struct rt_timer` ç»“æ„ï¼‰çš„å¥æŸ„ã€‚
- ä½ å¯ä»¥ç”¨è¿™ä¸ªå®šæ—¶å™¨æ¥å®šæ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè€Œä¸éœ€è¦è‡ªå·±ç®¡ç†åº•å±‚ SysTickã€‚

------

å‚æ•°è§£é‡Š

1. **`const char\* name`**
   - å®šæ—¶å™¨çš„åå­—ï¼ˆæ–¹ä¾¿åœ¨è°ƒè¯•æˆ–ç³»ç»Ÿåˆ—è¡¨ä¸­æ ‡è¯†ï¼‰ã€‚
   - ä¾‹å¦‚ `"led_timer"`ã€‚
2. **`void (\*timeout)(void\* parameter)`**
   - å®šæ—¶å™¨è¶…æ—¶å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚
   - å½“å®šæ—¶å™¨åˆ°æœŸæ—¶ï¼ŒRT-Thread å†…æ ¸ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚
3. **`void\* parameter`**
   - ä¼ ç»™ `timeout` å›è°ƒçš„å‚æ•°æŒ‡é’ˆã€‚
   - å…è®¸ä½ åœ¨å›è°ƒé‡Œä½¿ç”¨ä¸Šä¸‹æ–‡æ•°æ®ã€‚
4. **`rt_tick_t time`**
   - å®šæ—¶å™¨è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ **ç³»ç»Ÿ tick**ï¼ˆå–å†³äº `RT_TICK_PER_SECOND` é…ç½®ï¼‰ã€‚
   - å¦‚æœ `RT_TICK_PER_SECOND=1000`ï¼Œé‚£ä¹ˆ `time=100` è¡¨ç¤º 100msã€‚
5. **`rt_uint8_t flag`**
   - å®šæ—¶å™¨æ¨¡å¼æ ‡å¿—ï¼Œå¸¸ç”¨å–å€¼ï¼š
     - `RT_TIMER_FLAG_ONE_SHOT`ï¼šå•æ¬¡å®šæ—¶å™¨ï¼Œåˆ°æœŸåè‡ªåŠ¨åœæ­¢ã€‚
     - `RT_TIMER_FLAG_PERIODIC`ï¼šå‘¨æœŸå®šæ—¶å™¨ï¼Œåˆ°æœŸåè‡ªåŠ¨é‡æ–°è®¡æ—¶ã€‚
     - è¿˜å¯ä»¥å’Œ `RT_TIMER_FLAG_SOFT_TIMER`ï¼ˆä½¿ç”¨è½¯å®šæ—¶å™¨çº¿ç¨‹å¤„ç†ï¼‰æˆ– `RT_TIMER_FLAG_HARD_TIMER`ï¼ˆç”±ä¸­æ–­ç›´æ¥å¤„ç†ï¼‰ç»„åˆã€‚

------

è¿”å›å€¼

- æˆåŠŸï¼šè¿”å› `rt_timer_t` ç±»å‹ï¼ˆ`struct rt_timer*`ï¼‰çš„æŒ‡é’ˆã€‚
- å¤±è´¥ï¼šè¿”å› `RT_NULL`ã€‚

------

â‘¡ `rt_timer_t` æ˜¯ä»€ä¹ˆï¼Ÿ

`rt_timer_t` åœ¨ RT-Thread çš„å¤´æ–‡ä»¶ `rtdef.h` ä¸­å®šä¹‰ï¼š

```c
typedef struct rt_timer* rt_timer_t;
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

- **`rt_timer_t` æ˜¯ä¸€ä¸ªæŒ‡å‘ `struct rt_timer` ç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹**ã€‚

------

`struct rt_timer` é•¿è¿™æ ·ï¼ˆç®€åŒ–ç‰ˆï¼‰

RT-Thread æºç ï¼ˆ`rtdef.h`ï¼‰é‡Œç±»ä¼¼å¦‚ä¸‹ï¼š

```c
struct rt_timer
{
    struct rt_object parent;  // å†…æ ¸å¯¹è±¡å¤´ï¼ŒåŒ…å«å¯¹è±¡åã€ç±»å‹ç­‰ä¿¡æ¯
    rt_list_t row[RT_TIMER_SKIP_LIST_LEVEL]; // å®šæ—¶å™¨é“¾è¡¨ï¼ˆè·³è¡¨ç»“æ„ï¼‰
    void (*timeout_func)(void *parameter);   // è¶…æ—¶å›è°ƒå‡½æ•°
    void *parameter;                         // å›è°ƒå‚æ•°
    rt_tick_t init_tick;                     // åˆå§‹å®šæ—¶æ—¶é—´ï¼ˆtickï¼‰
    rt_tick_t timeout_tick;                  // åˆ°æœŸçš„ç³»ç»Ÿ tick å€¼
    rt_uint8_t flag;                         // å®šæ—¶å™¨æ¨¡å¼å’ŒçŠ¶æ€æ ‡å¿—
};
```

------

å­—æ®µè§£é‡Š

1. **`parent`**
   - å†…æ ¸å¯¹è±¡åŸºç±»ï¼ŒåŒ…å«åå­—ã€ç±»å‹ã€å†…æ ¸ç®¡ç†ç”¨çš„ä¿¡æ¯ã€‚
2. **`timeout_func`**
   - å®šæ—¶å™¨åˆ°æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚
3. **`parameter`**
   - å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚
4. **`init_tick`**
   - åˆ›å»ºå®šæ—¶å™¨æ—¶è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼ˆtickï¼‰ã€‚
5. **`timeout_tick`**
   - å®šæ—¶å™¨ä¸‹ä¸€æ¬¡åˆ°æœŸçš„ç»å¯¹æ—¶é—´ï¼ˆç›¸å¯¹äº `rt_tick_get()`ï¼‰ã€‚
6. **`flag`**
   - æ ‡å¿—ä½ï¼ˆå‘¨æœŸ / å•æ¬¡ / è½¯ç¡¬å®šæ—¶å™¨æ¨¡å¼ï¼‰ã€‚
7. **`row`**
   - RT-Thread ä½¿ç”¨â€œè·³è¡¨â€ç»“æ„ç»´æŠ¤å¤šä¸ªå®šæ—¶å™¨é“¾è¡¨ã€‚

------

â‘¢ å’Œ STM32 HAL çš„å¯¹æ¯”

å¦‚æœç”¨è¿‡ STM32 HALï¼Œå¯ä»¥è¿™ä¹ˆç±»æ¯”ï¼š

| RT-Thread è½¯ä»¶å®šæ—¶å™¨               | STM32 HAL æ¦‚å¿µ                                       |
| ---------------------------------- | ---------------------------------------------------- |
| `rt_timer_t` + `rt_timer_create`   | `TIM_HandleTypeDef` + `HAL_TIM_Base_Start_IT`        |
| `timeout_func`                     | HAL å®šæ—¶å™¨ä¸­æ–­å›è°ƒ `HAL_TIM_PeriodElapsedCallback()` |
| `flag`ï¼ˆå‘¨æœŸ / å•æ¬¡ï¼‰              | å®šæ—¶å™¨å•æ¬¡æ¨¡å¼ / è‡ªåŠ¨é‡è£…æ¨¡å¼                        |
| tick å•ä½åŸºäº `RT_TICK_PER_SECOND` | åŸºäºå®šæ—¶å™¨æº¢å‡ºè®¡æ•°                                   |

------

âœ… æ€»ç»“ï¼š

- `rt_timer_t` æ˜¯ä¸€ä¸ªâ€œæŒ‡å‘è½¯ä»¶å®šæ—¶å™¨ç»“æ„ä½“çš„æŒ‡é’ˆâ€ã€‚
- `rt_timer_create()` ç”¨äºåŠ¨æ€åˆ›å»ºä¸€ä¸ªè½¯å®šæ—¶å™¨ï¼Œå¯ä»¥å•æ¬¡ä¹Ÿå¯ä»¥å‘¨æœŸè¿è¡Œï¼Œåˆ°æœŸè‡ªåŠ¨æ‰§è¡Œå›è°ƒã€‚
- RT-Thread çš„å®šæ—¶å™¨ä¸æ˜¯ç›´æ¥ç”¨ç¡¬ä»¶ TIMï¼Œè€Œæ˜¯åŸºäºç³»ç»Ÿ tick å’Œè°ƒåº¦ç®—æ³•ï¼ˆè½¯å®šæ—¶å™¨å¯ä»¥é¿å¼€ä¸­æ–­ç›´æ¥åœ¨ä»»åŠ¡ä¸Šä¸‹æ–‡è¿è¡Œï¼‰ã€‚

------



### RT-thread ç¬¬å››ä¸ªç¨‹åº--åˆ›å»ºå®šæ—¶å™¨

1.ä»£ç 

```
#include <rtthread.h>

static rt_timer_t timer1; // å®šä¹‰å®šæ—¶å™¨ 1
static rt_timer_t timer2; // å®šä¹‰å®šæ—¶å™¨ 2

		/* å®šæ—¶å™¨ 1 çš„è¶…æ—¶å›è°ƒå‡½æ•° */
static void timeout1(void *parameter)
{
	rt_kprintf("Periodic timer timeout\n");
}

		/* å®šæ—¶å™¨ 2 çš„è¶…æ—¶å›è°ƒå‡½æ•° */
static void timeout2(void *parameter)
{
	rt_kprintf("One-shot timer timeout\n");
}

int main (void)
{
		/* åˆ›å»ºå‘¨æœŸæ€§å®šæ—¶å™¨ */
	timer1 = rt_timer_create("timer1", timeout1,
							RT_NULL, 10,
							RT_TIMER_FLAG_PERIODIC);
		/* å¯åŠ¨å®šæ—¶å™¨ 1 */
	if (timer1 != RT_NULL) rt_timer_start(timer1);

		/* åˆ›å»ºå•æ¬¡å®šæ—¶å™¨ */
	timer2 = rt_timer_create("timer2", timeout2,
							RT_NULL, 30,
							RT_TIMER_FLAG_ONE_SHOT);
		/* å¯åŠ¨å®šæ—¶å™¨ 2 */
	if (timer2 != RT_NULL) rt_timer_start(timer2);
return 0;
}

```

2.å‘¨æœŸå®šæ—¶å™¨æ¯10ä¸ªos tickæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œå•æ¬¡å®šæ—¶å™¨åªåœ¨ç¬¬30ä¸ªos tickæ‰§è¡Œä¸€æ¬¡

![image-20250916173439850](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916173439850.png)

3.è‹¥æ˜¯åœ¨`timeout2`ä¸­æ‰‹åŠ¨æ‰“å¼€`rt_timer_start(timer2);`åˆ™å˜æˆä¼ªå‘¨æœŸå®šæ—¶å™¨

![image-20250916173914654](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916173914654.png)

![image-20250916173933365](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916173933365.png)

åŒºåˆ«ï¼š

 å¦‚æœä½ åœ¨ **å•æ¬¡å®šæ—¶å™¨** çš„å›è°ƒå‡½æ•°é‡Œå†è°ƒç”¨ `rt_timer_start(timer2);`ï¼Œå®ƒçš„è¡Œä¸ºæ˜¯ **â€œä¼ªå‘¨æœŸå®šæ—¶å™¨â€**ï¼Œè€Œä¸æ˜¯ RT-Thread å†…æ ¸æä¾›çš„çœŸæ­£ **å‘¨æœŸå®šæ—¶å™¨**ã€‚

------

åŒºåˆ«è§£é‡Šï¼š

âœ… å‘¨æœŸå®šæ—¶å™¨ï¼ˆ`RT_TIMER_FLAG_PERIODIC`ï¼‰

- å†…æ ¸è‡ªåŠ¨åœ¨æ¯æ¬¡è¶…æ—¶åé‡æ–°è£…è½½è®¡æ•°å€¼ã€‚
- ç²¾åº¦æ›´é«˜ï¼šä¸ä¼šå› ä¸ºä½ åœ¨å›è°ƒé‡Œå¤„ç†é€»è¾‘çš„è€—æ—¶è€Œå¯¼è‡´ä¸‹ä¸€æ¬¡è¶…æ—¶è¢«å»¶è¿Ÿã€‚
- è°ƒåº¦æ•ˆç‡æ›´é«˜ï¼šç³»ç»Ÿç›´æ¥æŒ‰ç…§ tick é“¾è¡¨è°ƒåº¦ã€‚

âš ï¸ å•æ¬¡å®šæ—¶å™¨ + å›è°ƒé‡Œ `rt_timer_start`

- æ¯æ¬¡è¶…æ—¶åï¼Œä½ æ‰‹åŠ¨è°ƒç”¨ `rt_timer_start` æ¥â€œé‡å¯â€ã€‚
- å¦‚æœå›è°ƒå‡½æ•°é‡Œæœ‰è€—æ—¶æ“ä½œï¼ˆæ¯”å¦‚ `rt_kprintf` æˆ–å…¶ä»–å¤æ‚é€»è¾‘ï¼‰ï¼Œå®šæ—¶å™¨çš„ä¸‹ä¸€ä¸ªå¯åŠ¨ç‚¹å°±ä¼šå¾€ååç§»ï¼Œå‘¨æœŸä¼š **æ¯”é¢„æœŸæ›´é•¿**ã€‚
- ç²¾åº¦ä¸å¦‚ç³»ç»Ÿçš„ **çœŸæ­£å‘¨æœŸå®šæ—¶å™¨**ã€‚

------

ä¸¾ä¸ªä¾‹å­ï¼ˆå‡è®¾ tick = 1msï¼Œå®šæ—¶å™¨è¶…æ—¶æ—¶é—´ 10msï¼‰ï¼š

- **å‘¨æœŸå®šæ—¶å™¨**ï¼š
   ç†è®ºè§¦å‘æ—¶é—´ï¼š10ms, 20ms, 30ms, 40ms â€¦
   å³ä½¿å›è°ƒè€—æ—¶ 2msï¼Œä¸‹æ¬¡è§¦å‘ä¹Ÿä¼šåœ¨ 20msï¼Œä¸ä¼šå—å½±å“ã€‚
- **å•æ¬¡å®šæ—¶å™¨ + `rt_timer_start`**ï¼š
   è§¦å‘æ—¶é—´ï¼š10ms (å›è°ƒè€—æ—¶ 2ms)ï¼Œç„¶åä½  `rt_timer_start`ï¼Œä¸‹æ¬¡è§¦å‘ç‚¹å˜æˆ 12ms + 10ms = 22msã€‚
   ä¹‹åï¼š22ms, 34ms, 46ms â€¦ å‘¨æœŸè¢« **ç´¯ç§¯å»¶è¿Ÿ**ã€‚

------

ç»“è®º

- **å¦‚æœä½ éœ€è¦ç¨³å®šå‘¨æœŸ** â†’ ç”¨ **å‘¨æœŸå®šæ—¶å™¨**ã€‚
- **å¦‚æœä½ éœ€è¦æ ¹æ®è¿è¡Œæƒ…å†µçµæ´»å†³å®šæ˜¯å¦å†å¯åŠ¨** â†’ å¯ä»¥ç”¨å•æ¬¡å®šæ—¶å™¨ + `rt_timer_start`ï¼Œä½†è¿™æ˜¯ä¼ªå‘¨æœŸï¼Œç²¾åº¦ä¾èµ–äºå›è°ƒæ‰§è¡Œæ—¶é—´ã€‚

### 

### çº¿ç¨‹é—´åŒæ­¥---ä¿¡å·é‡

1.ä»£ç 

```
#include <rtthread.h>

	/* åˆ›å»ºä¿¡å·é‡ */
rt_sem_t sem = RT_NULL;

	/* çº¿ç¨‹1ï¼šç­‰å¾…è¿›å…¥ç”µå½±é™¢ */
void thread_entry1(void *parameter)
{
	rt_kprintf("çº¿ç¨‹1: ç­‰å¾…è¿›å…¥ç”µå½±é™¢ .\n");
	rt_sem_take(sem, RT_WAITING_FOREVER); // å°è¯•è·å–ä¿¡å·é‡
	rt_kprintf("çº¿ç¨‹1: è¿›å…¥ç”µå½±é™¢ï¼\n");
}
/* çº¿ç¨‹2ï¼šç¦»å¼€ç”µå½±é™¢ï¼Œé‡Šæ”¾ä¿¡å·é‡ */
void thread_entry2(void *parameter)
{
	rt_kprintf("çº¿ç¨‹2: ç¦»å¼€ç”µå½±é™¢ï¼Œé‡Šæ”¾ä¸€ä¸ªåº§ä½\n");
	rt_sem_release(sem); // é‡Šæ”¾ä¿¡å·é‡
}
int main(void)
{
	/* åˆå§‹åŒ–ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1ï¼Œè¡¨ç¤ºç”µå½±é™¢æœ‰1ä¸ªåº§ä½ */
	sem = rt_sem_create("sem", 1, RT_IPC_FLAG_PRIO);

	/* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
	rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 25,
										10);
	rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 25,
										10);
	/* å¯åŠ¨çº¿ç¨‹ */
	rt_thread_startup(tid1);
	rt_thread_startup(tid2);
return 0;
}
```

2.è§£é‡Š`rt_sem_t sem = RT_NULL;`

------

**1. è¯­å¥è§£é‡Š**

```c
rt_sem_t sem = RT_NULL;
```

- **`rt_sem_t`**ï¼šRT-Thread ä¸­å®šä¹‰çš„ **ä¿¡å·é‡æ§åˆ¶å—æŒ‡é’ˆç±»å‹**ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª `struct rt_semaphore*`ã€‚
- **`sem`**ï¼šä¿¡å·é‡å¯¹è±¡å¥æŸ„ï¼Œç”¨æ¥æ“ä½œä¿¡å·é‡ã€‚
- **`RT_NULL`**ï¼šRT-Thread ä¸­å®šä¹‰çš„ç©ºæŒ‡é’ˆï¼ˆç›¸å½“äº `NULL`ï¼‰ï¼Œè¡¨ç¤ºè¿™ä¸ªä¿¡å·é‡è¿˜æ²¡æœ‰è¢«åˆ›å»ºã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸ªç©ºçš„ä¿¡å·é‡å¥æŸ„ï¼Œåç»­éœ€è¦é€šè¿‡ `rt_sem_create()` æˆ– `rt_sem_init()` æ¥çœŸæ­£åˆ›å»ºä¿¡å·é‡ã€‚

------

**2. ä¿¡å·é‡åœ¨ RT-Thread çš„ä½œç”¨**

ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§ **å†…æ ¸åŒæ­¥æœºåˆ¶**ï¼Œå¸¸ç”¨äºï¼š

- **ä»»åŠ¡ä¹‹é—´çš„åŒæ­¥**ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹å®ŒæˆæŸä¸ªåŠ¨ä½œã€‚
- **äº‹ä»¶é€šçŸ¥**ï¼šä¸­æ–­é‡Œå‘ä¿¡å·é‡ï¼Œçº¿ç¨‹ç­‰å¾…ä¿¡å·é‡ã€‚
- **èµ„æºè®¡æ•°**ï¼šç”¨äºæ§åˆ¶æœ‰é™èµ„æºçš„å¹¶å‘è®¿é—®ã€‚

------

**3. å¸¸ç”¨ API**

1. **åˆ›å»º/åˆå§‹åŒ–**

```c
/* åŠ¨æ€åˆ›å»ºä¿¡å·é‡ */
rt_sem_t rt_sem_create(const char* name, rt_uint32_t value, rt_uint8_t flag);

/* é™æ€åˆå§‹åŒ–ä¿¡å·é‡ */
rt_err_t rt_sem_init(rt_sem_t sem, const char* name, rt_uint32_t value, rt_uint8_t flag);
```

- `value`ï¼šåˆå§‹è®¡æ•°å€¼
- `flag`ï¼šè°ƒåº¦æ–¹å¼ï¼ˆå¦‚ `RT_IPC_FLAG_FIFO` æˆ– `RT_IPC_FLAG_PRIO`ï¼‰

------

1. **è·å–ä¿¡å·é‡**

```c
rt_err_t rt_sem_take(rt_sem_t sem, rt_int32_t time);
```

- `time` = ç­‰å¾…æ—¶é—´ï¼ˆtickï¼‰ï¼Œ`RT_WAITING_FOREVER` è¡¨ç¤ºä¸€ç›´ç­‰ã€‚
- å¦‚æœè®¡æ•°å€¼ > 0ï¼Œå°±å‡ 1 å¹¶ç«‹å³è¿”å›æˆåŠŸï¼›å¦åˆ™é˜»å¡ç­‰å¾…ã€‚

------

1. **é‡Šæ”¾ä¿¡å·é‡**

```c
rt_err_t rt_sem_release(rt_sem_t sem);
```

- é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡ï¼Œè®¡æ•°å€¼åŠ  1ï¼Œå¦‚æœæœ‰ç­‰å¾…çš„çº¿ç¨‹å°±å”¤é†’å®ƒã€‚

------

1. **åˆ é™¤ä¿¡å·é‡**

```c
rt_err_t rt_sem_delete(rt_sem_t sem);
```

- é‡Šæ”¾ä¿¡å·é‡èµ„æºï¼ˆç”¨äº `rt_sem_create()` åˆ›å»ºçš„åŠ¨æ€ä¿¡å·é‡ï¼‰ã€‚



3.å‹˜è¯¯

åŸä»£ç æœ‰è¯¯ï¼Œåº”è¯¥ä¸Šæ¥semåˆå§‹å€¼æ˜¯0ï¼Œä»£è¡¨æ²¡åº§ä½ï¼Œå¦‚æœæ˜¯1ï¼Œå³ä½¿çº¿ç¨‹2æ²¡æœ‰é‡Šæ”¾ä¿¡å·é‡ï¼Œçº¿ç¨‹1ä¹Ÿæœ‰åº§ä½

![image-20250916181119734](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916181119734.png)

å¯ä»¥çœ‹åˆ°çº¿ç¨‹1éƒ½å¯ä»¥æ­£å¸¸è¿›å…¥ç”µå½±é™¢

![image-20250916181138055](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916181138055.png)

å¦‚æœæŠŠsemæ”¹ä¸º0ï¼Œå°±æ˜¯åˆšå¼€å§‹æ²¡æœ‰ä½ç½®ï¼Œéœ€è¦çº¿ç¨‹2é‡Šæ”¾ä½ç½®ä»¥åï¼Œçº¿ç¨‹1æ‰èƒ½è¿›å…¥

![image-20250916181258594](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916181258594.png)

![image-20250916181351494](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916181351494.png)



4.æ­£ç¡®ä»£ç åŠç°è±¡

```
#include <rtthread.h>

    /* åˆ›å»ºä¿¡å·é‡ */
rt_sem_t sem = RT_NULL;

    /* çº¿ç¨‹1ï¼šç­‰å¾…è¿›å…¥ç”µå½±é™¢ */
void thread_entry1(void *parameter)
{
    rt_kprintf("çº¿ç¨‹1: ç­‰å¾…è¿›å…¥ç”µå½±é™¢ .\n");
    rt_sem_take(sem, RT_WAITING_FOREVER); // å°è¯•è·å–ä¿¡å·é‡
    rt_kprintf("çº¿ç¨‹1: è¿›å…¥ç”µå½±é™¢ï¼\n");
}

/* çº¿ç¨‹2ï¼šç¦»å¼€ç”µå½±é™¢ï¼Œé‡Šæ”¾ä¿¡å·é‡ */
void thread_entry2(void *parameter)
{
    rt_thread_delay(1000);//ä¼‘çœ ï¼Œçº¿ç¨‹2åœ¨ç”µå½±é™¢ï¼Œè®©çº¿ç¨‹1å…ˆè¡Œç­‰å¾…
    rt_kprintf("çº¿ç¨‹2: ç¦»å¼€ç”µå½±é™¢ï¼Œé‡Šæ”¾ä¸€ä¸ªåº§ä½\n");
    rt_sem_release(sem); // é‡Šæ”¾ä¿¡å·é‡
}

int main(void)
{
    /* åˆå§‹åŒ–ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1ï¼Œè¡¨ç¤ºç”µå½±é™¢æœ‰1ä¸ªåº§ä½ */
    sem = rt_sem_create("sem", 0, RT_IPC_FLAG_PRIO);

    /* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
    rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 25,
                                        10);
    rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 25,
                                        10);
    /* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);
return 0;
}

```

![image-20250916181649013](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916181649013.png)





### ä»»åŠ¡åŒæ­¥ç¤ºä¾‹

1.ä»£ç 

```
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread1_handle = RT_NULL;
static rt_thread_t thread2_handle = RT_NULL;
static rt_sem_t sync_sem = RT_NULL;

/* çº¿ç¨‹1å…¥å£å‡½æ•° */
static void thread1_entry(void *parameter)
{
	rt_kprintf("çº¿ç¨‹1ï¼šç­‰å¾…çº¿ç¨‹2å‘é€ä¿¡å· .\n");
	/* ç­‰å¾…ä¿¡å·é‡ï¼Œè¶…æ—¶æ—¶é—´ä¸ºæ°¸è¿œç­‰å¾… */
	rt_sem_take(sync_sem, RT_WAITING_FOREVER);
	rt_kprintf("çº¿ç¨‹1ï¼šæ”¶åˆ°çº¿ç¨‹2çš„ä¿¡å·ï¼Œç»§ç»­æ‰§è¡Œ .\n");
}

	/* çº¿ç¨‹2å…¥å£å‡½æ•° */
static void thread2_entry(void *parameter)
{
	rt_kprintf("çº¿ç¨‹2ï¼šæ‰§è¡Œä¸€äº›æ“ä½œ .\n");
	/* æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ */
	rt_thread_mdelay(2000);
	rt_kprintf("çº¿ç¨‹2ï¼šæ“ä½œå®Œæˆï¼Œå‘é€ä¿¡å·ç»™çº¿ç¨‹1 .\n");
	/* é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥çº¿ç¨‹1 */
	rt_sem_release(sync_sem);
}

int main(void)
{
		/* åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º0 */
		sync_sem = rt_sem_create("sync_sem", 0, RT_IPC_FLAG_PRIO);
		if (sync_sem = RT_NULL)
	{
		rt_kprintf("ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
		return -1;
}
		/* åˆ›å»ºçº¿ç¨‹1 */
	thread1_handle = rt_thread_create("thread1",
								thread1_entry,
								RT_NULL,
								THREAD_STACK_SIZE,
								THREAD_PRIORITY,
								THREAD_TIMESLICE);

	if (thread1_handle != RT_NULL)	rt_thread_startup(thread1_handle);

		/* åˆ›å»ºçº¿ç¨‹2 */
	thread2_handle = rt_thread_create("thread2",
									thread2_entry,
									RT_NULL,
									THREAD_STACK_SIZE,
									THREAD_PRIORITY,
									THREAD_TIMESLICE);
									
	if (thread2_handle != RT_NULL)	rt_thread_startup(thread2_handle);

return 0;
}
```

2.ç°è±¡

![image-20250916183721324](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916183721324.png)

3.æ€»ç»“

------

RT-Thread ä¿¡å·é‡çº¿ç¨‹åŒæ­¥ç¤ºä¾‹

åŠŸèƒ½è¯´æ˜

æœ¬ç¤ºä¾‹æ¼”ç¤ºäº† **ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡ä¿¡å·é‡å®ç°åŒæ­¥** çš„è¿‡ç¨‹ï¼š

- **çº¿ç¨‹1**ï¼šå¯åŠ¨åç­‰å¾…ä¿¡å·é‡ï¼Œé˜»å¡æ‰§è¡Œã€‚
- **çº¿ç¨‹2**ï¼šæ‰§è¡Œä¸€äº›æ“ä½œåï¼Œé‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥çº¿ç¨‹1ç»§ç»­æ‰§è¡Œã€‚

ç¤ºä¾‹ä»£ç 

```c
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread1_handle = RT_NULL;
static rt_thread_t thread2_handle = RT_NULL;
static rt_sem_t sync_sem = RT_NULL;

/* çº¿ç¨‹1å…¥å£å‡½æ•° */
static void thread1_entry(void *parameter)
{
    rt_kprintf("çº¿ç¨‹1ï¼šç­‰å¾…çº¿ç¨‹2å‘é€ä¿¡å· .\n");
    /* ç­‰å¾…ä¿¡å·é‡ï¼Œè¶…æ—¶æ—¶é—´ä¸ºæ°¸è¿œç­‰å¾… */
    rt_sem_take(sync_sem, RT_WAITING_FOREVER);
    rt_kprintf("çº¿ç¨‹1ï¼šæ”¶åˆ°çº¿ç¨‹2çš„ä¿¡å·ï¼Œç»§ç»­æ‰§è¡Œ .\n");
}

/* çº¿ç¨‹2å…¥å£å‡½æ•° */
static void thread2_entry(void *parameter)
{
    rt_kprintf("çº¿ç¨‹2ï¼šæ‰§è¡Œä¸€äº›æ“ä½œ .\n");
    /* æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ */
    rt_thread_mdelay(2000);
    rt_kprintf("çº¿ç¨‹2ï¼šæ“ä½œå®Œæˆï¼Œå‘é€ä¿¡å·ç»™çº¿ç¨‹1 .\n");
    /* é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥çº¿ç¨‹1 */
    rt_sem_release(sync_sem);
}

int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º0 */
    sync_sem = rt_sem_create("sync_sem", 0, RT_IPC_FLAG_PRIO);
    if (sync_sem == RT_NULL)
    {
        rt_kprintf("ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
        return -1;
    }

    /* åˆ›å»ºçº¿ç¨‹1 */
    thread1_handle = rt_thread_create("thread1",
                                      thread1_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);

    if (thread1_handle != RT_NULL)
        rt_thread_startup(thread1_handle);

    /* åˆ›å»ºçº¿ç¨‹2 */
    thread2_handle = rt_thread_create("thread2",
                                      thread2_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);

    if (thread2_handle != RT_NULL)
        rt_thread_startup(thread2_handle);

    return 0;
}
```

è¿è¡Œæ•ˆæœ

ç³»ç»Ÿå¯åŠ¨åï¼Œè¾“å‡ºå¦‚ä¸‹æ—¥å¿—ï¼š

```
\ | /
- RT -     Thread Operating System
 / | \     4.1.1 build Sep 16 2025 17:30:15
2006 - 2022 Copyright by RT-Thread team
çº¿ç¨‹2ï¼šæ‰§è¡Œä¸€äº›æ“ä½œ .
çº¿ç¨‹1ï¼šç­‰å¾…çº¿ç¨‹2å‘é€ä¿¡å· .
msh >
çº¿ç¨‹2ï¼šæ“ä½œå®Œæˆï¼Œå‘é€ä¿¡å·ç»™çº¿ç¨‹1 .
çº¿ç¨‹1ï¼šæ”¶åˆ°çº¿ç¨‹2çš„ä¿¡å·ï¼Œç»§ç»­æ‰§è¡Œ .
```

æ€»ç»“

- ä¿¡å·é‡åˆå§‹å€¼ä¸º 0ï¼Œç¡®ä¿çº¿ç¨‹1 ä¼šé˜»å¡ç­‰å¾…ã€‚
- çº¿ç¨‹2 å®Œæˆä»»åŠ¡åé‡Šæ”¾ä¿¡å·é‡ï¼Œçº¿ç¨‹1 éšå³è¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œã€‚
- æœ¬ç¤ºä¾‹å¾ˆå¥½åœ°å±•ç¤ºäº† **ä¿¡å·é‡ç”¨äºçº¿ç¨‹é—´åŒæ­¥** çš„æœºåˆ¶ã€‚



### ä»»åŠ¡äº’æ–¥ç¤ºä¾‹

1.ä»£ç 

```
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread1_handle = RT_NULL;
static rt_thread_t thread2_handle = RT_NULL;
static rt_sem_t mutex_sem = RT_NULL;

/* æ¨¡æ‹Ÿå…±äº«èµ„æº */
static int shared_resource = 0;

/* çº¿ç¨‹1å…¥å£å‡½æ•° */
static void thread1_entry(void *parameter)
{
		while (1)
	{
		/* è·å–äº’æ–¥ä¿¡å·é‡ */
		rt_sem_take(mutex_sem, RT_WAITING_FOREVER);
		rt_kprintf("çº¿ç¨‹1ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º %d\n", shared_resource);
		shared_resource ++;
		rt_kprintf("çº¿ç¨‹1ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º %d\n", shared_resource);
		/* æ¨¡æ‹Ÿèµ„æºå¤„ç†è€—æ—¶ */
		rt_thread_mdelay(1000);
		
		/* é‡Šæ”¾äº’æ–¥ä¿¡å·é‡ */
		rt_sem_release(mutex_sem);
		/* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
		rt_thread_mdelay(500);
	}
}

/* çº¿ç¨‹2å…¥å£å‡½æ•° */
static void thread2_entry(void *parameter)
{
		while (1)
	{
		/* è·å–äº’æ–¥ä¿¡å·é‡ */
		rt_sem_take(mutex_sem, RT_WAITING_FOREVER);
		rt_kprintf("çº¿ç¨‹2ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º %d\n", shared_resource);
		shared_resource ++;
		rt_kprintf("çº¿ç¨‹2ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º %d\n", shared_resource);
		/* æ¨¡æ‹Ÿèµ„æºå¤„ç†è€—æ—¶ */
		rt_thread_mdelay(1000);
		/* é‡Šæ”¾äº’æ–¥ä¿¡å·é‡ */
		rt_sem_release(mutex_sem);
        /* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
		rt_thread_mdelay(500);
	}
}

int main(void)
{
		/* åˆ›å»ºä¸€ä¸ªäº’æ–¥ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1 */
		mutex_sem = rt_sem_create("mutex_sem", 1, RT_IPC_FLAG_PRIO);
		if (mutex_sem == RT_NULL)
	{
		rt_kprintf("äº’æ–¥ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
		return -1;
	}

		/* åˆ›å»ºçº¿ç¨‹1 */
		thread1_handle = rt_thread_create("thread1",
										thread1_entry,
										RT_NULL,
										THREAD_STACK_SIZE,
										THREAD_PRIORITY,
										THREAD_TIMESLICE);
										
if (thread1_handle != RT_NULL)	rt_thread_startup(thread1_handle);

		/* åˆ›å»ºçº¿ç¨‹2 */
		thread2_handle = rt_thread_create("thread2",
										thread2_entry,
										RT_NULL,
										THREAD_STACK_SIZE,
										THREAD_PRIORITY,
										THREAD_TIMESLICE);
if (thread2_handle != RT_NULL) rt_thread_startup(thread2_handle);
return 0;
}

```

2.ç°è±¡

åªæœ‰ä¸€ä¸ªä¿¡å·é‡ï¼Œéœ€è¦äº’æ–¥æŠ¢å 

![image-20250916184619179](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916184619179.png)

3.æ€»ç»“

------

RT-Thread äº’æ–¥ä¿¡å·é‡çº¿ç¨‹åŒæ­¥ç¤ºä¾‹

åŠŸèƒ½è¯´æ˜

æœ¬ç¤ºä¾‹æ¼”ç¤ºäº† **ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡äº’æ–¥ä¿¡å·é‡å®ç°å…±äº«èµ„æºä¿æŠ¤** çš„è¿‡ç¨‹ï¼š

- **å…±äº«èµ„æº**ï¼š`shared_resource` å…¨å±€å˜é‡ã€‚
- **çº¿ç¨‹1 & çº¿ç¨‹2**ï¼šéƒ½éœ€è¦è®¿é—®å’Œä¿®æ”¹å…±äº«èµ„æºã€‚
- **äº’æ–¥ä¿¡å·é‡**ï¼šä¿è¯åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®å…±äº«èµ„æºï¼Œé¿å…ç«äº‰ã€‚

ç¤ºä¾‹ä»£ç 

```c
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread1_handle = RT_NULL;
static rt_thread_t thread2_handle = RT_NULL;
static rt_sem_t mutex_sem = RT_NULL;

/* æ¨¡æ‹Ÿå…±äº«èµ„æº */
static int shared_resource = 0;

/* çº¿ç¨‹1å…¥å£å‡½æ•° */
static void thread1_entry(void *parameter)
{
    while (1)
    {
        /* è·å–äº’æ–¥ä¿¡å·é‡ */
        rt_sem_take(mutex_sem, RT_WAITING_FOREVER);
        rt_kprintf("çº¿ç¨‹1ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º %d\n", shared_resource);
        shared_resource ++;
        rt_kprintf("çº¿ç¨‹1ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º %d\n", shared_resource);
        /* æ¨¡æ‹Ÿèµ„æºå¤„ç†è€—æ—¶ */
        rt_thread_mdelay(1000);

        /* é‡Šæ”¾äº’æ–¥ä¿¡å·é‡ */
        rt_sem_release(mutex_sem);
        /* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
        rt_thread_mdelay(500);
    }
}

/* çº¿ç¨‹2å…¥å£å‡½æ•° */
static void thread2_entry(void *parameter)
{
    while (1)
    {
        /* è·å–äº’æ–¥ä¿¡å·é‡ */
        rt_sem_take(mutex_sem, RT_WAITING_FOREVER);
        rt_kprintf("çº¿ç¨‹2ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º %d\n", shared_resource);
        shared_resource ++;
        rt_kprintf("çº¿ç¨‹2ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º %d\n", shared_resource);
        /* æ¨¡æ‹Ÿèµ„æºå¤„ç†è€—æ—¶ */
        rt_thread_mdelay(1000);

        /* é‡Šæ”¾äº’æ–¥ä¿¡å·é‡ */
        rt_sem_release(mutex_sem);
        /* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
        rt_thread_mdelay(500);
    }
}

int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªäº’æ–¥ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1 */
    mutex_sem = rt_sem_create("mutex_sem", 1, RT_IPC_FLAG_PRIO);
    if (mutex_sem == RT_NULL)
    {
        rt_kprintf("äº’æ–¥ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
        return -1;
    }

    /* åˆ›å»ºçº¿ç¨‹1 */
    thread1_handle = rt_thread_create("thread1",
                                      thread1_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);
    if (thread1_handle != RT_NULL)
        rt_thread_startup(thread1_handle);

    /* åˆ›å»ºçº¿ç¨‹2 */
    thread2_handle = rt_thread_create("thread2",
                                      thread2_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);
    if (thread2_handle != RT_NULL)
        rt_thread_startup(thread2_handle);

    return 0;
}
```

è¿è¡Œæ•ˆæœ

ç³»ç»Ÿå¯åŠ¨åï¼Œä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è®¿é—®å…±äº«èµ„æºï¼Œæ—¥å¿—ç±»ä¼¼å¦‚ä¸‹ï¼ˆæ¥è‡ªä½ æä¾›çš„è¿è¡Œæˆªå›¾ï¼‰ï¼š

```
\ | /
- RT -     Thread Operating System
 / | \     4.1.1 build Sep 16 2025 17:30:15
2006 - 2022 Copyright by RT-Thread team

çº¿ç¨‹1ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º 0
çº¿ç¨‹1ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º 1
çº¿ç¨‹2ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º 1
çº¿ç¨‹2ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º 2
çº¿ç¨‹1ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º 2
çº¿ç¨‹1ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º 3
çº¿ç¨‹2ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º 3
çº¿ç¨‹2ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º 4
çº¿ç¨‹1ï¼šè®¿é—®å…±äº«èµ„æºï¼Œå½“å‰å€¼ä¸º 4
çº¿ç¨‹1ï¼šä¿®æ”¹å…±äº«èµ„æºï¼Œå€¼å˜ä¸º 5
...
```

æ€»ç»“

- ä½¿ç”¨ **äº’æ–¥ä¿¡å·é‡** å¯ä»¥ç¡®ä¿å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºæ—¶äº’æ–¥ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚
- æœ¬ä¾‹ä¸­ `shared_resource` çš„å€¼åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´å®‰å…¨é€’å¢ã€‚
- è‹¥ä¸åŠ äº’æ–¥ä¿¡å·é‡ï¼Œåˆ™å¯èƒ½å‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å˜é‡ï¼Œå¯¼è‡´æ•°æ®é”™è¯¯ã€‚



### äº‹ä»¶è§¦å‘ç¤ºä¾‹

å½“ä¸­æ–­æˆ–è€…å¤–éƒ¨äº‹ä»¶è§¦å‘ï¼Œçº¿ç¨‹ä¼šåœ¨ç­‰å¾…äº‹ä»¶å‘ç”Ÿæ—¶è·å–ä¿¡æ¯é‡

1.ä»£ç   ï¼ˆæœ¬å®ä¾‹å¹¶æ²¡æœ‰çœŸæ­£çš„å¤–éƒ¨ è§¦å‘ï¼Œä¾‹å¦‚æŒ‰é”®æŒ‰ä¸‹äº§ç”Ÿä¸­æ–­ï¼Œåªæ˜¯äººä¸ºçš„æ¨¡æ‹Ÿå¤–éƒ¨è§¦å‘äº‹ä»¶ï¼‰

```
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread_handle = RT_NULL;
static rt_sem_t event_sem = RT_NULL;

/* æ¨¡æ‹Ÿå¤–éƒ¨äº‹ä»¶å‘ç”Ÿï¼Œä¾‹å¦‚æŒ‰é”®ä¸­æ–­ */
void external_event_handler(void)
{
	rt_kprintf("å¤–éƒ¨äº‹ä»¶å‘ç”Ÿï¼å‘é€ä¿¡å·é‡ .\n");
	/* é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ */
	rt_sem_release(event_sem);
}

/* çº¿ç¨‹å…¥å£å‡½æ•° */
static void thread_entry(void *parameter)
{
		while (1)
	{
		rt_kprintf("çº¿ç¨‹ï¼šç­‰å¾…å¤–éƒ¨äº‹ä»¶ .\n");
		/* ç­‰å¾…å¤–éƒ¨äº‹ä»¶çš„ä¿¡å·é‡ */
		rt_sem_take(event_sem, RT_WAITING_FOREVER);
		rt_kprintf("çº¿ç¨‹ï¼šæ”¶åˆ°å¤–éƒ¨äº‹ä»¶ä¿¡å·ï¼Œå¤„ç†äº‹ä»¶ .\n");
		/* æ¨¡æ‹Ÿäº‹ä»¶å¤„ç†è¿‡ç¨‹ */
		rt_thread_mdelay(1000);
	}
}

int main(void)
{
	/* åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º0 */
	event_sem = rt_sem_create("event_sem", 0, RT_IPC_FLAG_PRIO);
	if (event_sem = RT_NULL)
	{
		rt_kprintf("ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
		return -1;
	}
	/* åˆ›å»ºçº¿ç¨‹ */
	thread_handle = rt_thread_create("thread",
									thread_entry,
									RT_NULL,
									THREAD_STACK_SIZE,
									THREAD_PRIORITY,
									THREAD_TIMESLICE);
									
	if (thread_handle != RT_NULL)		rt_thread_startup(thread_handle);

	/* æ¨¡æ‹Ÿå¤–éƒ¨äº‹ä»¶ */
	rt_thread_mdelay(2000);
	external_event_handler();
	return 0;
}

```

2.ç°è±¡

![image-20250916210440004](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916210440004.png)

3.æ€»ç»“

------

~~~markdown
# åŸºäº RT-Thread ä¿¡å·é‡çš„äº‹ä»¶é€šçŸ¥ç¤ºä¾‹

## 1. åŠŸèƒ½ç®€ä»‹
æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†åœ¨ RT-Threadç³»ç»Ÿä¸­ï¼Œå¦‚ä½•é€šè¿‡ä¿¡å·é‡å®ç°â€œçº¿ç¨‹ç­‰å¾…äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿåå”¤é†’çº¿ç¨‹â€çš„æœºåˆ¶ã€‚  
è¿™é‡Œçš„â€œå¤–éƒ¨äº‹ä»¶â€æ˜¯é€šè¿‡ å‡½æ•°è°ƒç”¨æ¨¡æ‹Ÿ çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ç¡¬ä»¶ä¸­æ–­ã€‚

è¿è¡Œè¿‡ç¨‹ï¼š
1. çº¿ç¨‹ A (`thread_entry`) åˆ›å»ºå¹¶ç­‰å¾… `event_sem` ä¿¡å·é‡ã€‚
2. ä¸»çº¿ç¨‹å»¶è¿Ÿ 2 ç§’åè°ƒç”¨ `external_event_handler()`ã€‚
3. `external_event_handler()` é‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’çº¿ç¨‹ Aã€‚
4. çº¿ç¨‹ A æ‰§è¡Œäº‹ä»¶å¤„ç†é€»è¾‘ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯ã€‚

---

## 2. ä»£ç è¯´æ˜

### 2.1 ä¿¡å·é‡åˆ›å»º
```c
event_sem = rt_sem_create("event_sem", 0, RT_IPC_FLAG_PRIO);
~~~

- åç§°ï¼š`event_sem`
- åˆå§‹å€¼ï¼š0ï¼ˆè¡¨ç¤ºæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼‰
- ç±»å‹ï¼šåŸºäº **ä¼˜å…ˆçº§** çš„ä¿¡å·é‡è°ƒåº¦ï¼ˆ`RT_IPC_FLAG_PRIO`ï¼‰ã€‚

------

2.2 çº¿ç¨‹å…¥å£å‡½æ•°

```c
static void thread_entry(void *parameter)
{
    while (1)
    {
        rt_kprintf("çº¿ç¨‹ï¼šç­‰å¾…å¤–éƒ¨äº‹ä»¶ .\n");
        rt_sem_take(event_sem, RT_WAITING_FOREVER);
        rt_kprintf("çº¿ç¨‹ï¼šæ”¶åˆ°å¤–éƒ¨äº‹ä»¶ä¿¡å·ï¼Œå¤„ç†äº‹ä»¶ .\n");
        rt_thread_mdelay(1000);
    }
}
```

- çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾… `event_sem` ä¿¡å·é‡ã€‚
- `RT_WAITING_FOREVER` è¡¨ç¤ºæ— é™ç­‰å¾…ï¼Œç›´åˆ°æœ‰ä¿¡å·é‡é‡Šæ”¾ã€‚
- æ”¶åˆ°ä¿¡å·é‡åï¼Œæ‰§è¡Œäº‹ä»¶å¤„ç†ï¼ˆè¿™é‡Œåªæ˜¯å»¶æ—¶ 1 ç§’æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹ï¼‰ã€‚

------

2.3 å¤–éƒ¨äº‹ä»¶å¤„ç†å‡½æ•°

```c
void external_event_handler(void)
{
    rt_kprintf("å¤–éƒ¨äº‹ä»¶å‘ç”Ÿï¼å‘é€ä¿¡å·é‡ .\n");
    rt_sem_release(event_sem);
}
```

- æ‰“å°â€œå¤–éƒ¨äº‹ä»¶å‘ç”Ÿâ€ã€‚
- è°ƒç”¨ `rt_sem_release()` é‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚

âš  æ³¨æ„ï¼šåœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œè¯¥å‡½æ•° **ä¸æ˜¯ç”±ç¡¬ä»¶ä¸­æ–­è‡ªåŠ¨è°ƒç”¨**ï¼Œè€Œæ˜¯ **åœ¨ `main()` ä¸­æ‰‹åŠ¨è°ƒç”¨** æ¥æ¨¡æ‹Ÿäº‹ä»¶ã€‚

------

2.4 ä¸»ç¨‹åºé€»è¾‘

```c
int main(void)
{
    /* åˆ›å»ºä¿¡å·é‡ */
    event_sem = rt_sem_create("event_sem", 0, RT_IPC_FLAG_PRIO);

    /* åˆ›å»ºçº¿ç¨‹ */
    thread_handle = rt_thread_create("thread",
                                    thread_entry,
                                    RT_NULL,
                                    THREAD_STACK_SIZE,
                                    THREAD_PRIORITY,
                                    THREAD_TIMESLICE);

    if (thread_handle != RT_NULL)       
        rt_thread_startup(thread_handle);

    /* æ¨¡æ‹Ÿå»¶è¿Ÿåäº‹ä»¶å‘ç”Ÿ */
    rt_thread_mdelay(2000);
    external_event_handler();  // æ¨¡æ‹Ÿå¤–éƒ¨äº‹ä»¶

    return 0;
}
```

- ç³»ç»Ÿå¯åŠ¨åç«‹å³åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è®©å®ƒç­‰å¾…ä¿¡å·é‡ã€‚
- ä¸»çº¿ç¨‹ç­‰å¾… **2 ç§’** åï¼Œè°ƒç”¨ `external_event_handler()`ï¼Œæ¨¡æ‹Ÿå¤–éƒ¨äº‹ä»¶ã€‚
- `thread_entry` çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œå“åº”å¹¶å¤„ç†äº‹ä»¶ã€‚

------

3. æ‰§è¡Œæµç¨‹å›¾

```text
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  ä¸»çº¿ç¨‹    â”‚
 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
 å»¶æ—¶2ç§’ â†’ è°ƒç”¨ external_event_handler()
                       â”‚
                       â–¼
          rt_sem_release(event_sem)
                       â”‚
                       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   ç­‰å¾…ä¿¡å·é‡çš„å·¥ä½œçº¿ç¨‹       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

------

4. ä¸çœŸå®å¤–éƒ¨ä¸­æ–­çš„åŒºåˆ«

å½“å‰ç¤ºä¾‹ä¸­çš„ `external_event_handler()` **å¹¶ä¸æ˜¯çœŸæ­£çš„ä¸­æ–­å‡½æ•°**ï¼Œè€Œæ˜¯ä¸»çº¿ç¨‹é‡Œä¸»åŠ¨è°ƒç”¨çš„ã€‚

åœ¨çœŸå®çš„ç¡¬ä»¶åœºæ™¯ä¸­ï¼š

1. åº”ä½¿ç”¨ RT-Thread æä¾›çš„ GPIO ä¸­æ–­æ³¨å†Œæ¥å£ï¼ˆå¦‚ `rt_pin_attach_irq`ï¼‰ã€‚
2. åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ï¼ˆISRï¼‰ä¸­è°ƒç”¨ `rt_sem_release()` é‡Šæ”¾ä¿¡å·é‡ã€‚
3. çº¿ç¨‹å³å¯åœ¨å¤–éƒ¨ç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨è¢«å”¤é†’å¤„ç†äº‹ä»¶ã€‚

5. è¿è¡Œæ—¥å¿—ç¤ºä¾‹

```
çº¿ç¨‹ï¼šç­‰å¾…å¤–éƒ¨äº‹ä»¶ .
å¤–éƒ¨äº‹ä»¶å‘ç”Ÿï¼å‘é€ä¿¡å·é‡ .
çº¿ç¨‹ï¼šæ”¶åˆ°å¤–éƒ¨äº‹ä»¶ä¿¡å·ï¼Œå¤„ç†äº‹ä»¶ .
çº¿ç¨‹ï¼šç­‰å¾…å¤–éƒ¨äº‹ä»¶ .
```

------

6. æ€»ç»“

- **ä¿¡å·é‡** æ˜¯ RT-Thread ä¸­å®ç°çº¿ç¨‹é—´åŒæ­¥çš„å¸¸ç”¨æœºåˆ¶ã€‚
- æœ¬ä»£ç é€šè¿‡ä¸»çº¿ç¨‹è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œ**æ¨¡æ‹Ÿå¤–éƒ¨äº‹ä»¶è§¦å‘çš„ä¿¡å·é‡é‡Šæ”¾**ã€‚
- è‹¥è¦ä¸çœŸå®ç¡¬ä»¶ä¸­æ–­ç»“åˆï¼Œéœ€è¦å°† `external_event_handler()` æ³¨å†Œåˆ°å¤–éƒ¨ä¸­æ–­å›è°ƒä¸­ã€‚



### é™é‡èµ„æºç®¡ç†ç¤ºä¾‹

å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æœ‰é™çš„èµ„æºæ± ï¼Œä½¿ç”¨ä¿¡å·é‡æ¥æ§åˆ¶è®¿é—®çš„æ•°é‡

1.ä»£ç 

```
#include <rtthread.h>

#define THREAD_STACK_SIZE 512
#define THREAD_PRIORITY 10
#define THREAD_TIMESLICE 5

static rt_thread_t thread1_handle = RT_NULL;
static rt_thread_t thread2_handle = RT_NULL;
static rt_sem_t resource_sem = RT_NULL;

/* çº¿ç¨‹1å…¥å£å‡½æ•° */
static void thread1_entry(void *parameter)
{
		while (1)
	{
		/* å°è¯•è·å–èµ„æº */
		if (rt_sem_take(resource_sem, RT_WAITING_FOREVER) = RT_EOK)
		{
			rt_kprintf("çº¿ç¨‹1ï¼šæˆåŠŸè·å–èµ„æºï¼\n");
			/* æ¨¡æ‹Ÿä½¿ç”¨èµ„æº */
			rt_thread_mdelay(2000);
			rt_kprintf("çº¿ç¨‹1ï¼šé‡Šæ”¾èµ„æºï¼\n");
			rt_sem_release(resource_sem);
		}
		/* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
		rt_thread_mdelay(500);
	}
}

		/* çº¿ç¨‹2å…¥å£å‡½æ•° */
static void thread2_entry(void *parameter)
{
		while (1)
	{
		/* å°è¯•è·å–èµ„æº */
		if (rt_sem_take(resource_sem, RT_WAITING_FOREVER) = RT_EOK)
		{
			rt_kprintf("çº¿ç¨‹2ï¼šæˆåŠŸè·å–èµ„æºï¼\n");
			/* æ¨¡æ‹Ÿä½¿ç”¨èµ„æº */
			rt_thread_mdelay(2000);
            rt_kprintf("çº¿ç¨‹2ï¼šé‡Šæ”¾èµ„æºï¼\n");
            rt_sem_release(resource_sem);
		}
		/* è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹ */
		rt_thread_mdelay(500);
	}
}

int main(void)
{
	/* åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º1ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªå¯ç”¨èµ„æº */
	resource_sem = rt_sem_create("resource_sem", 1, RT_IPC_FLAG_PRIO);
	if (resource_sem == RT_NULL)
	{
	rt_kprintf("ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
	return -1;
	}

	/* åˆ›å»ºçº¿ç¨‹1 */
	thread1_handle = rt_thread_create("thread1",
									thread1_entry,
									RT_NULL,
									THREAD_STACK_SIZE,
									THREAD_PRIORITY,
									THREAD_TIMESLICE);

if (thread1_handle = RT_NULL)	rt_thread_startup(thread1_handle);

	/* åˆ›å»ºçº¿ç¨‹2 */
	thread2_handle = rt_thread_create("thread2",
									thread2_entry,
									RT_NULL,
									THREAD_STACK_SIZE,
									THREAD_PRIORITY,
									THREAD_TIMESLICE);
if (thread2_handle != RT_NULL)
rt_thread_startup(thread2_handle);
return 0;
}
```

2.ç°è±¡

![image-20250916211920506](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916211920506.png)

3.æ€»ç»“

------

~~~markdown
 RT-Thread ä¿¡å·é‡å®ç°çº¿ç¨‹é—´èµ„æºäº’æ–¥ç¤ºä¾‹

1. åŠŸèƒ½ç®€ä»‹
æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†åœ¨ RT-Threadä¸­ï¼Œå¦‚ä½•é€šè¿‡ ä¿¡å·é‡ å®ç°çº¿ç¨‹é—´çš„ èµ„æºäº’æ–¥è®¿é—®ã€‚

- ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹ `thread1` å’Œ `thread2`ã€‚
- å…±äº«ä¸€ä¸ªâ€œèµ„æºâ€â€”â€”ä½¿ç”¨ä¸€ä¸ª**åˆå§‹å€¼ä¸º 1 çš„ä¿¡å·é‡**æ¥è¡¨ç¤ºè¯¥èµ„æºã€‚
- å½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°ä¿¡å·é‡åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°è¯¥ä¿¡å·é‡è¢«é‡Šæ”¾ã€‚
- è¿™æ ·ç¡®ä¿äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æºï¼Œé¿å…ç«äº‰å†²çªã€‚

---

 2. ä¿¡å·é‡åŸç†å›é¡¾
- ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºï¼š
  - äº’æ–¥è®¿é—®ï¼ˆåˆå§‹å€¼ä¸º 1ï¼Œç±»ä¼¼äº’æ–¥é”ï¼‰
  - äº‹ä»¶é€šçŸ¥ï¼ˆåˆå§‹å€¼ä¸º 0ï¼‰
- `rt_sem_take()`ï¼šè·å–ä¿¡å·é‡ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„ä¿¡å·é‡åˆ™çº¿ç¨‹è¿›å…¥æŒ‚èµ·ç­‰å¾…ã€‚
- `rt_sem_release()`ï¼šé‡Šæ”¾ä¿¡å·é‡ï¼Œä½¿ç­‰å¾…çš„çº¿ç¨‹é‡æ–°è·å¾—æ‰§è¡Œæœºä¼šã€‚

---

3. ä»£ç ç»“æ„

 3.1 ä¿¡å·é‡åˆ›å»º
```c
resource_sem = rt_sem_create("resource_sem", 1, RT_IPC_FLAG_PRIO);
~~~

- `resource_sem`ï¼šä¿¡å·é‡åç§°
- åˆå§‹å€¼ï¼š`1`ï¼ˆè¡¨ç¤ºä¸€å¼€å§‹èµ„æºå¯ç”¨ï¼‰
- `RT_IPC_FLAG_PRIO`ï¼šæŒ‰çº¿ç¨‹ä¼˜å…ˆçº§è¿›è¡Œè°ƒåº¦

------

3.2 çº¿ç¨‹å…¥å£å‡½æ•°

çº¿ç¨‹1ç¤ºä¾‹

```c
static void thread1_entry(void *parameter)
{
    while (1)
    {
        if (rt_sem_take(resource_sem, RT_WAITING_FOREVER) == RT_EOK)
        {
            rt_kprintf("çº¿ç¨‹1ï¼šæˆåŠŸè·å–èµ„æºï¼\n");
            rt_thread_mdelay(2000); // æ¨¡æ‹Ÿä½¿ç”¨èµ„æº
            rt_kprintf("çº¿ç¨‹1ï¼šé‡Šæ”¾èµ„æºï¼\n");
            rt_sem_release(resource_sem);
        }
        rt_thread_mdelay(500);
    }
}
```

çº¿ç¨‹2ç¤ºä¾‹

```c
static void thread2_entry(void *parameter)
{
    while (1)
    {
        if (rt_sem_take(resource_sem, RT_WAITING_FOREVER) == RT_EOK)
        {
            rt_kprintf("çº¿ç¨‹2ï¼šæˆåŠŸè·å–èµ„æºï¼\n");
            rt_thread_mdelay(2000); // æ¨¡æ‹Ÿä½¿ç”¨èµ„æº
            rt_kprintf("çº¿ç¨‹2ï¼šé‡Šæ”¾èµ„æºï¼\n");
            rt_sem_release(resource_sem);
        }
        rt_thread_mdelay(500);
    }
}
```

------

3.3 ä¸»å‡½æ•°æµç¨‹

```c
int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªåˆå§‹å€¼ä¸º1çš„ä¿¡å·é‡ï¼Œç”¨äºçº¿ç¨‹äº’æ–¥è®¿é—® */
    resource_sem = rt_sem_create("resource_sem", 1, RT_IPC_FLAG_PRIO);
    if (resource_sem == RT_NULL)
    {
        rt_kprintf("ä¿¡å·é‡åˆ›å»ºå¤±è´¥ï¼\n");
        return -1;
    }

    /* åˆ›å»ºçº¿ç¨‹1 */
    thread1_handle = rt_thread_create("thread1",
                                      thread1_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);
    if (thread1_handle != RT_NULL)
        rt_thread_startup(thread1_handle);

    /* åˆ›å»ºçº¿ç¨‹2 */
    thread2_handle = rt_thread_create("thread2",
                                      thread2_entry,
                                      RT_NULL,
                                      THREAD_STACK_SIZE,
                                      THREAD_PRIORITY,
                                      THREAD_TIMESLICE);
    if (thread2_handle != RT_NULL)
        rt_thread_startup(thread2_handle);

    return 0;
}
```

------

4. æ‰§è¡Œæµç¨‹

1. ç³»ç»Ÿå¯åŠ¨ï¼Œåˆ›å»ºä¿¡å·é‡ `resource_sem=1`ã€‚
2. ä¸¤ä¸ªçº¿ç¨‹ `thread1` å’Œ `thread2` åŒæ—¶è¿è¡Œï¼Œåˆ†åˆ«è¯•å›¾è·å–ä¿¡å·é‡ã€‚
3. ç¬¬ä¸€ä¸ªæˆåŠŸè·å–ä¿¡å·é‡çš„çº¿ç¨‹è¿›å…¥**èµ„æºä½¿ç”¨é˜¶æ®µ**ï¼ˆ2 ç§’ï¼‰ã€‚
4. åœ¨æŒæœ‰ä¿¡å·é‡æœŸé—´ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¼šå› ä¸º `rt_sem_take()` é˜»å¡è€ŒæŒ‚èµ·ç­‰å¾…ã€‚
5. å½“å‰çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡åï¼Œç­‰å¾…çš„çº¿ç¨‹è¢«å”¤é†’å¹¶è·å–èµ„æºã€‚
6. å¾ªç¯å¾€å¤ï¼Œä¸¤ä¸ªçº¿ç¨‹è½®æµä½¿ç”¨èµ„æºã€‚

------

5. è¿è¡Œæ—¥å¿—ç¤ºä¾‹

```text
çº¿ç¨‹1ï¼šæˆåŠŸè·å–èµ„æºï¼
çº¿ç¨‹1ï¼šé‡Šæ”¾èµ„æºï¼
çº¿ç¨‹2ï¼šæˆåŠŸè·å–èµ„æºï¼
çº¿ç¨‹2ï¼šé‡Šæ”¾èµ„æºï¼
çº¿ç¨‹1ï¼šæˆåŠŸè·å–èµ„æºï¼
çº¿ç¨‹1ï¼šé‡Šæ”¾èµ„æºï¼
...
```

------

6. æ€»ç»“

- **åœºæ™¯é€‚ç”¨**ï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºï¼ˆç¡¬ä»¶ã€å…±äº«æ•°æ®ï¼‰æ—¶ï¼Œé˜²æ­¢å†²çªã€‚
- **å…³é”®ç‚¹**ï¼š
  - ä½¿ç”¨åˆå§‹å€¼ä¸º `1` çš„ä¿¡å·é‡å®ç°**äº’æ–¥è®¿é—®**ã€‚
  - `rt_sem_take()` è´Ÿè´£è·å–èµ„æºï¼Œ`rt_sem_release()` è´Ÿè´£é‡Šæ”¾èµ„æºã€‚
- **æ‰©å±•**ï¼š
  - å¦‚æœéœ€è¦ç±»ä¼¼â€œä¸Šé”â€çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ **äº’æ–¥é‡ï¼ˆmutexï¼‰** æ›¿ä»£ä¿¡å·é‡ã€‚
  - å¦‚æœè¦æ§åˆ¶å¤šä»½ç›¸åŒèµ„æºï¼ˆå¦‚è¿æ¥æ± ã€ç¼“å­˜å—ç­‰ï¼‰ï¼Œå¯ä»¥å°†ä¿¡å·é‡åˆå§‹å€¼è®¾ç½®ä¸ºèµ„æºçš„æ•°é‡ã€‚ 





## çº¿ç¨‹åŒæ­¥æ€»ç»“

- **ä»»åŠ¡åŒæ­¥ï¼ˆçº¿ç¨‹åŒæ­¥ï¼‰**
- **ä»»åŠ¡äº’æ–¥**
- **å¤–éƒ¨äº‹ä»¶è§¦å‘**
- **é™é‡èµ„æºç®¡ç†**

------

```markdown
 RT-Thread çº¿ç¨‹åŒæ­¥ä¸é€šä¿¡æœºåˆ¶æ€»ç»“

 1. ä»»åŠ¡åŒæ­¥ï¼ˆçº¿ç¨‹åŒæ­¥ï¼‰

 ç‰¹ç‚¹
- ä½¿ç”¨ ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ æˆ– äº‹ä»¶é›†ï¼ˆEventï¼‰ å®ç°å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåºåè°ƒã€‚
- ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡åï¼Œé€šè¿‡ `rt_sem_release()` å‘é€ä¿¡å·é‡ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ç”¨ `rt_sem_take()` ç­‰å¾…æ‰§è¡Œã€‚
- ä¿è¯çº¿ç¨‹é—´æŒ‰ç…§è¦æ±‚çš„é¡ºåºæ‰§è¡Œã€‚

 é€‚ç”¨æ¡ä»¶
- å­˜åœ¨æ‰§è¡Œå…ˆåä¾èµ–çš„çº¿ç¨‹é—´åä½œã€‚ä¾‹å¦‚ï¼š
  - çº¿ç¨‹ A å¿…é¡»ç­‰å¾…çº¿ç¨‹ B å®Œæˆåˆå§‹åŒ–åæ‰èƒ½è¿è¡Œã€‚
  - æ•°æ®ç”Ÿäº§è€…â€“æ¶ˆè´¹è€…æ¨¡å‹ä¸­çš„åŒæ­¥é€šçŸ¥ã€‚

ç¤ºä¾‹ï¼š

// çº¿ç¨‹1ç­‰å¾…sync_semä¿¡å·é‡ï¼Œçº¿ç¨‹2å®Œæˆæ“ä½œåé‡Šæ”¾ä¿¡å·é‡å”¤é†’çº¿ç¨‹1
rt_sem_take(sync_sem, RT_WAITING_FOREVER);
```

------

2. ä»»åŠ¡äº’æ–¥

ç‰¹ç‚¹

- **äº’æ–¥ä¿¡å·é‡**ï¼ˆåˆå§‹å€¼ä¸º 1ï¼‰å¯ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œé¿å…æ•°æ®ç«äº‰ã€‚
- ç±»ä¼¼ **äº’æ–¥é”ï¼ˆMutexï¼‰**ï¼Œä½†ä¿¡å·é‡æ›´ä¸ºé€šç”¨ï¼Œå¯ä»¥å…è®¸å¤šç»™/å¤šå–ã€‚

é€‚ç”¨æ¡ä»¶

- å¤šä¸ªçº¿ç¨‹éœ€è¦è®¿é—®åŒä¸€ä¸ªå…±äº«èµ„æºï¼ˆå†…å­˜ã€å¤–è®¾å¯„å­˜å™¨ã€æ–‡ä»¶ç­‰ï¼‰ã€‚
- å¯¹å…±äº«èµ„æºè®¿é—®å¿…é¡»æ˜¯**ç‹¬å **çš„ï¼Œä¸èƒ½è¢«ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ã€‚

ç¤ºä¾‹ï¼š

```c
// ä¸¤ä¸ªçº¿ç¨‹éƒ½éœ€è¦ä¿®æ”¹shared_resourceï¼Œå¿…é¡»å…ˆè·å–mutex_semæ‰èƒ½è¿›å…¥
rt_sem_take(mutex_sem, RT_WAITING_FOREVER);
shared_resource++;
rt_sem_release(mutex_sem);
```

------

3. å¤–éƒ¨äº‹ä»¶è§¦å‘

ç‰¹ç‚¹

- é€šè¿‡ **ä¿¡å·é‡** æˆ– **äº‹ä»¶é€šçŸ¥** å®ç°å¤–éƒ¨äº‹ä»¶ï¼ˆä¸­æ–­ã€æŒ‰é”®ã€å®šæ—¶å™¨è¶…æ—¶ï¼‰ä¸çº¿ç¨‹é€šä¿¡ã€‚
- å¤–éƒ¨äº‹ä»¶å¯èƒ½æ˜¯ä¸­æ–­æœåŠ¡å‡½æ•°ï¼ˆISRï¼‰ä¸­è°ƒç”¨ `rt_sem_release()` å‘å‡ºçš„ã€‚
- ç­‰å¾…äº‹ä»¶çš„çº¿ç¨‹ä½¿ç”¨ `rt_sem_take()` é˜»å¡ï¼ŒèŠ‚çœ CPU ç©ºè½¬ã€‚

é€‚ç”¨æ¡ä»¶

- éœ€è¦å“åº”å¤–éƒ¨ç¡¬ä»¶ä¿¡å·æˆ–å¼‚æ­¥äº‹ä»¶ã€‚
- çº¿ç¨‹æ— éœ€ä¸»åŠ¨è½®è¯¢ç­‰å¾…ï¼Œä»è€Œå‡å°‘åŠŸè€—/é‡Šæ”¾ CPU æ—¶é—´ã€‚

ç¤ºä¾‹ï¼š

```c
// ISR æˆ–å…¶ä»–è§¦å‘æºè°ƒç”¨ï¼š
rt_sem_release(event_sem);

// çº¿ç¨‹ä¸­ç­‰å¾…ï¼š
rt_sem_take(event_sem, RT_WAITING_FOREVER);
```

------

4. é™é‡èµ„æºç®¡ç†

ç‰¹ç‚¹

- ä½¿ç”¨ **è®¡æ•°å‹ä¿¡å·é‡**ï¼ˆåˆå§‹å€¼ > 1ï¼‰è¡¨ç¤ºèµ„æºæ•°é‡ã€‚
- æ¯æ¬¡è·å–èµ„æºå‰æ‰§è¡Œ `rt_sem_take()`ï¼Œä½¿ç”¨å®Œå `rt_sem_release()`ã€‚
- ä¿¡å·é‡å€¼è¡¨ç¤ºå½“å‰å¯ç”¨èµ„æºæ•°é‡ï¼Œé˜²æ­¢å¤šçº¿ç¨‹è¶…é¢ç”³è¯·å¯¼è‡´å†²çªã€‚

é€‚ç”¨æ¡ä»¶

- æŒæœ‰æ•°é‡æœ‰é™çš„ç›¸åŒèµ„æºï¼ˆè¿æ¥æ± ã€ç¼“å­˜å—ã€è®¾å¤‡é€šé“ï¼‰ã€‚
- èµ„æºè¢«å¤šä¸ªçº¿ç¨‹ç«äº‰ä½¿ç”¨æ—¶ï¼Œéœ€è¦é…é¢æ§åˆ¶ã€‚

ç¤ºä¾‹ï¼š

```c
// åˆå§‹ä¿¡å·é‡value=1ï¼Œä»£è¡¨æœ‰ä¸€ä¸ªå¯ç”¨èµ„æº
if (rt_sem_take(resource_sem, RT_WAITING_FOREVER) == RT_EOK)
{
    // ä½¿ç”¨èµ„æº
    rt_sem_release(resource_sem);
}
```

------

å¯¹æ¯”æ€»ç»“è¡¨

| ç±»å‹         | ä¿¡å·é‡åˆå€¼ | ç‰¹ç‚¹                           | é€‚ç”¨åœºæ™¯                |
| ------------ | ---------- | ------------------------------ | ----------------------- |
| ä»»åŠ¡åŒæ­¥     | 0          | ç”¨äºçº¿ç¨‹æ‰§è¡Œé¡ºåºåè°ƒ           | ç”Ÿäº§è€…-æ¶ˆè´¹è€…ã€å¼‚æ­¥ç­‰å¾… |
| ä»»åŠ¡äº’æ–¥     | 1          | ä¿è¯å¯¹å…±äº«èµ„æºçš„ç‹¬å è®¿é—®       | å…±äº«å†…å­˜ã€å¤–è®¾è®¿é—®      |
| å¤–éƒ¨äº‹ä»¶è§¦å‘ | 0          | å“åº”å¤–éƒ¨ä¸­æ–­æˆ–äº‹ä»¶ï¼Œä½¿çº¿ç¨‹å”¤é†’ | æŒ‰é”®å“åº”ã€ç¡¬ä»¶ä¸­æ–­      |
| é™é‡èµ„æºç®¡ç† | N>1        | æ§åˆ¶å¯¹æœ‰é™æ•°é‡èµ„æºçš„è®¿é—®       | è¿æ¥æ± ã€ç¼“å†²åŒºåˆ†é…      |

------

å…³é”®æ³¨æ„äº‹é¡¹

1. **å®æ—¶æ€§**ï¼šRT-Thread æ˜¯å®æ—¶æ“ä½œç³»ç»Ÿï¼ŒåŒæ­¥/äº’æ–¥æ“ä½œåº”å°½é‡å‡å°‘ä¸´ç•ŒåŒºæ“ä½œæ—¶é—´ï¼Œé¿å…é˜»å¡é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚
2. **ä¸­æ–­ä¸­ä½¿ç”¨**ï¼šåœ¨ä¸­æ–­å¤„ç†å‡½æ•°é‡Œè°ƒç”¨ `rt_sem_release()` æ˜¯å®‰å…¨çš„ï¼Œä½†ä¸èƒ½é˜»å¡ç­‰å¾… (`rt_sem_take()`ï¼‰ã€‚
3. **æ­»é”é£é™©**ï¼šå¤šä¸ªä¿¡å·é‡åµŒå¥—è·å–éœ€æ³¨æ„é¿å…æ­»é”ã€‚
4. **è®¡æ•°ä¿¡å·é‡ä¸äº’æ–¥ä¿¡å·é‡ä¸åŒ**ï¼š
   - **äº’æ–¥ä¿¡å·é‡**ï¼šåˆå€¼ä¸º 1ï¼Œä¸»è¦ç”¨äºç‹¬å è®¿é—®ã€‚
   - **è®¡æ•°ä¿¡å·é‡**ï¼šåˆå€¼ä¸ºèµ„æºæ•°é‡ï¼Œç”¨äºé™é¢èµ„æºæ§åˆ¶ã€‚

------





## äº’æ–¥é‡

### äº’æ–¥é‡åº”ç”¨ç¤ºä¾‹

1. ä»€ä¹ˆæ˜¯äº’æ–¥é‡ï¼ˆMutexï¼‰
2. RT-Thread ä¸­äº’æ–¥é‡çš„ç‰¹æ€§
3. `rt_mutex_create` ç”¨æ³•è¯´æ˜
4. å¸¸ç”¨äº’æ–¥é‡ API ä»‹ç»åŠä½¿ç”¨ç¤ºä¾‹
5. äº’æ–¥é‡ vs ä¿¡å·é‡ å¯¹æ¯”

------

1. ä»€ä¹ˆæ˜¯äº’æ–¥é‡ï¼ˆMutexï¼‰

**äº’æ–¥é‡ï¼ˆMutex, Mutual Exclusionï¼‰** æ˜¯ä¸€ç§ç”¨äºå¤šçº¿ç¨‹/ä»»åŠ¡ä¹‹é—´**ä¿æŠ¤å…±äº«èµ„æº**çš„**åŒæ­¥æœºåˆ¶**ã€‚
 å®ƒç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»ï¼Œ**åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®æŸä¸€ä¸´ç•ŒåŒºï¼ˆå…±äº«èµ„æºï¼‰**ã€‚

**å…³é”®ä½œç”¨ï¼š**

- é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«æ•°æ®å¯¼è‡´æ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰ã€‚
- ç‹¬å è®¿é—®ï¼ˆExclusive Accessï¼‰ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**æ ¸å¿ƒè§„åˆ™ï¼š**

- ä¸€ä¸ªçº¿ç¨‹ä¸Šé”åï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½ç­‰å¾…ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è§£é”å†è¿›å…¥ä¸´ç•ŒåŒºã€‚
- æ‰€æœ‰ç­‰å¾…äº’æ–¥é‡çš„çº¿ç¨‹æŒ‰ä¼˜å…ˆçº§æˆ– FIFO ç­‰ç­–ç•¥è°ƒåº¦ã€‚

------

2. RT-Thread ä¸­äº’æ–¥é‡çš„ç‰¹æ€§

RT-Thread çš„äº’æ–¥é‡ï¼š

- æ”¯æŒ **ä¼˜å…ˆçº§ç»§æ‰¿**ï¼ˆPriority Inheritanceï¼‰ï¼š
   é˜²æ­¢**ä¼˜å…ˆçº§åè½¬**ï¼ˆPriority Inversionï¼‰ã€‚
- å¯ä»¥é€’å½’é”å®šï¼šåŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡ `take` åŒä¸€äº’æ–¥é‡ï¼Œç›´åˆ° `release` ç›¸åŒæ¬¡æ•°ã€‚
- åˆå§‹çŠ¶æ€ä¸º**è§£é”**ã€‚
- äº’æ–¥é‡å¿…é¡»ç”±**è·å¾—å®ƒçš„çº¿ç¨‹**é‡Šæ”¾ã€‚

ğŸ“Œ ä¸ä¿¡å·é‡ä¸åŒï¼šäº’æ–¥é‡å›ºå®šä¸º 1ï¼Œä¸å¯ä¸€æ¬¡æ€§ç»™å¤šä¸ªèµ„æºï¼Œä¸”å…·å¤‡**çº¿ç¨‹æ‹¥æœ‰è€…**å±æ€§ã€‚

------

3. `rt_mutex_create` ç”¨æ³•è¯´æ˜

rt_mutex_t rt_mutex_create(const char *name, rt_uint8_t flag)

**å‚æ•°è¯´æ˜**

| å‚æ•°   | å«ä¹‰                                                         |
| ------ | ------------------------------------------------------------ |
| `name` | äº’æ–¥é‡åç§°ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯ä¸º `RT_NULL`ï¼‰                         |
| `flag` | äº’æ–¥é‡æ ‡å¿—ä½ï¼Œæ”¯æŒå€¼ `RT_IPC_FLAG_PRIO`ï¼ˆæŒ‰ä¼˜å…ˆçº§ç­‰å¾…ï¼Œå¸¸ç”¨ï¼‰ |

**è¿”å›å€¼**

- æˆåŠŸï¼šè¿”å›äº’æ–¥é‡å¥æŸ„ `rt_mutex_t`
- å¤±è´¥ï¼šè¿”å› `RT_NULL`

**ä½¿ç”¨æ³¨æ„**

- åˆ›å»ºçš„äº’æ–¥é‡éœ€é…åˆ `rt_mutex_take` / `rt_mutex_release` ä½¿ç”¨ã€‚
- è‡ªåŠ¨åˆ›å»ºçš„äº’æ–¥é‡åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œéœ€è¦é‡Šæ”¾æ—¶ç”¨ `rt_mutex_delete`ã€‚

------

4. äº’æ–¥é‡ç›¸å…³ API

| API å‡½æ•°                           | ä½œç”¨                   | å¤‡æ³¨                                                         |
| ---------------------------------- | ---------------------- | ------------------------------------------------------------ |
| `rt_mutex_create(name, flag)`      | åˆ›å»ºä¸€ä¸ªåŠ¨æ€äº’æ–¥é‡     | å†…å­˜ç”± RT-Thread åˆ†é…                                        |
| `rt_mutex_init(mutex, name, flag)` | åˆå§‹åŒ–é™æ€äº’æ–¥é‡       | å†…å­˜ç”±ç”¨æˆ·æä¾›                                               |
| `rt_mutex_take(mutex, time)`       | ç”³è¯·äº’æ–¥é‡ï¼ˆä¸Šé”ï¼‰     | `time` å¯ä¸º `RT_WAITING_FOREVER`ï¼ˆæ°¸ä¹…ç­‰å¾…ï¼‰æˆ–è¶…æ—¶æ—¶é—´ï¼ˆtickï¼‰ |
| `rt_mutex_release(mutex)`          | é‡Šæ”¾äº’æ–¥é‡ï¼ˆè§£é”ï¼‰     | å¿…é¡»ç”±æŒæœ‰è¯¥é”çš„çº¿ç¨‹è°ƒç”¨                                     |
| `rt_mutex_detach(mutex)`           | è„±ç¦»ï¼ˆåˆ é™¤é™æ€äº’æ–¥é‡ï¼‰ | ä»…é™æ€äº’æ–¥é‡é€‚ç”¨                                             |
| `rt_mutex_delete(mutex)`           | åˆ é™¤åŠ¨æ€äº’æ–¥é‡         | é‡Šæ”¾å†…å­˜                                                     |

------

5. ä½¿ç”¨ç¤ºä¾‹

```c
#include <rtthread.h>

static rt_mutex_t mutex = RT_NULL;
static int shared_var = 0;

static void thread1_entry(void *param)
{
    while (1)
    {
        rt_mutex_take(mutex, RT_WAITING_FOREVER); // åŠ é”
        rt_kprintf("çº¿ç¨‹1 è·å–é”, shared_var = %d\n", shared_var);
        shared_var++;
        rt_thread_mdelay(1000);
        rt_mutex_release(mutex); // è§£é”
        rt_thread_mdelay(500);
    }
}

static void thread2_entry(void *param)
{
    while (1)
    {
        rt_mutex_take(mutex, RT_WAITING_FOREVER);
        rt_kprintf("çº¿ç¨‹2 è·å–é”, shared_var = %d\n", shared_var);
        shared_var++;
        rt_thread_mdelay(1000);
        rt_mutex_release(mutex);
        rt_thread_mdelay(500);
    }
}

int main(void)
{
    // åˆ›å»ºäº’æ–¥é‡
    mutex = rt_mutex_create("mtx", RT_IPC_FLAG_PRIO);
    if (mutex == RT_NULL)
    {
        rt_kprintf("åˆ›å»ºäº’æ–¥é‡å¤±è´¥ï¼\n");
        return -1;
    }

    rt_thread_t tid1 = rt_thread_create("t1", thread1_entry, RT_NULL, 1024, 10, 10);
    rt_thread_t tid2 = rt_thread_create("t2", thread2_entry, RT_NULL, 1024, 10, 10);

    rt_thread_startup(tid1);
    rt_thread_startup(tid2);

    return 0;
}
```

------

6. äº’æ–¥é‡ vs ä¿¡å·é‡

| å¯¹æ¯”é¡¹     | äº’æ–¥é‡ (Mutex)         | ä¿¡å·é‡ (Semaphore)     |
| ---------- | ---------------------- | ---------------------- |
| èµ„æºè®¡æ•°   | å›ºå®šä¸º 1               | å¯å¤§äº 1               |
| æ‹¥æœ‰è€…æ¦‚å¿µ | æœ‰ï¼Œåªæœ‰é”æŒæœ‰è€…å¯è§£é” | æ— ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯é‡Šæ”¾   |
| é€’å½’é”     | æ”¯æŒ                   | ä¸æ”¯æŒ                 |
| ä¼˜å…ˆçº§ç»§æ‰¿ | æ”¯æŒï¼Œé˜²æ­¢ä¼˜å…ˆçº§åè½¬   | é€šå¸¸ä¸æ”¯æŒ             |
| é€‚ç”¨åœºæ™¯   | ç‹¬å è®¿é—®ä¿æŠ¤           | ä»»åŠ¡åŒæ­¥ã€é™é‡èµ„æºç®¡ç† |

------

7. é€‚ç”¨æ¡ä»¶

- å½“å…±äº«èµ„æºï¼ˆå˜é‡ã€è®¾å¤‡ã€æ–‡ä»¶ç­‰ï¼‰**åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®**æ—¶ï¼Œä½¿ç”¨äº’æ–¥é‡ã€‚
- å½“éœ€è¦**é˜²æ­¢ä¼˜å…ˆçº§åè½¬**çš„åœºæ™¯ï¼ˆRTOS å®æ—¶ä»»åŠ¡ï¼‰ã€‚
- ä¸ç”¨äºè®¡æ•°èµ„æºï¼Œä¸ç”¨äºä»»åŠ¡é€šçŸ¥ï¼ˆé‚£æ˜¯ä¿¡å·é‡/äº‹ä»¶çš„èŒè´£ï¼‰ã€‚

------

âœ… **æ€»ç»“é¡ºå£ç‰ˆ**ï¼š
 `rt_mutex_create` åˆ›å»ºçš„äº’æ–¥é‡å°±æ˜¯**å¸¦ä¼˜å…ˆçº§ç»§æ‰¿çš„ç‹¬å é”**ï¼Œé€‚åˆä¿æŠ¤åªèƒ½ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„èµ„æºï¼ŒAPI æˆå¯¹ä½¿ç”¨ï¼š

- `rt_mutex_take()` ä¸Šé”
- `rt_mutex_release()` è§£é”

------



ä»£ç 

```
#include <rtthread.h>

/* åˆ›å»ºäº’æ–¥é‡ */
rt_mutex_t mutex = RT_NULL;
/* çº¿ç¨‹1ï¼šæƒ³ä½¿ç”¨æ´—æ‰‹é—´ */
void thread_entry1(void *parameter)
	{
		rt_kprintf("çº¿ç¨‹1: æƒ³ä½¿ç”¨æ´—æ‰‹é—´ .\n");
		rt_mutex_take(mutex, RT_WAITING_FOREVER); // è·å–äº’æ–¥é‡
        rt_kprintf("çº¿ç¨‹1: æ­£åœ¨ä½¿ç”¨æ´—æ‰‹é—´\n");
        rt_thread_mdelay(1000); // æ¨¡æ‹Ÿä½¿ç”¨æ—¶é—´
        rt_mutex_release(mutex); // é‡Šæ”¾äº’æ–¥é‡
        rt_kprintf("çº¿ç¨‹1: ä½¿ç”¨å®Œæ¯•ï¼Œé€€å‡ºæ´—æ‰‹é—´\n");
    }
    
/* çº¿ç¨‹2ï¼šæƒ³ä½¿ç”¨æ´—æ‰‹é—´ */
void thread_entry2(void *parameter)
	{
        rt_kprintf("çº¿ç¨‹2: æƒ³ä½¿ç”¨æ´—æ‰‹é—´ .\n");
        rt_mutex_take(mutex, RT_WAITING_FOREVER); / è·å–äº’æ–¥é‡
        rt_kprintf("çº¿ç¨‹2: æ­£åœ¨ä½¿ç”¨æ´—æ‰‹é—´\n");
        rt_thread_mdelay(1000); // æ¨¡æ‹Ÿä½¿ç”¨æ—¶é—´
        rt_mutex_release(mutex); // é‡Šæ”¾äº’æ–¥é‡
        rt_kprintf("çº¿ç¨‹2: ä½¿ç”¨å®Œæ¯•ï¼Œé€€å‡ºæ´—æ‰‹é—´\n");
	}
	
int main(void)
{
	/* åˆå§‹åŒ–äº’æ–¥é‡ */
	mutex = rt_mutex_create("mutex", RT_IPC_FLAG_PRIO);
	/* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
	rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 25,10);
	rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 25,10);

    /* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);
return 0;
}
```

ç°è±¡

![image-20250916214311277](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916214311277.png)

è¿™æ®µä»£ç é‡Œçš„é€»è¾‘å°±æ˜¯ï¼š

**ä¸¤ä¸ªçº¿ç¨‹ä¸€å¯åŠ¨ï¼Œå°±è‡ªåŠ¨å»ç«äº‰ï¼ˆæŠ¢ï¼‰äº’æ–¥é‡**ï¼Œè°å…ˆ `take` æˆåŠŸè°å°±è¿›å…¥ä¸´ç•ŒåŒºï¼ˆâ€œæ´—æ‰‹é—´â€ï¼‰ï¼Œå¦ä¸€ä¸ªå°±ä¼šé˜»å¡ç­‰å¾…ã€‚

------

ç»™ä½ è¯¦ç»†æ‹†è§£ä¸€ä¸‹æ‰§è¡Œé€»è¾‘

1. **ä¸»çº¿ç¨‹ main() å¹²äº†ä¸¤ä»¶äº‹**ï¼š

   - è°ƒç”¨ `rt_mutex_create("mutex", RT_IPC_FLAG_PRIO)` åˆ›å»ºäº†ä¸€ä¸ªäº’æ–¥é‡ï¼ˆåˆå§‹çŠ¶æ€æ˜¯â€œæœªä¸Šé”â€ï¼‰ã€‚
   - åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ `thread_entry1` å’Œ `thread_entry2`ï¼Œç„¶åå¯åŠ¨æ‰§è¡Œã€‚

2. **ä¸¤ä¸ªçº¿ç¨‹çš„å…¥å£å‡½æ•°**ï¼š

   - ä¸€å¼€å§‹éƒ½ä¼šæ‰§è¡Œåˆ°ï¼š

     ```c
     rt_mutex_take(mutex, RT_WAITING_FOREVER);
     ```

     è¿™é‡Œçš„æ„æ€æ˜¯**å»è·å–äº’æ–¥é‡**ï¼Œå¦‚æœäº’æ–¥é‡å·²è¢«åˆ«äººå ç”¨ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°äº’æ–¥é‡å¯ç”¨ã€‚

   - è° `take` æˆåŠŸï¼ˆæŠ¢åˆ°é”ï¼‰äº†ï¼Œå°±å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºï¼ˆè¿™é‡Œæ˜¯â€œæ­£åœ¨ä½¿ç”¨æ´—æ‰‹é—´â€ï¼‰ã€‚

   - å®Œæˆæ“ä½œåç”¨ `rt_mutex_release(mutex)` é‡Šæ”¾é”ï¼Œå¦ä¸€æ–¹ä¼šè¢«å”¤é†’ç»§ç»­æ‰§è¡Œã€‚

3. **è°ƒåº¦å™¨çš„ä½œç”¨**

   - RT-Thread çš„ä»»åŠ¡è°ƒåº¦æ˜¯**æŠ¢å å¼**çš„ï¼Œè€Œä¸”æ˜¯**ä¼˜å…ˆçº§ä¼˜å…ˆ**çš„ã€‚
   - ä½ åˆ›å»ºçš„ä¸¤ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§æ˜¯ä¸€æ ·çš„ï¼ˆ25ï¼‰ï¼Œæ‰€ä»¥è°ƒåº¦å™¨è½®æµç»™å®ƒä»¬åˆ†é…æ—¶é—´ç‰‡ï¼ˆ`10 ticks`ï¼‰ï¼Œè¿™æ ·å®ƒä»¬ä¼šâ€œå…¬å¹³ç«äº‰â€è¿™ä¸ªäº’æ–¥é‡ã€‚

4. **ç«äº‰è¿‡ç¨‹**ï¼ˆå‡è®¾çº¿ç¨‹1å…ˆè¿è¡Œï¼‰ï¼š

   ```
   çº¿ç¨‹1ï¼štakeæˆåŠŸ -> ä½¿ç”¨æ´—æ‰‹é—´ -> release
   çº¿ç¨‹2ï¼štakeæˆåŠŸ -> ä½¿ç”¨æ´—æ‰‹é—´ -> release
   å¾ªç¯...
   ```

   æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¦ä¸€ä¸ªä¼šåœ¨ `rt_mutex_take()` é˜»å¡ç­‰å¾…ã€‚

------

æ€»ç»“

- **äº’æ–¥é‡æœ¬èº«ä¸è´Ÿè´£å¯åŠ¨çº¿ç¨‹**ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè°ƒåº¦èµ„æºç®¡ç†å·¥å…·ã€‚
- **ç«äº‰äº’æ–¥é‡çš„å‰æ**æ˜¯ï¼šå¤šä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œéƒ½æ‰§è¡Œåˆ° `rt_mutex_take()`ï¼Œè°ƒåº¦å™¨å°±ä¼šåœ¨å®ƒä»¬ä¸­é—´å†³å®šè°å…ˆè·å¾—é”ã€‚
- è¿™ç§å†™æ³•å«**â€œè‡ªç„¶ç«äº‰â€**ï¼šçº¿ç¨‹å¯åŠ¨å°±å»å é”ï¼Œç«äº‰ç»“æœç”± RTOS è°ƒåº¦å™¨å†³å®šã€‚

------

ğŸ’¡ å½“å‰è¿™ä¸ªä¾‹å­å’Œç°å®ç”Ÿæ´»å¾ˆåƒï¼š

- **äº’æ–¥é‡** å°±æ˜¯â€œæ´—æ‰‹é—´é—¨é”â€ã€‚
- **ä¸¤ä¸ªçº¿ç¨‹** å°±æ˜¯ä¸¤ä¸ªäººã€‚
- ä¸¤ä¸ªçº¿ç¨‹ä¸€å¼€å§‹å°±å¾€é—¨å£è·‘ï¼š
  - è°å…ˆæ‹¿åˆ°é’¥åŒ™ï¼ˆtake æˆåŠŸï¼‰ï¼Œè°å…ˆè¿›å»ã€‚
  - å‡ºæ¥ï¼ˆreleaseï¼‰åï¼Œä¸‹ä¸€ä¸ªäººæ‰èƒ½è¿›å»ã€‚

------





## äº‹ä»¶é›†

### äº‹ä»¶é›†åº”ç”¨ä¸¾ä¾‹

å¥½çš„ï¼Œä½ é—®çš„æ˜¯ **RT-Thread äº‹ä»¶é›†**ï¼ˆEvent Setï¼‰åŠ `rt_event_recv` ç›¸å…³å†…å®¹ï¼Œæˆ‘ç»™ä½ ç³»ç»Ÿæ¢³ç†ä¸€ä¸‹ï¼ŒåŒ…å«æ¦‚å¿µã€ç‰¹ç‚¹ã€APIã€ç”¨æ³•å’Œä¿¡å·é‡/äº’æ–¥é‡çš„åŒºåˆ«ã€‚

------

1. ä»€ä¹ˆæ˜¯äº‹ä»¶é›†ï¼ˆEventï¼‰

åœ¨ **RT-Thread** ä¸­ï¼Œ**äº‹ä»¶é›†ï¼ˆEvent Setï¼‰** æ˜¯ä¸€ç§æ•ˆç‡å¾ˆé«˜çš„**çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶**ï¼Œå®ƒå…è®¸å¤šä¸ªçº¿ç¨‹é€šè¿‡**äº‹ä»¶æ ‡å¿—ä½ï¼ˆFlag bitsï¼‰** æ¥å®ç°åŒæ­¥ã€‚æ¯ä¸ª bit è¡¨ç¤ºä¸€ä¸ªäº‹ä»¶çŠ¶æ€ï¼Œå¤šä¸ªäº‹ä»¶å¯ä»¥ç»„æˆä¸€ä¸ªäº‹ä»¶é›† **(Event Set)**ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**

- äº‹ä»¶é›†å†…éƒ¨ç”¨ä¸€ä¸ª **32 ä½æ•´å‹** ä½œä¸ºäº‹ä»¶æ ‡å¿—ï¼ˆflagï¼‰ã€‚
- æ¯ä¸ª bit ä»£è¡¨ä¸€ç§äº‹ä»¶ï¼Œ1 è¡¨ç¤ºè¯¥äº‹ä»¶å·²å‘ç”Ÿï¼Œ0 è¡¨ç¤ºæœªå‘ç”Ÿã€‚
- çº¿ç¨‹å¯ä»¥ç­‰å¾…å•ä¸ªäº‹ä»¶æˆ–å¤šä¸ªäº‹ä»¶ï¼ŒåŒæ—¶æ”¯æŒ **ä¸ï¼ˆANDï¼‰** / **æˆ–ï¼ˆORï¼‰** ä¸¤ç§ç­‰å¾…æ–¹å¼ã€‚
- å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ **æ¸…é™¤æ ‡å¿—ä½**ï¼ˆå³é‡ç½®ä¸º 0ï¼‰ã€‚

ğŸ“Œ äº‹ä»¶é›†é€‚åˆ**ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤š**çš„åœºæ™¯ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹ç­‰å¾…æŸå‡ ç§äº‹ä»¶çš„ç»„åˆã€‚

------

2. RT-Thread äº‹ä»¶é›†çš„ç‰¹ç‚¹

1. **ä½å›¾ç®¡ç†**ï¼šæœ€å¤šå¯åŒæ—¶ç®¡ç† 32 ä¸ªä¸åŒçš„äº‹ä»¶æ ‡å¿—ã€‚
2. **å¤šç§ç­‰å¾…æ¨¡å¼**ï¼š
   - **`AND` æ¨¡å¼**ï¼šç­‰å¾…çš„å¤šä¸ªäº‹ä»¶å¿…é¡»åŒæ—¶å‘ç”Ÿã€‚
   - **`OR` æ¨¡å¼**ï¼šç­‰å¾…çš„ä»»æ„ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿå³å¯å”¤é†’ã€‚
3. **è‡ªåŠ¨æ¸…é™¤æ ‡å¿—**ï¼ˆ`clear`ï¼‰ï¼šåœ¨äº‹ä»¶è¢«çº¿ç¨‹æ¥æ”¶åï¼Œä¼šè‡ªåŠ¨æŠŠç›¸åº”çš„æ ‡å¿—ä½æ¸…é›¶ï¼ˆé¿å…ä¸‹æ¬¡è¯¯è§¦å‘ï¼‰ã€‚
4. ä¸ä¿¡å·é‡ç›¸æ¯”ï¼Œäº‹ä»¶é›†æ›´é€‚åˆ**å¤šä½äº‹ä»¶æ¡ä»¶æ§åˆ¶**ï¼Œé¿å…åˆ›å»ºå¤šä¸ªä¿¡å·é‡ã€‚

------

3. äº‹ä»¶é›† API ä»‹ç»

3.1 åˆ›å»ºäº‹ä»¶é›†

åŠ¨æ€åˆ›å»º

```c
rt_event_t rt_event_create(const char *name, rt_uint8_t flag);
```

- `name`ï¼šäº‹ä»¶é›†çš„åå­—ï¼ˆè°ƒè¯•å¯è§ï¼‰
- `flag`ï¼š
  - `RT_IPC_FLAG_PRIO`ï¼šæŒ‰çº¿ç¨‹ä¼˜å…ˆçº§å”¤é†’
  - `RT_IPC_FLAG_FIFO`ï¼šæŒ‰å…ˆæ¥å…ˆæœåŠ¡é¡ºåºå”¤é†’
- è¿”å›å€¼ï¼šäº‹ä»¶å¯¹è±¡å¥æŸ„ï¼ˆå¤±è´¥è¿”å› `RT_NULL`ï¼‰

é™æ€åˆå§‹åŒ–

```c
rt_err_t rt_event_init(rt_event_t event, const char *name, rt_uint8_t flag);
```

------

3.2 å‘é€äº‹ä»¶ï¼ˆè®¾ç½®æ ‡å¿—ä½ï¼‰

```c
rt_err_t rt_event_send(rt_event_t event, rt_uint32_t set);
```

- `set`ï¼šè¦å‘é€çš„äº‹ä»¶ä½æ©ç ï¼ˆbitmaskï¼‰ï¼Œ1 ä»£è¡¨ç½®ä½ã€‚ä¾‹å¦‚ï¼š
  - å‘é€äº‹ä»¶ 0x01 è¡¨ç¤ºç¬¬ 0 ä½äº‹ä»¶å‘ç”Ÿã€‚
  - å‘é€äº‹ä»¶ 0x05ï¼ˆäºŒè¿›åˆ¶ 0101ï¼‰è¡¨ç¤ºç¬¬ 0 å’Œç¬¬ 2 ä½äº‹ä»¶å‘ç”Ÿã€‚

------

3.3 æ¥æ”¶äº‹ä»¶ï¼ˆç­‰å¾…äº‹ä»¶ï¼‰

```c
rt_err_t rt_event_recv(
    rt_event_t event,             // äº‹ä»¶é›†å¯¹è±¡
    rt_uint32_t set,              // ç­‰å¾…çš„äº‹ä»¶ä½æ©ç 
    rt_uint8_t  option,           // ç­‰å¾…æ¨¡å¼
    rt_int32_t  timeout,          // ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆtickï¼‰ï¼Œ0=ç«‹å³è¿”å›ï¼ŒRT_WAITING_FOREVER=æ°¸ä¹…ç­‰å¾…
    rt_uint32_t *recved           // å®é™…æ¥æ”¶åˆ°çš„äº‹ä»¶æ ‡å¿—
);
```

ç­‰å¾…æ¨¡å¼ `option`

- `RT_EVENT_FLAG_AND`ï¼šç­‰å¾…çš„æ‰€æœ‰äº‹ä»¶ä½**å…¨éƒ¨å‘ç”Ÿ**åæ‰è¿”å›ã€‚
- `RT_EVENT_FLAG_OR`ï¼šåªè¦ç­‰å¾…çš„ä»»ä¸€äº‹ä»¶å‘ç”Ÿå³å¯è¿”å›ã€‚
- `RT_EVENT_FLAG_CLEAR`ï¼ˆå¯ä¸ AND/OR ç»„åˆï¼‰ï¼šæ¥æ”¶åè‡ªåŠ¨å°†äº‹ä»¶ä½æ¸…é›¶ã€‚

ä¾‹å­ï¼š

```c
RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR // ç­‰å¾…å¤šä¸ªäº‹ä»¶å…¨éƒ¨å‘ç”Ÿï¼Œå¹¶åœ¨è¿”å›åè‡ªåŠ¨æ¸…é™¤æ ‡å¿—
```

------

3.4 åˆ é™¤äº‹ä»¶é›†

```c
rt_err_t rt_event_delete(rt_event_t event); // åŠ¨æ€äº‹ä»¶
rt_err_t rt_event_detach(rt_event_t event); // é™æ€äº‹ä»¶
```

------

4. ä½¿ç”¨ç¤ºä¾‹

ç¤ºä¾‹ï¼šçº¿ç¨‹ç­‰å¾… AND/OR æ¨¡å¼äº‹ä»¶

![image-20250916221617001](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916221617001.png)

```c
#include <rtthread.h>

#define EVENT_FLAG1   (1 << 0)   // bit0  0x00000001
#define EVENT_FLAG2   (1 << 1)   // bit1  0x00000010

static rt_event_t event;

static void thread_recv_entry(void *parameter)
{
    rt_uint32_t recved;
    while (1)
    {
        // ç­‰å¾…äº‹ä»¶1 æˆ– äº‹ä»¶2 å‘ç”Ÿï¼Œæ”¶åè‡ªåŠ¨æ¸…é™¤
        rt_event_recv(event,
                      EVENT_FLAG1 | EVENT_FLAG2,
                      RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR,
                      RT_WAITING_FOREVER,
                      &recved);

        if (recved & EVENT_FLAG1)
            rt_kprintf("æ”¶åˆ°äº‹ä»¶1\n");
        if (recved & EVENT_FLAG2)
            rt_kprintf("æ”¶åˆ°äº‹ä»¶2\n");
    }
}

static void thread_send_entry(void *parameter)
{
    rt_thread_mdelay(1000);
    rt_event_send(event, EVENT_FLAG1);

    rt_thread_mdelay(1000);
    rt_event_send(event, EVENT_FLAG2);
}

int main(void)
{
    // åˆ›å»ºäº‹ä»¶å¯¹è±¡
    event = rt_event_create("evt", RT_IPC_FLAG_PRIO);

    // åˆ›å»ºæ¥æ”¶çº¿ç¨‹
    rt_thread_t tid1 = rt_thread_create("recv", thread_recv_entry, RT_NULL, 1024, 10, 10);
    rt_thread_t tid2 = rt_thread_create("send", thread_send_entry, RT_NULL, 1024, 10, 10);

    rt_thread_startup(tid1);
    rt_thread_startup(tid2);

    return 0;
}
```

------

5. äº‹ä»¶é›† vs ä¿¡å·é‡ vs äº’æ–¥é‡

| ç‰¹æ€§             | äº‹ä»¶é›†(Event)      | ä¿¡å·é‡(Semaphore)  | äº’æ–¥é‡(Mutex) |
| ---------------- | ------------------ | ------------------ | ------------- |
| åŒæ—¶ç®¡ç†å¤šä¸ªçŠ¶æ€ | âœ…ï¼ˆä½æ©ç ï¼‰        | âŒ                  | âŒ             |
| ç­‰å¾…æ¨¡å¼         | AND/OR             | å•ä¸ªä¿¡å·é‡         | å•ä¸ªäº’æ–¥é”    |
| è‡ªåŠ¨æ¸…é™¤         | å¯é€‰               | å–ä¸€æ¬¡å‡ä¸€æ¬¡       | è§£é”æ‰é‡Šæ”¾    |
| ç”¨é€”             | å¤šçº¿ç¨‹å¹¶å‘äº‹ä»¶åè°ƒ | èµ„æºè®¡æ•°ã€çº¿ç¨‹åŒæ­¥ | ç‹¬å èµ„æºä¿æŠ¤  |
| ä¼˜å…ˆçº§ç»§æ‰¿       | âŒ                  | âŒ                  | âœ…             |

------

6. é€‚ç”¨åœºæ™¯

- ä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¤šä¸ªä¸åŒäº‹ä»¶æ¥æºï¼ˆGPIO ä¸­æ–­ã€ä¼ æ„Ÿå™¨æ›´æ–°ã€ç½‘ç»œæ•°æ®åˆ°è¾¾ç­‰ï¼‰ã€‚
- å¤šä¸ªä»»åŠ¡å¯èƒ½å‘é€ä¸åŒäº‹ä»¶ç»™åŒä¸€ä¸ªä»»åŠ¡ï¼ˆé›†ä¸­å¤„ç†ï¼‰ã€‚
- æ›¿ä»£å¤šä¸ªä¿¡å·é‡ï¼Œé™ä½ IPC å¯¹è±¡æ•°é‡ã€‚

------

âœ… **ä¸€å¥è¯è®°å¿†**

> ä¿¡å·é‡æ˜¯â€œä¸€ä¸ªæ¡¶è£…ä¸€ä¸ªçƒâ€ï¼Œäº’æ–¥é‡æ˜¯â€œåªæœ‰é’¥åŒ™çš„é”â€ï¼Œäº‹ä»¶é›†æ˜¯â€œä¸€å—32ä½çš„äº‹ä»¶å…¬å‘Šç‰Œâ€ï¼Œçº¿ç¨‹å¯ä»¥ä¸€æ¬¡çœ‹å…¬å‘Šç‰Œä¸Šçš„ä¸€æ¡æˆ–å¤šæ¡æ¶ˆæ¯ï¼Œå¹¶æ ¹æ® AND/OR è§„åˆ™å†³å®šä»€ä¹ˆæ—¶å€™ç»§ç»­è·‘ã€‚

------



ä¸¾ä¾‹

```
#include <rtthread.h>

    /* åˆ›å»ºäº‹ä»¶å¯¹è±¡ */
rt_event_t event = RT_NULL;

    /* è¿åŠ¨å‘˜çº¿ç¨‹ï¼šç­‰å¾…ä¸¤ä¸ªè£åˆ¤ä¿¡å· */
void athlete_entry(void *parameter)
{
        rt_uint32_t received;
        rt_kprintf("è¿åŠ¨å‘˜: ç­‰å¾…è£åˆ¤çš„å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å· .\n");
        /* ç­‰å¾…ä¸¤ä¸ªäº‹ä»¶ï¼šå‡†å¤‡ä¿¡å·(ä½1)å’Œå¼€å§‹ä¿¡å·(ä½2) */
        rt_event_recv(event, (1 << 1 | 1 << 2),
                        RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR,
                        RT_WAITING_FOREVER,
                        &received);
    /* ä¸¤ä¸ªäº‹ä»¶éƒ½æ”¶åˆ°ï¼Œè¿åŠ¨å‘˜èµ·è·‘ */
    rt_kprintf("è¿åŠ¨å‘˜: æ”¶åˆ°å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å·ï¼Œå‡†å¤‡èµ·è·‘ï¼\n");
}

/* è£åˆ¤1çº¿ç¨‹ï¼šå‘é€å‡†å¤‡ä¿¡å· */
void referee1_entry(void *parameter)
{
    rt_thread_mdelay(500); // æ¨¡æ‹Ÿå‡†å¤‡æ—¶é—´
    rt_kprintf("è£åˆ¤1: å‘é€å‡†å¤‡ä¿¡å·\n");
    rt_event_send(event, (1 << 1)); // å‘é€å‡†å¤‡ä¿¡å·äº‹ä»¶ï¼ˆä½1ï¼‰
}
/* è£åˆ¤2çº¿ç¨‹ï¼šå‘é€å¼€å§‹ä¿¡å· */
void referee2_entry(void *parameter)
{
    rt_thread_mdelay(1000); // æ¨¡æ‹Ÿå‡†å¤‡æ—¶é—´
    rt_kprintf("è£åˆ¤2: å‘é€å¼€å§‹ä¿¡å·\n");
    rt_event_send(event, (1 << 2)); // å‘é€å¼€å§‹ä¿¡å·äº‹ä»¶ï¼ˆä½2ï¼‰
}

int main(void)
{
    /* åˆå§‹åŒ–äº‹ä»¶å¯¹è±¡ */
    event = rt_event_create("event", RT_IPC_FLAG_PRIO);
    /* åˆ›å»ºè¿åŠ¨å‘˜çº¿ç¨‹ */
    rt_thread_t athlete_tid = rt_thread_create("athlete",
                                            athlete_entry,
                                            RT_NULL, 1024, 25, 10);
    /* åˆ›å»ºè£åˆ¤1çº¿ç¨‹ */
    rt_thread_t referee1_tid = rt_thread_create("referee1",
                                            referee1_entry,
                                            RT_NULL, 1024, 25, 10);
/* åˆ›å»ºè£åˆ¤2çº¿ç¨‹ */
    rt_thread_t referee2_tid = rt_thread_create("referee2",
                                            referee2_entry,
                                            RT_NULL, 1024, 25, 10);
/* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(athlete_tid);
    rt_thread_startup(referee1_tid);
    rt_thread_startup(referee2_tid);
return 0;
}


```

ç°è±¡

![image-20250916222528176](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250916222528176.png)

æ€»ç»“

------

```markdown
# RT-Thread äº‹ä»¶é›† AND æ¨¡å¼åŒæ­¥ç¤ºä¾‹ï¼šè¿åŠ¨å‘˜ä¸è£åˆ¤

## 1. åŠŸèƒ½ç®€ä»‹
æœ¬ç¤ºä¾‹æ¼”ç¤ºäº† **RT-Thread äº‹ä»¶é›†ï¼ˆEventï¼‰** çš„ **AND** æ¨¡å¼åŒæ­¥ç”¨æ³•ï¼š  
- ä¸€ä¸ªè¿åŠ¨å‘˜çº¿ç¨‹å¿…é¡» **åŒæ—¶** æ”¶åˆ° **ä¸¤ä¸ªè£åˆ¤çº¿ç¨‹** å‘æ¥çš„ä¿¡å·æ‰èƒ½èµ·è·‘ã€‚  
- è¿™æ˜¯äº‹ä»¶é›† **å¤šæ¡ä»¶åŒæ­¥** çš„å…¸å‹åœºæ™¯ã€‚

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨äº‹ä»¶é›†çš„ **ä½æ ‡å¿—** è¡¨ç¤ºä¸åŒçš„äº‹ä»¶ã€‚
- é€šè¿‡ `RT_EVENT_FLAG_AND` æ¨¡å¼ç¡®ä¿å¤šä¸ªäº‹ä»¶å…¨éƒ¨å‘ç”Ÿæ‰ç»§ç»­æ‰§è¡Œã€‚
- é€šè¿‡ `RT_EVENT_FLAG_CLEAR` æ¨¡å¼ä¿è¯ä¸€æ¬¡æ¥æ”¶åæ¸…é™¤äº‹ä»¶ï¼Œé¿å…é‡å¤è§¦å‘ã€‚

---

## 2. åœºæ™¯æè¿°
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
- ä¸¤ä¸ªè£åˆ¤åˆ†åˆ«è´Ÿè´£å‘ **å‡†å¤‡ä¿¡å·ï¼ˆbit1ï¼‰** å’Œ **å¼€å§‹ä¿¡å·ï¼ˆbit2ï¼‰**ã€‚
- è¿åŠ¨å‘˜å¿…é¡»ç­‰åˆ° **å‡†å¤‡** å’Œ **å¼€å§‹** ä¸¤ä¸ªä¿¡å·éƒ½åˆ°ä½åï¼Œæ‰èƒ½èµ·è·‘ã€‚

ç¨‹åºç”¨äº‹ä»¶é›†çš„ä¸åŒ bit ä½æ¥è¡¨ç¤ºè¿™äº›ä¿¡å·ï¼Œå…·ä½“ä¸ºï¼š
```

bit1 (1 << 1) = å‡†å¤‡ä¿¡å·
 bit2 (1 << 2) = å¼€å§‹ä¿¡å·

```
---

## 3. ä»£ç ç»“æ„

### 3.1 å®å®šä¹‰ä¸äº‹ä»¶å¯¹è±¡
```c
rt_event_t event = RT_NULL; // äº‹ä»¶å¯¹è±¡
```

äº‹ä»¶å¯¹è±¡ç”± `rt_event_create()` åŠ¨æ€åˆ›å»ºï¼Œæ ‡å¿—è°ƒåº¦æ¨¡å¼ä¸º **ä¼˜å…ˆçº§ä¼˜å…ˆ** (`RT_IPC_FLAG_PRIO`)ã€‚

------

3.2 è¿åŠ¨å‘˜çº¿ç¨‹

```c
void athlete_entry(void *parameter)
{
    rt_uint32_t received;
    rt_kprintf("è¿åŠ¨å‘˜: ç­‰å¾…è£åˆ¤çš„å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å· .\n");

    rt_event_recv(event, (1 << 1 | 1 << 2),
                  RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR,
                  RT_WAITING_FOREVER,
                  &received);

    rt_kprintf("è¿åŠ¨å‘˜: æ”¶åˆ°å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å·ï¼Œå‡†å¤‡èµ·è·‘ï¼\n");
}
```

- ç­‰å¾… `bit1` **å’Œ** `bit2` **åŒæ—¶ç½®ä½**ã€‚
- `RT_EVENT_FLAG_CLEAR`ï¼šæ¥æ”¶åˆ°è¿™ä¸¤ä¸ªäº‹ä»¶åè‡ªåŠ¨æ¸…é›¶ã€‚
- `RT_WAITING_FOREVER`ï¼šæ°¸ä¹…é˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿã€‚

------

3.3 è£åˆ¤çº¿ç¨‹

**è£åˆ¤1**ï¼š

```c
void referee1_entry(void *parameter)
{
    rt_thread_mdelay(500);
    rt_kprintf("è£åˆ¤1: å‘é€å‡†å¤‡ä¿¡å·\n");
    rt_event_send(event, (1 << 1));
}
```

**è£åˆ¤2**ï¼š

```c
void referee2_entry(void *parameter)
{
    rt_thread_mdelay(1000);
    rt_kprintf("è£åˆ¤2: å‘é€å¼€å§‹ä¿¡å·\n");
    rt_event_send(event, (1 << 2));
}
```

- ä¸¤ä¸ªè£åˆ¤çº¿ç¨‹åˆ†åˆ«å»¶è¿Ÿä¸åŒæ—¶é—´åï¼Œå‘é€å„è‡ªçš„äº‹ä»¶ã€‚
- ä½¿ç”¨ `rt_event_send()` è®¾ç½®å¯¹åº” bit ä½ã€‚

------

3.4 ä¸»å‡½æ•°

```c
int main(void)
{
    event = rt_event_create("event", RT_IPC_FLAG_PRIO);

    // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹
    rt_thread_t athlete_tid = rt_thread_create("athlete", athlete_entry, RT_NULL, 1024, 25, 10);
    rt_thread_t referee1_tid = rt_thread_create("referee1", referee1_entry, RT_NULL, 1024, 25, 10);
    rt_thread_t referee2_tid = rt_thread_create("referee2", referee2_entry, RT_NULL, 1024, 25, 10);

    // å¯åŠ¨çº¿ç¨‹
    rt_thread_startup(athlete_tid);
    rt_thread_startup(referee1_tid);
    rt_thread_startup(referee2_tid);

    return 0;
}
```

------

4. API ç”¨æ³•è¯´æ˜

åˆ›å»ºäº‹ä»¶

```c
rt_event_t rt_event_create(const char *name, rt_uint8_t flag);
```

- `name`ï¼šäº‹ä»¶å¯¹è±¡åç§°
- `flag`ï¼š`RT_IPC_FLAG_PRIO` æˆ– `RT_IPC_FLAG_FIFO`

å‘é€äº‹ä»¶

```c
rt_err_t rt_event_send(rt_event_t event, rt_uint32_t set);
```

- `set`ï¼šå¯¹åº”çš„ bit æ©ç ï¼ˆå¦‚ `(1 << 1)`ï¼‰

æ¥æ”¶äº‹ä»¶

```c
rt_err_t rt_event_recv(rt_event_t event, rt_uint32_t set,
                       rt_uint8_t option, rt_int32_t timeout,
                       rt_uint32_t *recved);
```

- `set`ï¼šç­‰å¾…çš„äº‹ä»¶ä½æ©ç 
- `option`ï¼š
  - `RT_EVENT_FLAG_AND`ï¼šç­‰å¾…æ‰€æœ‰æŒ‡å®šäº‹ä»¶å‘ç”Ÿ
  - `RT_EVENT_FLAG_OR`ï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿ
  - `RT_EVENT_FLAG_CLEAR`ï¼šæ¥æ”¶åè‡ªåŠ¨æ¸…é›¶
- `timeout`ï¼šè¶…æ—¶æ—¶é—´ï¼ˆtickï¼‰
- `recved`ï¼šå®é™…æ¥æ”¶åˆ°çš„äº‹ä»¶ä½

------

5. æ‰§è¡Œæµç¨‹

1. è¿åŠ¨å‘˜çº¿ç¨‹å¯åŠ¨å¹¶é˜»å¡ï¼Œç­‰å¾… **bit1** å’Œ **bit2** åŒæ—¶å‡ºç°ã€‚
2. è£åˆ¤1 å»¶è¿Ÿ 500ms åå‘é€ bit1ï¼ˆå‡†å¤‡ä¿¡å·ï¼‰ã€‚
3. è£åˆ¤2 å»¶è¿Ÿ 1000ms åå‘é€ bit2ï¼ˆå¼€å§‹ä¿¡å·ï¼‰ã€‚
4. å½“ä¸¤ä¸ª bit å…¨éƒ¨ç½®ä½æ—¶ï¼Œ`rt_event_recv()` çš„ AND æ¨¡å¼æ¡ä»¶æ»¡è¶³ï¼Œè¿åŠ¨å‘˜çº¿ç¨‹è¢«å”¤é†’ã€‚
5. è¿åŠ¨å‘˜æ‰“å°â€œèµ·è·‘ï¼â€å¹¶ç»§ç»­æ‰§è¡Œã€‚

------

6. è¿è¡Œæ—¥å¿—ç¤ºä¾‹

```
è¿åŠ¨å‘˜: ç­‰å¾…è£åˆ¤çš„å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å· .
è£åˆ¤1: å‘é€å‡†å¤‡ä¿¡å·
è£åˆ¤2: å‘é€å¼€å§‹ä¿¡å·
è¿åŠ¨å‘˜: æ”¶åˆ°å‡†å¤‡ä¿¡å·å’Œå¼€å§‹ä¿¡å·ï¼Œå‡†å¤‡èµ·è·‘ï¼
```

------

7. æ€»ç»“

- **äº‹ä»¶é›†** å…è®¸çº¿ç¨‹åŒæ—¶ç­‰å¾…å¤šä¸ªæ¡ä»¶ï¼ˆANDï¼‰æˆ–ä»»ä¸€æ¡ä»¶ï¼ˆORï¼‰ã€‚
- æœ¬ä¾‹ä¸­ä½¿ç”¨ AND æ¨¡å¼å®ç°å¤šä¿¡å·åŒæ­¥ï¼Œç±»ä¼¼äºâ€œå¤šä¸ªå­ç³»ç»Ÿæ¡ä»¶å…¨éƒ¨æ»¡è¶³æ‰èƒ½å¯åŠ¨ä¸»ç³»ç»Ÿâ€ã€‚
- åœ¨åµŒå…¥å¼é¢†åŸŸï¼Œè¯¥æ¨¡å¼éå¸¸é€‚åˆï¼š
  - **å¤šä¼ æ„Ÿå™¨åŒæ­¥é‡‡é›†**
  - **å¤šæ¨¡å—åˆå§‹åŒ–å®Œæˆåˆ¤æ–­**
  - **å¤šä¸­æ–­æºå…±åŒè§¦å‘åŠ¨ä½œ**

------

ğŸ“Œ **è®°å¿†æ³•**ï¼š

> äº‹ä»¶é›†ä¸­çš„æ¯ä¸ª bit æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¿¡å·æºï¼Œ
>  RT_EVENT_FLAG_AND æ˜¯â€œå¿…é¡»å…¨éƒ¨äº®ç¯æ‰èƒ½èµ°â€ï¼Œ
>  RT_EVENT_FLAG_OR æ˜¯â€œä»»æ„äº®ä¸€ä¸ªç¯å°±èƒ½èµ°â€ã€‚



### æ€»ç»“

å¥½çš„ï¼Œæˆ‘æ˜ç™½ä½ æƒ³è¦çš„ä¸åªæ˜¯æ¦‚å¿µï¼Œè¿˜æƒ³çŸ¥é“ **äº‹ä»¶é›†åœ¨åµŒå…¥å¼é‡Œé¢çš„å®é™…ç”¨é€”**ï¼Œå¹¶ä¸”è¦æœ‰å…·ä½“å¯è”æƒ³åˆ°çš„åœºæ™¯ã€‚
 æˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ªå®ç”¨ç‰ˆçš„è®²è§£ï¼Œç»“åˆ **RT-Thread** äº‹ä»¶é›†åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­çš„å››ç±»å¸¸è§åº”ç”¨ï¼Œæ¯ä¸ªéƒ½é… **å…·ä½“ç¤ºä¾‹**ï¼Œè¿™æ ·ä½ ä»¥åå†™ç¨‹åºå°±èƒ½ç›´æ¥è¿ç§»æ€è·¯ã€‚

------

#### **1. ä»€ä¹ˆæ˜¯äº‹ä»¶é›†ï¼ˆç®€çŸ­å›é¡¾ï¼‰**

- **äº‹ä»¶é›†** å°±æ˜¯ç”¨ä¸€ä¸ª **32 ä½æ ‡å¿—å¯„å­˜å™¨**ï¼ˆå˜é‡ï¼‰ç®¡ç†å¤šç§â€œäº‹ä»¶å‘ç”ŸçŠ¶æ€â€ï¼Œæ¯ä¸ª bit è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„äº‹ä»¶ã€‚
- å¯ä»¥è®©ä¸€ä¸ªä»»åŠ¡åŒæ—¶ç­‰å¾…å¤šä¸ªäº‹ä»¶ï¼Œè€Œä¸”å¯ä»¥æŒ‡å®šæ˜¯ **æ»¡è¶³ä»»æ„ä¸€ä¸ªï¼ˆORï¼‰** è¿˜æ˜¯ **å¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼ˆANDï¼‰**ã€‚
- å…¸å‹ç‰¹ç‚¹ï¼š**å¤šäº‹ä»¶æ¡ä»¶è°ƒåº¦**ã€æ”¯æŒç»„åˆã€æ•ˆç‡é«˜ã€‚

------

#### **2. åµŒå…¥å¼ä¸­çš„å…¸å‹åº”ç”¨åœºæ™¯**

**åœºæ™¯ 1ï¼šå¤šå¤–è®¾çŠ¶æ€åŒæ­¥**

> **åº”ç”¨èƒŒæ™¯**ï¼š
>  åµŒå…¥å¼è®¾å¤‡ä¸Šé€šå¸¸ä¼šæœ‰å¤šä¸ªä¼ æ„Ÿå™¨/æ¥å£ï¼Œæ¯ä¸ªå¯èƒ½åœ¨ä¸åŒæ—¶åˆ»äº§ç”Ÿâ€œæ•°æ®å‡†å¤‡å¥½â€ä¿¡å·ï¼Œæ¯”å¦‚ä¸²å£æ”¶åˆ°æ•°æ®ã€æ¸©åº¦ä¼ æ„Ÿå™¨æ›´æ–°ã€æŒ‰é”®è§¦å‘ã€‚

**æ€ä¹ˆç”¨äº‹ä»¶é›†**ï¼š

- ç»™æ¯ä¸ªå¤–è®¾åˆ†é…ä¸€ä¸ª bit ä½ï¼š

  ```c
  #define EV_UART_RX   (1 << 0)  // ä¸²å£æœ‰æ•°æ®
  #define EV_TEMP_RDY  (1 << 1)  // æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°
  #define EV_BTN_PRESS (1 << 2)  // æŒ‰é”®è¢«æŒ‰ä¸‹
  ```

- å¤–è®¾é©±åŠ¨çš„ä¸­æ–­å›è°ƒé‡Œ `rt_event_send()` å¯¹åº”äº‹ä»¶ä½ã€‚

- ä¸»å¾ªç¯ä»»åŠ¡ `rt_event_recv()` ç­‰å¾…ä»»æ„ä¸€ä¸ªäº‹ä»¶ï¼š

  ```c
  rt_event_recv(evt, EV_UART_RX | EV_TEMP_RDY | EV_BTN_PRESS,
                RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR,
                RT_WAITING_FOREVER, &recved);
  if (recved & EV_UART_RX)   process_uart();
  if (recved & EV_TEMP_RDY)  process_temp();
  if (recved & EV_BTN_PRESS) process_button();
  ```

âœ… **å®é™…ä¾‹å­**ï¼šä¸€ä¸ªå·¥ä¸šæ§åˆ¶æ¿ï¼Œä¸²å£è´Ÿè´£æ¥æ”¶ä¸Šä½æœºæŒ‡ä»¤ï¼Œæ¸©åº¦é‡‡é›†å®šæ—¶æ›´æ–°ï¼ŒæŒ‰é”®ç”¨äºäººå·¥å¹²é¢„ï¼›äº‹ä»¶é›†èƒ½è®©ä¸€ä¸ªä»»åŠ¡ç»Ÿä¸€è°ƒåº¦ä¸‰ç§å¼‚æ­¥è¾“å…¥ï¼Œé™ä½èµ„æºå ç”¨ã€‚

------

**åœºæ™¯ 2ï¼šå¤æ‚å¯åŠ¨æ¡ä»¶**

> **åº”ç”¨èƒŒæ™¯**ï¼š
>  æœ‰äº›ä»»åŠ¡ **å¿…é¡»ç­‰å¤šä¸ªæ¡ä»¶éƒ½æ»¡è¶³** æ‰èƒ½è¿è¡Œï¼Œæ¯”å¦‚â€œåˆå§‹åŒ–å®Œæˆ + ç½‘ç»œè¿æ¥æˆåŠŸ + æˆæƒå¯†é’¥å·²è·å–â€ã€‚

**æ€ä¹ˆç”¨äº‹ä»¶é›†**ï¼š

- å®šä¹‰æ¡ä»¶ä½ï¼š

  ```c
  #define EV_INIT_OK   (1 << 0)
  #define EV_NET_OK    (1 << 1)
  #define EV_AUTH_OK   (1 << 2)
  ```

- å„ä¸ªå­ç³»ç»Ÿè´Ÿè´£åœ¨å‡†å¤‡å®Œæˆåå‘é€å¯¹åº”äº‹ä»¶ã€‚

- ç­‰å¾…ä»»åŠ¡ç”¨ AND æ¨¡å¼ï¼š

  ```c
  rt_event_recv(evt, EV_INIT_OK | EV_NET_OK | EV_AUTH_OK,
                RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR,
                RT_WAITING_FOREVER, &recved);
  // ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ‰ä¼šè¿è¡Œåˆ°è¿™é‡Œ
  start_main_service();
  ```

âœ… **å®é™…ä¾‹å­**ï¼šæ™ºèƒ½å®¶å±…ç½‘å…³åœ¨å¯åŠ¨åï¼Œå…ˆåŠ è½½é…ç½®ï¼ˆEV_INIT_OKï¼‰ï¼Œç„¶åè¿æ¥ç‰©è”ç½‘å¹³å°ï¼ˆEV_NET_OKï¼‰ï¼Œå†è¯·æ±‚æˆæƒTokenï¼ˆEV_AUTH_OKï¼‰ï¼›ä¸‰ä¸ªæ¡ä»¶éƒ½è¾¾æˆåå¯åŠ¨ä¸»ä¸šåŠ¡å¾ªç¯ã€‚

------

**åœºæ™¯ 3ï¼šå¤šä¸­æ–­æºçš„ç»Ÿä¸€ç®¡ç†**

> **åº”ç”¨èƒŒæ™¯**ï¼š
>  å¤šä¸ªå¤–éƒ¨ä¸­æ–­ï¼ˆGPIOï¼‰å¯èƒ½åŒæ—¶å­˜åœ¨ï¼Œä¾‹å¦‚å¤šä¸ªä¼ æ„Ÿå™¨çš„ä¸­æ–­å¼•è„šï¼Œå¯èƒ½ä¼šé¢‘ç¹è§¦å‘ï¼Œä½†ä½ åˆä¸æƒ³ç»™æ¯ä¸ªå»ºä¸€ä¸ªçº¿ç¨‹/ä¿¡å·é‡ã€‚

**æ€ä¹ˆç”¨äº‹ä»¶é›†**ï¼š

- æ¯ä¸ªä¸­æ–­æºåˆ†é…ä¸€ä¸ª bitï¼š

  ```c
  #define EV_SENSOR1_IRQ (1 << 0)
  #define EV_SENSOR2_IRQ (1 << 1)
  ```

- å„ä¸­æ–­å›è°ƒç›´æ¥ `rt_event_send()`ï¼Œæ ‡è®°å“ªä¸ªä¸­æ–­å‘ç”Ÿã€‚

- ä¸» ISR å¤„ç†ä»»åŠ¡ï¼š

  ```c
  while (1) {
      rt_uint32_t recved;
      rt_event_recv(evt, EV_SENSOR1_IRQ | EV_SENSOR2_IRQ,
                    RT_EVENT_FLAG_OR | RT_EVENT_FLAG_CLEAR,
                    RT_WAITING_FOREVER, &recved);
      if (recved & EV_SENSOR1_IRQ) handle_sensor1_irq();
      if (recved & EV_SENSOR2_IRQ) handle_sensor2_irq();
  }
  ```

âœ… **å®é™…ä¾‹å­**ï¼šæ™ºèƒ½æ‰‹è¡¨ IMUã€è§¦æ‘¸å±ã€å¿ƒç‡ä¼ æ„Ÿå™¨éƒ½ç”¨ç‹¬ç«‹ GPIO ä¸­æ–­ï¼Œä½†ç³»ç»Ÿé‡Œåªç”¨ä¸€ä¸ªäº‹ä»¶é›†æ¥è°ƒåº¦ï¼Œä¸éœ€è¦æ¯ä¸ªéƒ½é…ä¸€ä¸ªä¿¡å·é‡ã€‚

------

**åœºæ™¯ 4ï¼šæ•°æ®æµè½¬æ‰¹å¤„ç†**

> **åº”ç”¨èƒŒæ™¯**ï¼š
>  æœ‰äº›é«˜æ€§èƒ½ä»»åŠ¡éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªæ¥æºçš„æ•°æ®ï¼Œä¾‹å¦‚ç›¸æœº+éº¦å…‹é£ï¼Œå¿…é¡»ç­‰å›¾åƒå¸§å’ŒéŸ³é¢‘å¸§ **éƒ½åˆ°é½** æ‰èƒ½è¿›è¡Œèåˆå¤„ç†/ç¼–ç ã€‚

**æ€ä¹ˆç”¨äº‹ä»¶é›†**ï¼š

- å®šä¹‰ï¼š

  ```c
  #define EV_IMG_FRAME  (1 << 0)
  #define EV_AUD_FRAME  (1 << 1)
  ```

- ä¸¤ä¸ªé‡‡é›†ä»»åŠ¡å®Œæˆé‡‡é›†åå‘äº‹ä»¶ã€‚

- ç¼–ç ä»»åŠ¡ï¼š

  ```c
  rt_event_recv(evt, EV_IMG_FRAME | EV_AUD_FRAME,
                RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR,
                RT_WAITING_FOREVER, &recved);
  merge_and_encode();
  ```

âœ… **å®é™…ä¾‹å­**ï¼šåµŒå…¥å¼è§†é¢‘ä¼šè®®ç»ˆç«¯ï¼Œåªæœ‰è§†é¢‘å¸§å’ŒéŸ³é¢‘å¸§éƒ½å‡†å¤‡å¥½æ‰èƒ½ç¼–ç æˆåŒæ­¥çš„ AV æ•°æ®æµã€‚

------

#### **3. äº‹ä»¶é›† vs ä¿¡å·é‡/äº’æ–¥é‡**

| åŠŸèƒ½           | ä¿¡å·é‡        | äº’æ–¥é‡       | äº‹ä»¶é›†          |
| -------------- | ------------- | ------------ | --------------- |
| å¤šäº‹ä»¶çŠ¶æ€ç®¡ç† | âŒ             | âŒ            | âœ…ï¼ˆ32ä¸ªbitï¼‰    |
| ç­‰å¾…å¤šä¸ªæ¡ä»¶   | âŒ             | âŒ            | âœ…ï¼ˆAND/ORæ¨¡å¼ï¼‰ |
| ä¼˜å…ˆçº§è°ƒåº¦     | âœ…             | âœ…            | âœ…               |
| ç”¨é€”           | åŒæ­¥/èµ„æºè®¡æ•° | ç‹¬å èµ„æºä¿æŠ¤ | å¤šäº‹ä»¶åŒæ­¥è°ƒåº¦  |

ğŸ“Œ ç»“è®º:

- äº‹ä»¶é›†é€‚åˆ**ä¸€ä¸ªçº¿ç¨‹éœ€è¦å“åº”å¤šä¸ªå¼‚æ­¥æ¥æº**çš„åœºæ™¯ï¼Œä¸ç”¨å¼€å¾ˆå¤šä¿¡å·é‡ã€‚
- èƒ½æ”¯æŒå¤æ‚æ¡ä»¶åˆ¤æ–­ï¼ˆAND/ORï¼‰ï¼Œæ›´çµæ´»ã€‚

------

#### **4. æœ€ç²¾ç‚¼çš„è®°å¿†æ³•ï¼š**

> **ä¿¡å·é‡** æ˜¯å•äº‹ä»¶çš„â€œé—¨ç¥¨â€ï¼Œ
>  **äº’æ–¥é‡** æ˜¯ç‹¬å èµ„æºçš„â€œé’¥åŒ™â€ï¼Œ
>  **äº‹ä»¶é›†** æ˜¯è®°å½• 32 ä¸ªäº‹ä»¶çš„â€œå…¬å‘Šç‰Œâ€ã€‚

------





## çº¿ç¨‹é—´é€šä¿¡



### é‚®ç®±--é€šä¿¡

1.ä»£ç 

```
#include <rtthread.h>

/* åˆ›å»ºé‚®ç®± */
rt_mailbox_t mb;

/* çº¿ç¨‹1ï¼šå‘é€é‚®ä»¶ */
void thread_entry1(void *parameter)
{
    char msg = 'A'; // å‘é€å­—æ¯'A'ä½œä¸ºé‚®ä»¶
    rt_kprintf("çº¿ç¨‹1ï¼šå‘é€é‚®ä»¶ .\n");
    rt_mb_send(mb, (rt_uint32_t)msg); // å‘é€é‚®ä»¶
}

/* çº¿ç¨‹2ï¼šæ¥æ”¶é‚®ä»¶ */
void thread_entry2(void *parameter)
{
    char msg;
    rt_kprintf("çº¿ç¨‹2ï¼šç­‰å¾…æ¥æ”¶é‚®ä»¶ .\n");
    rt_mb_recv(mb, (rt_uint32_t*)&msg, RT_WAITING_FOREVER); // æ¥æ”¶é‚®ä»¶
    rt_kprintf("çº¿ç¨‹2ï¼šæ”¶åˆ°é‚®ä»¶ï¼š%c\n", msg); // æ‰“å°æ”¶åˆ°çš„é‚®ä»¶å†…å®¹
}

int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º4çš„é‚®ç®± */
    mb = rt_mb_create("mb", 4, RT_IPC_FLAG_PRIO);
    /* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
    rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 10,10);
    rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 10,10);
    /* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);
    return 0;
}
```

2.ç°è±¡

![image-20250922145708091](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922145708091.png)

3.æ€»ç»“

RT-Thread é‚®ç®±ï¼ˆrt_mailbox_tï¼‰ä½¿ç”¨è¯´æ˜

1. æ¦‚å¿µ

`rt_mailbox_t` æ˜¯ RT-Thread å®æ—¶æ“ä½œç³»ç»Ÿä¸­ç”¨æ¥è¡¨ç¤ºé‚®ç®±å¯¹è±¡çš„å¥æŸ„ã€‚
 **é‚®ç®±ï¼ˆMailboxï¼‰** æ˜¯ä¸€ç§çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œç”¨äºä¼ é€’å›ºå®šå¤§å°çš„æ¶ˆæ¯ï¼ˆä¸€ä¸ª `rt_ubase_t` ç±»å‹çš„æ•°å€¼ï¼Œé€šå¸¸æ˜¯æŒ‡é’ˆæˆ–æ•´æ•°ï¼‰ï¼Œè€Œä¸æ˜¯æ•´æ®µæ•°æ®ç¼“å†²åŒºã€‚

ç‰¹ç‚¹ï¼š

- å®šé•¿æ¶ˆæ¯ï¼ˆä¸€ä¸ª `rt_ubase_t`ï¼‰
- æŒ‰ FIFO æˆ–çº¿ç¨‹ä¼˜å…ˆçº§é¡ºåºæ¥æ”¶
- æ”¯æŒé˜»å¡å’Œè¶…æ—¶ç­‰å¾…
- å¸¸ç”¨äºäº‹ä»¶é€šçŸ¥ã€ä¿¡å·ä¼ é€’ç­‰åœºæ™¯

------

2. å¸¸ç”¨ API

2.1 åˆ›å»ºä¸åˆå§‹åŒ–

```c
/* åŠ¨æ€åˆ›å»º */
rt_mailbox_t rt_mb_create(const char *name,
                          rt_size_t   size,
                          rt_uint8_t  flag);

/* é™æ€åˆå§‹åŒ– */
rt_err_t rt_mb_init(struct rt_mailbox *mb,
                    const char        *name,
                    void              *msgpool,
                    rt_size_t          size,
                    rt_uint8_t         flag);
```

- `size`ï¼šé‚®ç®±å®¹é‡ï¼ˆä»¥æ¶ˆæ¯ä¸ªæ•°ä¸ºå•ä½ï¼‰
- `flag`ï¼š
  - `RT_IPC_FLAG_FIFO` æŒ‰å…ˆè¿›å…ˆå‡ºé¡ºåº
  - `RT_IPC_FLAG_PRIO` æŒ‰çº¿ç¨‹ä¼˜å…ˆçº§é¡ºåº

------

2.2 åˆ é™¤ä¸è„±ç¦»

```c
/* åŠ¨æ€åˆ›å»ºå¯¹è±¡é”€æ¯ */
rt_err_t rt_mb_delete(rt_mailbox_t mb);

/* é™æ€åˆå§‹åŒ–å¯¹è±¡è„±ç¦»ç³»ç»Ÿç®¡ç† */
rt_err_t rt_mb_detach(struct rt_mailbox *mb);
```

------

2.3 å‘é€æ¶ˆæ¯

```c
/* ç«‹å³å‘é€ï¼Œä¸å¯ç”¨ç©ºé—´æ—¶è¿”å› -RT_EFULL */
rt_err_t rt_mb_send(rt_mailbox_t mb, rt_ubase_t value);

/* å¯ç­‰å¾…çš„å‘é€ï¼Œç­‰å¾…ç©ºé—´é‡Šæ”¾ */
rt_err_t rt_mb_send_wait(rt_mailbox_t mb,
                         rt_ubase_t   value,
                         rt_int32_t   timeout);
```

------

2.4 æ¥æ”¶æ¶ˆæ¯

```c
/* æ¥æ”¶æ¶ˆæ¯ï¼Œå¯è®¾ç½®ç­‰å¾…æ—¶é—´ */
rt_err_t rt_mb_recv(rt_mailbox_t mb,
                    rt_ubase_t  *value,
                    rt_int32_t   timeout);
```

- `timeout`ï¼š

  - `RT_WAITING_FOREVER` æ°¸ä¹…é˜»å¡ç­‰å¾…

  - `0` éé˜»å¡

  - > 0 ç­‰å¾…çš„ tick æ•°

è¿”å›å€¼ï¼š

- `RT_EOK` æˆåŠŸ
- `-RT_ETIMEOUT` è¶…æ—¶
- `-RT_ERROR` å…¶ä»–é”™è¯¯

------

3. ç¤ºä¾‹ä»£ç 

```c
#include <rtthread.h>

/* åˆ›å»ºé‚®ç®±å¥æŸ„ */
rt_mailbox_t mb;

/* çº¿ç¨‹1ï¼šå‘é€é‚®ä»¶ */
void thread_entry1(void *parameter)
{
    char msg = 'A';
    rt_kprintf("çº¿ç¨‹1ï¼šå‘é€é‚®ä»¶.\n");
    rt_mb_send(mb, (rt_uint32_t)msg);
}

/* çº¿ç¨‹2ï¼šæ¥æ”¶é‚®ä»¶ */
void thread_entry2(void *parameter)
{
    char msg;
    rt_kprintf("çº¿ç¨‹2ï¼šç­‰å¾…æ¥æ”¶é‚®ä»¶.\n");
    rt_mb_recv(mb, (rt_uint32_t*)&msg, RT_WAITING_FOREVER);
    rt_kprintf("çº¿ç¨‹2ï¼šæ”¶åˆ°é‚®ä»¶ï¼š%c\n", msg);
}

int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º4çš„é‚®ç®± */
    mb = rt_mb_create("mb", 4, RT_IPC_FLAG_PRIO);

    /* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
    rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 10, 10);
    rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 10, 10);

    /* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);

    return 0;
}
```

------

4. ä½¿ç”¨è¯´æ˜

- é‚®ç®±ä¸­æ¯æ¡æ¶ˆæ¯å ç”¨ä¸€ä¸ª `rt_ubase_t` å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤å®¹é‡å‚æ•°æ˜¯â€œæ¡ç›®æ•°â€è€Œä¸æ˜¯å­—èŠ‚æ•°ã€‚
- `rt_mb_send` åœ¨é‚®ç®±æ»¡æ—¶ç«‹å³è¿”å›é”™è¯¯ï¼Œä¸ç­‰å¾…ã€‚
- `rt_mb_send_wait` å¯åœ¨é‚®ç®±æ»¡æ—¶é˜»å¡ç­‰å¾…ç©ºä½ï¼Œç›´è‡³æˆåŠŸæˆ–è¶…æ—¶ã€‚
- å¸¸ç”¨äº ISR -> çº¿ç¨‹ æˆ– çº¿ç¨‹ -> çº¿ç¨‹ çš„äº‹ä»¶ä¼ é€’ã€‚

------

5. æ€»ç»“

`rt_mailbox_t` æ˜¯ RT-Thread ä¸ºçº¿ç¨‹é—´æä¾›çš„ä¸€ç§é«˜æ•ˆäº‹ä»¶é€šçŸ¥æœºåˆ¶ã€‚é…åˆå‘é€/æ¥æ”¶ APIï¼Œå¯ä»¥åœ¨ä¸åŒçº¿ç¨‹é—´å®ç°ç®€å•çš„æ•°å€¼æˆ–æŒ‡é’ˆä¼ é€’ï¼Œå¹¿æ³›ç”¨äºä»»åŠ¡é—´çš„åŒæ­¥ä¸è°ƒåº¦ã€‚





### æ¶ˆæ¯é˜Ÿåˆ—--é€šä¿¡

1.ä»£ç 

```
#include <rtthread.h>

/* åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— */
rt_mq_t mq;

/* çº¿ç¨‹1ï¼šå‘é€æ¶ˆæ¯ */
void thread_entry1(void *parameter)
{
    char msg[] = "Hello, RT-Thread!"; // å‘é€ä¸€æ¡æ¶ˆæ¯
    rt_kprintf("çº¿ç¨‹1ï¼šå‘é€æ¶ˆæ¯ .\n");
    rt_mq_send(mq, msg, sizeof(msg)); // å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
}

/* çº¿ç¨‹2ï¼šæ¥æ”¶æ¶ˆæ¯ */
void thread_entry2(void *parameter)
{
    char buffer[32];
    rt_kprintf("çº¿ç¨‹2ï¼šç­‰å¾…æ¥æ”¶æ¶ˆæ¯ .\n");
    rt_mq_recv(mq, buffer, sizeof(buffer), RT_WAITING_FOREVER); // æ¥æ”¶æ¶ˆæ¯
    rt_kprintf("çº¿ç¨‹2ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼š%s\n", buffer); // æ‰“å°æ”¶åˆ°çš„æ¶ˆæ¯
}
int main(void)
{
	/* åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®¹é‡ä¸º4ï¼Œæ¶ˆæ¯å¤§å°ä¸º32å­—èŠ‚ */
	mq = rt_mq_create("mq", 32, 4, RT_IPC_FLAG_PRIO);
	/* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
    rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 10,10);
    rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 10,10);
	/* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);
    return 0;
}
```

2.ç°è±¡

![image-20250922151554947](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922151554947.png)

3.æ€»ç»“

RT-Thread æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨è¯´æ˜

1. æ¦‚å¿µ

åœ¨ RT-Thread ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue, `rt_mq_t`ï¼‰æ˜¯ä¸€ç§çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œç”¨æ¥åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’**å®šé•¿çš„æ•°æ®å—**ã€‚ä¸é‚®ç®±ï¼ˆMailboxï¼‰åªèƒ½ä¼ é€’ä¸€ä¸ªæœºå™¨å­—ï¼ˆ`rt_ubase_t`ï¼‰çš„æ•°æ®ä¸åŒï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ä¼ é€’ä»»æ„é•¿åº¦çš„æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯çš„é•¿åº¦åœ¨æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºæ—¶å›ºå®šã€‚

ç‰¹ç‚¹ï¼š

- æ”¯æŒ FIFO æˆ–æŒ‰çº¿ç¨‹ä¼˜å…ˆçº§æ’åºçš„æ¥æ”¶æ¨¡å¼
- é˜Ÿåˆ—å®¹é‡å›ºå®šï¼Œç”±åˆ›å»ºæ—¶æŒ‡å®šçš„â€œå•æ¡æ¶ˆæ¯å¤§å°â€å’Œâ€œæ•°é‡â€å†³å®š
- æ”¯æŒé˜»å¡ã€è¶…æ—¶å’Œéé˜»å¡æ”¶å‘
- æ—¢å¯ä»¥åœ¨çº¿ç¨‹é—´ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ä¸­æ–­ä¸çº¿ç¨‹ä¹‹é—´

------

2. å¸¸ç”¨ API

2.1 åˆ›å»ºä¸åˆå§‹åŒ–

```c
/* åŠ¨æ€åˆ›å»º */
rt_mq_t rt_mq_create(const char *name,
                     rt_size_t   msg_size,
                     rt_size_t   max_msgs,
                     rt_uint8_t  flag);

/* é™æ€åˆå§‹åŒ– */
rt_err_t rt_mq_init(struct rt_messagequeue *mq,
                    const char *name,
                    void       *msgpool,
                    rt_size_t   msg_size,
                    rt_size_t   pool_size,
                    rt_uint8_t  flag);
```

- `msg_size`  å•æ¡æ¶ˆæ¯çš„å­—èŠ‚æ•°
- `max_msgs`  é˜Ÿåˆ—å¯å®¹çº³çš„æ¶ˆæ¯æ•°é‡ï¼ˆåŠ¨æ€åˆ›å»ºæ—¶æŒ‡å®šï¼‰
- `msgpool` + `pool_size` æŒ‡å®šé™æ€ç¼“å†²åŒº
- `flag`ï¼š`RT_IPC_FLAG_FIFO`ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ã€`RT_IPC_FLAG_PRIO`ï¼ˆä¼˜å…ˆçº§ï¼‰

------

2.2 åˆ é™¤ä¸è„±ç¦»

```c
/* åˆ é™¤åŠ¨æ€åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ— */
rt_err_t rt_mq_delete(rt_mq_t mq);

/* å°†é™æ€åˆå§‹åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ä»å†…æ ¸å¯¹è±¡ä¸­è„±ç¦» */
rt_err_t rt_mq_detach(struct rt_messagequeue *mq);
```

------

2.3 å‘é€æ¶ˆæ¯

```c
/* ç«‹å³å‘é€æ¶ˆæ¯ */
rt_err_t rt_mq_send(rt_mq_t mq, const void *buffer, rt_size_t size);

/* å¸¦ç­‰å¾…çš„å‘é€ */
rt_err_t rt_mq_urgent(rt_mq_t mq, const void *buffer, rt_size_t size);
```

- `rt_mq_send` å°†æ¶ˆæ¯æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œé˜Ÿåˆ—æ»¡åˆ™è¿”å› `-RT_EFULL`
- `rt_mq_urgent` å°†æ¶ˆæ¯æ’åˆ°é˜Ÿåˆ—å¤´éƒ¨ï¼ˆç´§æ€¥æ¶ˆæ¯ï¼‰

------

2.4 æ¥æ”¶æ¶ˆæ¯

```c
rt_err_t rt_mq_recv(rt_mq_t mq,
                    void   *buffer,
                    rt_size_t size,
                    rt_int32_t timeout);
```

- `timeout`ï¼š

  - `RT_WAITING_FOREVER` æ°¸ä¹…é˜»å¡

  - `0` éé˜»å¡

  - > 0 ç­‰å¾…çš„ç³»ç»Ÿ tick æ•°

- æˆåŠŸè¿”å› `RT_EOK`ï¼Œè¶…æ—¶è¿”å› `-RT_ETIMEOUT`

------

3. ç¤ºä¾‹ä»£ç 

```c
#include <rtthread.h>

/* åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—å¥æŸ„ */
rt_mq_t mq;

/* çº¿ç¨‹1ï¼šå‘é€æ¶ˆæ¯ */
void thread_entry1(void *parameter)
{
    char msg[] = "Hello, RT-Thread!";
    rt_kprintf("çº¿ç¨‹1ï¼šå‘é€æ¶ˆæ¯ .\n");
    rt_mq_send(mq, msg, sizeof(msg));
}

/* çº¿ç¨‹2ï¼šæ¥æ”¶æ¶ˆæ¯ */
void thread_entry2(void *parameter)
{
    char buffer[32];
    rt_kprintf("çº¿ç¨‹2ï¼šç­‰å¾…æ¥æ”¶æ¶ˆæ¯ .\n");
    rt_mq_recv(mq, buffer, sizeof(buffer), RT_WAITING_FOREVER);
    rt_kprintf("çº¿ç¨‹2ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼š%s\n", buffer);
}

int main(void)
{
    /* åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼šå•æ¡32å­—èŠ‚ï¼Œæœ€å¤š4æ¡æ¶ˆæ¯ */
    mq = rt_mq_create("mq", 32, 4, RT_IPC_FLAG_PRIO);

    /* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ */
    rt_thread_t tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 10, 10);
    rt_thread_t tid2 = rt_thread_create("t2", thread_entry2, RT_NULL, 1024, 10, 10);

    /* å¯åŠ¨çº¿ç¨‹ */
    rt_thread_startup(tid1);
    rt_thread_startup(tid2);

    return 0;
}
```

------

4. ä½¿ç”¨æ³¨æ„äº‹é¡¹

- æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²åŒºå®¹é‡ = `msg_size * max_msgs`
- å½“å‘é€æ•°æ®é•¿åº¦è¶…è¿‡ `msg_size` æ—¶ä¼šè¢«æˆªæ–­
- åœ¨ä¸­æ–­ä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—éœ€è¦è°ƒç”¨å¯¹åº”çš„ **ISR å®‰å…¨ API**ï¼ˆéœ€æ£€æŸ¥æ–‡æ¡£ï¼‰
- FIFO æ¨¡å¼èƒ½ä¿è¯ä¸¥æ ¼æŒ‰å‘é€é¡ºåºæ¥æ”¶ï¼›PRIO æ¨¡å¼èƒ½è®©é«˜ä¼˜å…ˆçº§çº¿ç¨‹å…ˆæ¥æ”¶
- é˜»å¡ç­‰å¾…æ—¶ï¼Œéœ€ç¡®ä¿æœ‰å…¶ä»–çº¿ç¨‹/ä¸­æ–­å‘é€æ¶ˆæ¯ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡

------

5. æ€»ç»“

- **æ¶ˆæ¯é˜Ÿåˆ—**é€‚åˆä¼ é€’ç»“æ„åŒ–æˆ–è¾ƒé•¿çš„æ•°æ®ï¼ŒåŠŸèƒ½æ¯”é‚®ç®±æ›´çµæ´»
- **é‚®ç®±**é€‚åˆä¼ é€’ä¸€ä¸ªæŒ‡é’ˆæˆ–äº‹ä»¶æ ‡å¿—ï¼Œæ•ˆç‡è¾ƒé«˜
- æ ¹æ®é€šä¿¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ IPC æœºåˆ¶ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿå®æ—¶æ€§ä¸èµ„æºä½¿ç”¨æ•ˆç‡





### ä¿¡å·--é€šä¿¡

1.ä»£ç 

```
#include <rtthread.h>
static rt_thread_t tid1;

/* çº¿ç¨‹1çš„ä¿¡å·å¤„ç†å‡½æ•° */
void thread_signal_handler(int signo)
{
    rt_kprintf("çº¿ç¨‹1æ¥æ”¶åˆ°ä¿¡å· %d\n", signo);
}

/* çº¿ç¨‹1ï¼šå®‰è£…ä¿¡å·å¹¶ç­‰å¾…å¤„ç†ä¿¡å· */
void thread_entry1(void *parameter)
{
    rt_signal_install(SIGUSR1, thread_signal_handler); // å®‰è£…ä¿¡å·å¤„ç†å‡½æ•°
    rt_signal_unmask(SIGUSR1); // è§£é™¤ä¿¡å·é˜»å¡
    rt_kprintf("çº¿ç¨‹1ï¼šç­‰å¾…æ¥æ”¶ä¿¡å· .\n");
   	 	while (1)
    {
    	rt_thread_mdelay(1000); // æ¨¡æ‹Ÿçº¿ç¨‹æ­£å¸¸æ‰§è¡Œ
    }
}
int main(void)
{
	/* åˆ›å»ºçº¿ç¨‹1 */
    tid1 = rt_thread_create("t1", thread_entry1, RT_NULL, 1024, 10, 10);
    rt_thread_startup(tid1);
    /* å‘é€ä¿¡å·ç»™çº¿ç¨‹1 */
    rt_thread_mdelay(2000);
    rt_thread_kill(tid1, SIGUSR1); // å‘é€ä¿¡å·
    return 0;
}
```











## è£¸æœºå¼€å‘ç§»æ¤RT-Thread

### 1.ledç§»æ¤

1.æ–°å»º`led_app.c`å’Œ`led_app.h`ï¼Œå¹¶ä¸”åˆ›å»º`bsp_system.h`æ¥åŒ…å«æ‰€æœ‰çš„å¤´æ–‡ä»¶

![image-20250922192749785](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922192749785.png)

2.æ¡†æ¶æ­å»º

![image-20250922192848702](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922192848702.png)

![image-20250922192927058](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922192927058.png)

![image-20250922193032753](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250922193032753.png)

ä»£ç 

```
#include <led_app.h>

#define LED_PIN_BASE GET_PIN(D,8) //ledåŸºåœ°å€ï¼Œç¬¬ä¸€ä¸ªled

uint8_t ucLed[6] = {1,0,1,0,1,0}; //åˆå§‹ledæ•°ç»„
// rt_mutex_t ucled_mutex = RT_NULL;

void led_disp(uint8_t *ucLed)
{
    uint8_t temp = 0x00;
    static uint8_t  temp_old = 0xff;

//    rt_mutex_take(ucled_mutex, RT_WAITING_FOREVER); // åŠ é”
    for(int i = 0;i < 6;i++)
    {
        temp |= (ucLed[i] << i);
    }
//    rt_mutex_release(ucled_mutex);                 // è§£é”


    if(temp != temp_old)
    {
        for(int i = 0;i < 6;i++)
        {
             if((temp >> i) & 0x01)
            {
                rt_pin_write(LED_PIN_BASE + i , PIN_LOW);//ä½ç”µå¹³ç‚¹äº®ï¼Œå¦‚æœæ˜¯1ï¼Œä»£è¡¨ç‚¹äº®
            }
             else
            {
                rt_pin_write(LED_PIN_BASE + i , PIN_HIGH);
            }
        }
       temp_old = temp;
    }
}

void led_proc(void *parameter)
{
    while(1)
    {
        led_disp(ucLed);
        rt_thread_delay(1); //è®©å‡ºcpu,ç©ºé—²
    }
}

éœ€è¦æ³¨æ„ï¼Œåˆå§‹åŒ–åªæ˜¯åˆå§‹åŒ–æ¥å£ä»¥åŠåˆ›å»ºçº¿ç¨‹
void led_init(void)
{
//    ucled_mutex = rt_mutex_create("led_lock", RT_IPC_FLAG_PRIO);
//    if (ucled_mutex == RT_NULL)
//    {
//        rt_kprintf("create mutex failed!\n");
//    }
//    else         rt_kprintf("create mutex success!\n");



    for(int i = 0; i < 6; i++)
    {
        rt_pin_mode(LED_PIN_BASE + i, PIN_MODE_OUTPUT);
    }

    rt_thread_t led_thread = rt_thread_create("led_proc",
                                               led_proc, //çº¿ç¨‹å…¥å£å‡½æ•°
                                               RT_NULL, //çº¿ç¨‹å…¥å£å‚æ•°
                                               1024,    //å †æ ˆå¤§å°
                                               10,      //çº¿ç¨‹ä¼˜å…ˆçº§
                                               10);      //æ—¶é—´ç‰‡å¤§å°
    if(led_thread != RT_NULL)
    {
        rt_thread_startup(led_thread);
    }
}

```

ä¸»å‡½æ•°åˆå§‹åŒ–

![image-20250924170855031](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250924170855031.png)





### 2.keyç§»æ¤

1.åˆå§‹åŒ–æŒ‰é”®å¼•è„š

![image-20250924171117112](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250924171117112.png)

2.æŒ‰é”®è¯»å–å‡½æ•°

![image-20250924171129362](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250924171129362.png)

3.æŒ‰é”®é€»è¾‘å‡½æ•°

![image-20250924172130263](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250924172130263.png)

4.åˆå§‹åŒ–å¼•è„š && åˆ›å»ºçº¿ç¨‹

![image-20250924172147654](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250924172147654.png)





### 3.åœ¨æŒ‰é”®ä¸­å®ç°é©±åŠ¨LED--æ¶‰åŠåˆ°çš„èµ„æºæŠ¢å é—®é¢˜

å¦‚å›¾ï¼Œå½“æƒ³è¦åœ¨æŒ‰é”®é€»è¾‘ä¸­å®ç°æŒ‰é”®æ§åˆ¶ledå–åï¼Œä¼šæ¶‰åŠåˆ°ä¸€ä¸ªèµ„æºæŠ¢å é—®é¢˜ï¼Œå³led_app.cå’Œkey_app.cè¿™ä¸¤ä¸ªé‡Œé¢ï¼Œä¼šåŒæ—¶ä¿®æ”¹ucLed[0]çš„å€¼ï¼Œå¯¼è‡´ucLed[0]ä¸çŸ¥é“è¯¥è¯»å“ªä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ç”¨åˆ°æˆ‘ä»¬ä¹‹å‰è§£å†³èµ„æºæŠ¢å çš„æ–¹æ³•æ¥è§£å†³ï¼Œä¾‹å¦‚ä¿¡å·é‡ï¼Œäº’æ–¥é‡ï¼Œäº‹ä»¶é›†ï¼Œæœ¬ä¾‹ä¸­é€‚åˆç”¨äº’æ–¥é‡ï¼Œä¸€ä¸ªæ­£åœ¨ä¿®æ”¹Ledçš„å€¼ï¼ŒåŠ äº†é”ä¹‹åï¼Œå¦ä¸€ä¸ªåªèƒ½ç­‰å¾…ï¼Œç›´åˆ°è§£é”ã€‚

![image-20250925105929643](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925105929643.png)

â€‹			ï¼ˆæœ¬å›¾ä¸­æ˜¯é”™è¯¯ä¾‹å­ï¼Œå¦‚æœæ²¡æœ‰åŠ é”ï¼Œæ— æ³•å®ç°æŒ‰é”®å–åledï¼‰



#### æ­£ç¡®ç¤ºä¾‹

1.åˆå§‹åŒ–äº’æ–¥é‡ï¼ˆåœ¨led_app.cä¸­ï¼‰

![image-20250925110300559](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925110300559.png)

2.åŠ é”

![image-20250925110610241](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925110610241.png)

![image-20250925110629856](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925110629856.png)

3.å¤–éƒ¨å£°æ˜ucLedæ•°ç»„ï¼Œå£°æ˜é”ï¼Œå¯ä»¥ä¾›ç»™key_app.cä½¿ç”¨

![image-20250925110825274](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925110825274.png)

4.åœ¨key_app.cé‡Œé¢

![image-20250925111016793](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20250925111016793.png)







### 3.oledx0.91å¯¸ç§»æ¤

**OLED (SSD1306) ç§»æ¤åˆ° RT-Thread å®Œæ•´æŒ‡å—**

**ğŸ“‹ æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•å°† OLED (SSD1306) æ˜¾ç¤ºå±åº“ä» STM32 HAL åº“ç§»æ¤åˆ° RT-Thread æ“ä½œç³»ç»Ÿã€‚

**ğŸ¯ ç§»æ¤ç›®æ ‡**

- å°†åŸºäº STM32 HAL åº“çš„ OLED é©±åŠ¨ç§»æ¤åˆ° RT-Thread
- ä¿æŒåŸæœ‰çš„æ˜¾ç¤ºåŠŸèƒ½å’Œ API æ¥å£
- æ·»åŠ  RT-Thread åº”ç”¨å±‚å°è£…
- æ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ OLED æ˜¾ç¤º

ğŸ”§ ç¡¬ä»¶ç¯å¢ƒ

- **MCU**: STM32F429VET6
- **OLED**: 0.91å¯¸ SSD1306 (I2Cæ¥å£)
- **è¿æ¥æ–¹å¼**:
  ```
  OLED    â†’    STM32F429VET6
  VCC     â†’    3.3V
  GND     â†’    GND
  SDA     â†’    PB9 (I2C1_SDA)
  SCL     â†’    PB8 (I2C1_SCL)
  ```

**ğŸ“ æ–‡ä»¶ç»“æ„**

ç§»æ¤å®Œæˆåçš„æ–‡ä»¶ç»“æ„ï¼š
```
applications/
â”œâ”€â”€ rt_oled.h          # OLED é©±åŠ¨å±‚å¤´æ–‡ä»¶
â”œâ”€â”€ rt_oled.c          # OLED é©±åŠ¨å±‚å®ç°
â”œâ”€â”€ oledfont.h         # å­—ä½“åº“æ–‡ä»¶
â”œâ”€â”€ oled_app.h         # OLED åº”ç”¨å±‚å¤´æ–‡ä»¶
â”œâ”€â”€ oled_app.c         # OLED åº”ç”¨å±‚å®ç°
â””â”€â”€ oled_final_test.c  # æµ‹è¯•å’Œè¯Šæ–­å·¥å…·
```

**ğŸš€ ç§»æ¤æ­¥éª¤**

æ­¥éª¤ 1: å‡†å¤‡åŸå§‹æ–‡ä»¶

å°†åŸå§‹çš„ OLED åº“æ–‡ä»¶æ”¾å…¥ `uploads` æ–‡ä»¶å¤¹ï¼š
- `oled.h` - åŸå§‹å¤´æ–‡ä»¶
- `oled.c` - åŸå§‹å®ç°æ–‡ä»¶
- `oledfont.h` - å­—ä½“åº“
- `oledpic.h` - å›¾ç‰‡åº“ï¼ˆå¯é€‰ï¼‰

**æ­¥éª¤ 2: åˆ›å»º RT-Thread é©±åŠ¨å±‚**

2.1 åˆ›å»º `rt_oled.h`

```c
#ifndef __RT_OLED_H__
#define __RT_OLED_H__

#include <rtthread.h>
#include "stm32f4xx_hal.h"

/* OLED è®¾å¤‡åœ°å€ */
#define OLED_ADDR 0x78

/* OLED å°ºå¯¸å®šä¹‰ */
#define OLED_WIDTH  128
#define OLED_HEIGHT 32

/* å‡½æ•°å£°æ˜ */
rt_err_t rt_oled_init(void);
void rt_oled_clear(void);
void rt_oled_show_str(rt_uint8_t x, rt_uint8_t y, char *ch, rt_uint8_t fontsize);
void rt_oled_show_num(rt_uint8_t x, rt_uint8_t y, rt_uint32_t num, rt_uint8_t length, rt_uint8_t fontsize);
void rt_oled_show_char(rt_uint8_t x, rt_uint8_t y, rt_uint8_t ch, rt_uint8_t fontsize);
void rt_oled_set_position(rt_uint8_t x, rt_uint8_t y);
void rt_oled_display_on(void);
void rt_oled_display_off(void);

#endif
```

**2.2 åˆ›å»º `rt_oled.c`**

å…³é”®ä¿®æ”¹ç‚¹ï¼š
1. **æ›¿æ¢å»¶æ—¶å‡½æ•°**: `HAL_Delay()` â†’ `rt_thread_mdelay()`
2. **ä¿æŒ I2C é€šä¿¡**: ç»§ç»­ä½¿ç”¨ `HAL_I2C_Mem_Write()`
3. **æ·»åŠ  RT-Thread å¤´æ–‡ä»¶**: `#include <rtthread.h>`

```c
#include "rt_oled.h"
#include "oledfont.h"

extern I2C_HandleTypeDef hi2c1;

// ä¿æŒåŸæœ‰çš„æ˜¾ç¤ºå‡½æ•°ï¼Œåªéœ€ä¿®æ”¹å»¶æ—¶è°ƒç”¨
rt_err_t rt_oled_init(void)
{
    rt_thread_mdelay(100);  // æ›¿æ¢ HAL_Delay(100)
    
    // åŸæœ‰çš„åˆå§‹åŒ–åºåˆ—...
    rt_kprintf("OLED initialized successfully\n");
    return RT_EOK;
}
```

**æ­¥éª¤ 3: åˆ›å»ºåº”ç”¨å±‚**

3.1 åˆ›å»º `oled_app.h`

```c
#ifndef __OLED_APP_H__
#define __OLED_APP_H__

#include <bsp_system.h>

/* å‡½æ•°å£°æ˜ */
void oled_init(void);

#endif
```

3.2 åˆ›å»º `oled_app.c`

```c
#include <oled_app.h>
#include <rt_oled.h>

static rt_thread_t oled_thread = RT_NULL;

static void oled_proc(void *parameter)
{
    rt_uint32_t count = 0;
    
    while (1)
    {
        rt_oled_clear();
        rt_oled_show_str(0, 0, "RT-Thread", 16);
        rt_oled_show_num(0, 2, count++, 5, 16);
        
        rt_thread_mdelay(100);
    }
}

void oled_init(void)
{
    /* åˆå§‹åŒ– OLED ç¡¬ä»¶ */
    rt_oled_init();
    
    /* åˆ›å»º OLED æ˜¾ç¤ºçº¿ç¨‹ */
    oled_thread = rt_thread_create("oled", oled_proc, RT_NULL, 
                                   1024, 15, 20);
    if (oled_thread != RT_NULL)
    {
        rt_thread_startup(oled_thread);
        rt_kprintf("OLED thread created successfully\n");
    }
}
```

**æ­¥éª¤ 4: é…ç½® I2C ç¡¬ä»¶**

4.1 ç¡®å®šæ­£ç¡®çš„ I2C å¼•è„š

**é‡è¦**: å¿…é¡»ç¡®å®š OLED å®é™…è¿æ¥çš„ I2C å¼•è„šï¼

STM32F429 çš„ I2C1 å¯ä»¥æ˜ å°„åˆ°ï¼š
- PB6 (SCL) + PB7 (SDA)
- **PB8 (SCL) + PB9 (SDA)** â† å¸¸ç”¨é…ç½®

**4.2 I2C é…ç½®å‚æ•°**

ç¡®ä¿ I2C é…ç½®ä¸åŸ Keil é¡¹ç›®ä¸€è‡´ï¼š
```c
hi2c1.Init.ClockSpeed = 400000;        // 400kHz Fast Mode
hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2; // Tlow/Thigh = 2
```

**æ­¥éª¤ 5: é›†æˆåˆ°é¡¹ç›®**

5.1 ä¿®æ”¹ `bsp_system.h`

```c
#include <oled_app.h>
```

**5.2 ä¿®æ”¹ `main.c`**

```c
int main(void)
{
    // å…¶ä»–åˆå§‹åŒ–...
    
    oled_init();  // æ·»åŠ  OLED åˆå§‹åŒ–
    
    return RT_EOK;
}
```

**	**

é—®é¢˜ 1: OLED ä¸äº®

**å¯èƒ½åŸå› **: I2C å¼•è„šé…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: 

1. ä½¿ç”¨ I2C æ‰«æå·¥å…·ç¡®å®šè®¾å¤‡åœ°å€
2. æ£€æŸ¥å®é™…çš„ç¡¬ä»¶è¿æ¥å¼•è„š
3. ç¡®è®¤ I2C æ—¶é’Ÿé¢‘ç‡è®¾ç½®

**æµ‹è¯•å‘½ä»¤**:
```bash
# æ‰«æ I2C è®¾å¤‡
i2c_scan

# æµ‹è¯•ä¸åŒå¼•è„šç»„åˆ
test_pb8_pb9
check_all_pins
```

é—®é¢˜ 2: ç¼–è¯‘é”™è¯¯

**å¯èƒ½åŸå› **: å¤´æ–‡ä»¶è·¯å¾„æˆ–ä¾èµ–é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶åœ¨ `applications` æ–‡ä»¶å¤¹ä¸­
2. æ£€æŸ¥ `#include` è·¯å¾„
3. ç¡®è®¤ RT-Thread é…ç½®æ­£ç¡®

é—®é¢˜ 3: I2C é€šä¿¡å¤±è´¥

**å¯èƒ½åŸå› **: I2C æ—¶é’Ÿé¢‘ç‡ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
```c
// å°è¯•ä¸åŒçš„æ—¶é’Ÿé¢‘ç‡
hi2c1.Init.ClockSpeed = 100000;  // 100kHz Standard Mode
hi2c1.Init.ClockSpeed = 400000;  // 400kHz Fast Mode
```

ğŸ› ï¸ æµ‹è¯•å·¥å…·

ç§»æ¤è¿‡ç¨‹ä¸­æä¾›äº†å¤šä¸ªæµ‹è¯•å·¥å…·ï¼š

åŸºç¡€æµ‹è¯•

```bash
oled_final_test    # å®Œæ•´çš„ OLED æµ‹è¯•
i2c_status         # æ£€æŸ¥ I2C ç¡¬ä»¶çŠ¶æ€
gpio_test          # æµ‹è¯• GPIO å¼•è„šçŠ¶æ€
```

é«˜çº§è¯Šæ–­

```bash
i2c_scan           # æ‰«æ I2C æ€»çº¿è®¾å¤‡
oled_manual_test   # æ‰‹åŠ¨ OLED é€šä¿¡æµ‹è¯•
test_pin_combinations  # æµ‹è¯•ä¸åŒå¼•è„šç»„åˆ
```

ğŸ“Š æ€§èƒ½ä¼˜åŒ–

æ˜¾ç¤ºåˆ·æ–°ä¼˜åŒ–

```c
// é¿å…é¢‘ç¹æ¸…å±
static char last_str[32] = {0};
if (strcmp(current_str, last_str) != 0) {
    rt_oled_show_str(0, 0, current_str, 16);
    strcpy(last_str, current_str);
}
```

çº¿ç¨‹ä¼˜å…ˆçº§è®¾ç½®

```c
// OLED æ˜¾ç¤ºçº¿ç¨‹ä¼˜å…ˆçº§å»ºè®®è®¾ä¸ºä¸­ç­‰
rt_thread_create("oled", oled_proc, RT_NULL, 1024, 15, 20);
//                                            ^    ^   ^
//                                         æ ˆå¤§å° ä¼˜å…ˆçº§ æ—¶é—´ç‰‡
```

ğŸ¯ API ä½¿ç”¨ç¤ºä¾‹

åŸºç¡€æ˜¾ç¤º

```c
rt_oled_clear();                                    // æ¸…å±
rt_oled_show_str(0, 0, "Hello RT-Thread", 16);    // æ˜¾ç¤ºå­—ç¬¦ä¸²
rt_oled_show_num(0, 2, 12345, 5, 16);             // æ˜¾ç¤ºæ•°å­—
```

ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º

```c
void show_system_info(void)
{
    rt_oled_clear();
    rt_oled_show_str(0, 0, "RT-Thread", 16);
    
    // æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ
    rt_uint32_t total, used, max_used;
    rt_memory_info(&total, &used, &max_used);
    rt_oled_show_str(0, 1, "Mem:", 8);
    rt_oled_show_num(32, 1, used, 6, 8);
    
    // æ˜¾ç¤ºçº¿ç¨‹æ•°é‡
    rt_oled_show_str(0, 2, "Threads:", 8);
    rt_oled_show_num(64, 2, rt_object_get_length(RT_Object_Class_Thread), 2, 8);
}
```

âœ… ç§»æ¤éªŒè¯

ç§»æ¤æˆåŠŸçš„æ ‡å¿—ï¼š
1. âœ… ç¼–è¯‘æ— é”™è¯¯æ— è­¦å‘Š
2. âœ… I2C æ‰«æèƒ½æ‰¾åˆ° OLED è®¾å¤‡ (åœ°å€ 0x78)
3. âœ… OLED å±å¹•èƒ½æ­£å¸¸æ˜¾ç¤ºæ–‡å­—
4. âœ… åº”ç”¨çº¿ç¨‹æ­£å¸¸è¿è¡Œ
5. âœ… ç³»ç»Ÿç¨³å®šï¼Œæ— æ­»æœºé‡å¯

ğŸ“ æ€»ç»“

OLED ç§»æ¤çš„å…³é”®ç‚¹ï¼š
1. **ç¡¬ä»¶é…ç½®æ­£ç¡®** - ç¡®è®¤ I2C å¼•è„šå’Œæ—¶é’Ÿé¢‘ç‡
2. **API é€‚é…** - æ›¿æ¢ HAL å»¶æ—¶å‡½æ•°ä¸º RT-Thread å‡½æ•°
3. **çº¿ç¨‹å®‰å…¨** - åˆç†è®¾è®¡åº”ç”¨å±‚çº¿ç¨‹
4. **é”™è¯¯å¤„ç†** - æ·»åŠ å®Œå–„çš„é”™è¯¯æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶

é€šè¿‡æœ¬æŒ‡å—ï¼Œä½ å¯ä»¥æˆåŠŸå°†ä»»ä½•åŸºäº STM32 HAL åº“çš„ OLED é©±åŠ¨ç§»æ¤åˆ° RT-Thread ç³»ç»Ÿä¸­ã€‚

---

**ç§»æ¤å®Œæˆæ—¶é—´**: çº¦ 30-60 åˆ†é’Ÿ  
**éš¾åº¦ç­‰çº§**: â­â­â­â˜†â˜† (ä¸­ç­‰)  
**é€‚ç”¨èŒƒå›´**: STM32 + RT-Thread + SSD1306 OLED

oledä»£ç 

1.oled_app.c

```
/*
 * Copyright (c) 2006-2021, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2025-09-25     RT-Thread    OLED application layer
 */

#include <rtthread.h>
#include <rtdevice.h>
#include "oled_app.h"
#include "rt_oled.h"

/* å¤–éƒ¨å£°æ˜ CubeMX ç”Ÿæˆçš„ I2C å¥æŸ„ */
extern I2C_HandleTypeDef hi2c1;

/* OLED æ˜¾ç¤ºçº¿ç¨‹ */
static void oled_proc(void *parameter)
{
    rt_uint32_t count = 0;
    
    while (1)
    {
        rt_oled_clear();
        
        /* ä¸º0.91å¯¸å°å±å¹•ä¼˜åŒ–çš„æ˜¾ç¤º */
        rt_oled_show_str(0, 0, "RT-Thread", 16);
        
        /* æ˜¾ç¤ºè¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰ */
        rt_uint32_t seconds = rt_tick_get() / RT_TICK_PER_SECOND;
        rt_oled_show_str(0, 2, "Time:", 16);
        rt_oled_show_num(40, 2, seconds, 4, 16);
        
        /* æ˜¾ç¤ºè®¡æ•°å™¨ */
        rt_oled_show_str(0, 4, "Cnt:", 16);
        rt_oled_show_num(32, 4, count++, 3, 16);
        
        rt_thread_mdelay(1000);
    }
}

/* OLED åˆå§‹åŒ–å‡½æ•° */
void oled_init(void)
{
    rt_thread_t tid;
    
    /* åˆå§‹åŒ– OLEDï¼ˆä½¿ç”¨ CubeMX é…ç½®çš„ I2Cï¼‰ */
    if (rt_oled_init() != 0)
    {
        return;
    }
    
    /* åˆ›å»º OLED æ˜¾ç¤ºçº¿ç¨‹ */
    tid = rt_thread_create("oled", oled_proc, RT_NULL, 1024, 20, 10);
    if (tid != RT_NULL)
    {
        rt_thread_startup(tid);
    }
}
```

 2.oled_app.h

```
/*
 * Copyright (c) 2006-2021, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2025-09-25     13615       the first version
 */
#ifndef APPLICATIONS_OLED_APP_H_
#define APPLICATIONS_OLED_APP_H_

#include <bsp_system.h>

void oled_init(void);

#endif /* APPLICATIONS_OLED_APP_H_ */
```

3.oled_font.h

```
#ifndef OLEDFONT_H
#define OLEDFONT_H

// å¸¸ç”¨ ASCII è¡¨
// åç§»é‡ä¸º 32
// ASCII å­—ç¬¦é›†
// åç§»é‡ä¸º 32
/*************************6*8ASCII*************************/
const unsigned char F6X8[][6] =
{
{0x00, 0x00, 0x00, 0x00, 0x00, 0x00},// sp
{0x00, 0x00, 0x00, 0x2f, 0x00, 0x00},// !
{0x00, 0x00, 0x07, 0x00, 0x07, 0x00},// "
{0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14},// #
{0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12},// $
{0x00, 0x62, 0x64, 0x08, 0x13, 0x23},// %
{0x00, 0x36, 0x49, 0x55, 0x22, 0x50},// &
{0x00, 0x00, 0x05, 0x03, 0x00, 0x00},// '
{0x00, 0x00, 0x1c, 0x22, 0x41, 0x00},// (
{0x00, 0x00, 0x41, 0x22, 0x1c, 0x00},// )
{0x00, 0x14, 0x08, 0x3E, 0x08, 0x14},// *
{0x00, 0x08, 0x08, 0x3E, 0x08, 0x08},// +
{0x00, 0x00, 0x00, 0xA0, 0x60, 0x00},// ,
{0x00, 0x08, 0x08, 0x08, 0x08, 0x08},// -
{0x00, 0x00, 0x60, 0x60, 0x00, 0x00},// .
{0x00, 0x20, 0x10, 0x08, 0x04, 0x02},// /
{0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E},// 0
{0x00, 0x00, 0x42, 0x7F, 0x40, 0x00},// 1
{0x00, 0x42, 0x61, 0x51, 0x49, 0x46},// 2
{0x00, 0x21, 0x41, 0x45, 0x4B, 0x31},// 3
{0x00, 0x18, 0x14, 0x12, 0x7F, 0x10},// 4
{0x00, 0x27, 0x45, 0x45, 0x45, 0x39},// 5
{0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30},// 6
{0x00, 0x01, 0x71, 0x09, 0x05, 0x03},// 7
{0x00, 0x36, 0x49, 0x49, 0x49, 0x36},// 8
{0x00, 0x06, 0x49, 0x49, 0x29, 0x1E},// 9
{0x00, 0x00, 0x36, 0x36, 0x00, 0x00},// :
{0x00, 0x00, 0x56, 0x36, 0x00, 0x00},// ;
{0x00, 0x08, 0x14, 0x22, 0x41, 0x00},// <
{0x00, 0x14, 0x14, 0x14, 0x14, 0x14},// =
{0x00, 0x00, 0x41, 0x22, 0x14, 0x08},// >
{0x00, 0x02, 0x01, 0x51, 0x09, 0x06},// ?
{0x00, 0x32, 0x49, 0x59, 0x51, 0x3E},// @
{0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C},// A
{0x00, 0x7F, 0x49, 0x49, 0x49, 0x36},// B
{0x00, 0x3E, 0x41, 0x41, 0x41, 0x22},// C
{0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C},// D
{0x00, 0x7F, 0x49, 0x49, 0x49, 0x41},// E
{0x00, 0x7F, 0x09, 0x09, 0x09, 0x01},// F
{0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A},// G
{0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F},// H
{0x00, 0x00, 0x41, 0x7F, 0x41, 0x00},// I
{0x00, 0x20, 0x40, 0x41, 0x3F, 0x01},// J
{0x00, 0x7F, 0x08, 0x14, 0x22, 0x41},// K
{0x00, 0x7F, 0x40, 0x40, 0x40, 0x40},// L
{0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F},// M
{0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F},// N
{0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E},// O
{0x00, 0x7F, 0x09, 0x09, 0x09, 0x06},// P
{0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E},// Q
{0x00, 0x7F, 0x09, 0x19, 0x29, 0x46},// R
{0x00, 0x46, 0x49, 0x49, 0x49, 0x31},// S
{0x00, 0x01, 0x01, 0x7F, 0x01, 0x01},// T
{0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F},// U
{0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F},// V
{0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F},// W
{0x00, 0x63, 0x14, 0x08, 0x14, 0x63},// X
{0x00, 0x07, 0x08, 0x70, 0x08, 0x07},// Y
{0x00, 0x61, 0x51, 0x49, 0x45, 0x43},// Z
{0x00, 0x00, 0x7F, 0x41, 0x41, 0x00},// [
{0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55},// 55
{0x00, 0x00, 0x41, 0x41, 0x7F, 0x00},// ]
{0x00, 0x04, 0x02, 0x01, 0x02, 0x04},// ^
{0x00, 0x40, 0x40, 0x40, 0x40, 0x40},// _
{0x00, 0x00, 0x01, 0x02, 0x04, 0x00},// '
{0x00, 0x20, 0x54, 0x54, 0x54, 0x78},// a
{0x00, 0x7F, 0x48, 0x44, 0x44, 0x38},// b
{0x00, 0x38, 0x44, 0x44, 0x44, 0x20},// c
{0x00, 0x38, 0x44, 0x44, 0x48, 0x7F},// d
{0x00, 0x38, 0x54, 0x54, 0x54, 0x18},// e
{0x00, 0x08, 0x7E, 0x09, 0x01, 0x02},// f
{0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C},// g
{0x00, 0x7F, 0x08, 0x04, 0x04, 0x78},// h
{0x00, 0x00, 0x44, 0x7D, 0x40, 0x00},// i
{0x00, 0x40, 0x80, 0x84, 0x7D, 0x00},// j
{0x00, 0x7F, 0x10, 0x28, 0x44, 0x00},// k
{0x00, 0x00, 0x41, 0x7F, 0x40, 0x00},// l
{0x00, 0x7C, 0x04, 0x18, 0x04, 0x78},// m
{0x00, 0x7C, 0x08, 0x04, 0x04, 0x78},// n
{0x00, 0x38, 0x44, 0x44, 0x44, 0x38},// o
{0x00, 0xFC, 0x24, 0x24, 0x24, 0x18},// p
{0x00, 0x18, 0x24, 0x24, 0x18, 0xFC},// q
{0x00, 0x7C, 0x08, 0x04, 0x04, 0x08},// r
{0x00, 0x48, 0x54, 0x54, 0x54, 0x20},// s
{0x00, 0x04, 0x3F, 0x44, 0x40, 0x20},// t
{0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C},// u
{0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C},// v
{0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C},// w
{0x00, 0x44, 0x28, 0x10, 0x28, 0x44},// x
{0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C},// y
{0x00, 0x44, 0x64, 0x54, 0x4C, 0x44},// z
{0x14, 0x14, 0x14, 0x14, 0x14, 0x14},// horiz lines
};

/*************************8*16ASCII*************************/
const unsigned char F8X16[]=
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 0
  0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00,//! 1
  0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//" 2
  0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00,//# 3
  0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00,//$ 4
  0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00,//% 5
  0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10,//& 6
  0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//' 7
  0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,//( 8
  0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00,//) 9
  0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00,//* 10
  0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00,//+ 11
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00,//, 12
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,//- 13
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,//. 14
  0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00,/// 15
  0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,//0 16
  0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//1 17
  0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,//2 18
  0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,//3 19
  0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,//4 20
  0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,//5 21
  0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,//6 22
  0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,//7 23
  0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,//8 24
  0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,//9 25
  0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,//: 26
  0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00,//; 27
  0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00,//< 28
  0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,//= 29
  0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00,//> 30
  0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00,//? 31
  0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00,//@ 32
  0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,//A 33
  0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,//B 34
  0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,//C 35
  0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,//D 36
  0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,//E 37
  0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,//F 38
  0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,//G 39
  0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,//H 40
  0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//I 41
  0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,//J 42
  0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,//K 43
  0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,//L 44
  0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,//M 45
  0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,//N 46
  0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,//O 47
  0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,//P 48
  0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,//Q 49
  0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,//R 50
  0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,//S 51
  0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//T 52
  0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,//U 53
  0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,//V 54
  0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,//W 55
  0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,//X 56
  0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//Y 57
  0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,//Z 58
  0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,//[ 59
  0x00,0x0C,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xC0,0x00,//\ 60
  0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,//] 61
  0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//^ 62
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,//_ 63
  0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//` 64
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20,//a 65
  0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00,//b 66
  0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00,//c 67
  0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20,//d 68
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00,//e 69
  0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x18,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//f 70
  0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00,//g 71
  0x00,0xF8,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x3F,0x01,0x00,0x00,0x00,0x3F,0x00,//h 72
  0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//i 73
  0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,//j 74
  0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00,//k 75
  0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//l 76
  0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F,//m 77
  0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,//n 78
  0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,//o 79
  0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00,//p 80
  0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0x20,0xA0,0xFF,0x80,//q 81
  0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00,//r 82
  0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00,//s 83
  0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00,//t 84
  0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20,//u 85
  0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00,//v 86
  0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00,//w 87
  0x00,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00,//x 88
  0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x8E,0x70,0x18,0x06,0x01,0x00,//y 89
  0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00,//z 90
  0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40,//{ 91
  0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,//| 92
  0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00,//} 93
  0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//~ 94
};

/*****************************16*16 æ±‰å­—****************/
const unsigned char Hzk[][32]={
{0x00,0x20,0x46,0xCC,0x08,0x04,0x04,0x7C,0xC4,0x04,0x04,0x84,0xF4,0x0C,0x00,0x00,
0x00,0x40,0x30,0x0C,0x44,0x40,0x60,0x20,0x11,0x0E,0x0E,0x13,0x20,0x60,0x40,0x00},/*"æ±‰",0*/

{0x00,0x00,0x38,0x08,0x48,0x48,0x48,0x4E,0x4C,0xC8,0xC8,0x48,0x08,0x38,0x38,0x00,
0x00,0x04,0x04,0x04,0x04,0x04,0xC4,0x44,0x7F,0x05,0x04,0x04,0x04,0x04,0x04,0x00},/*"å­—",1*/
};

/*****************************32*32 æ±‰å­—****************/
const unsigned char Hzb[][128]={
{0x00,0x00,0x00,0x00,0x08,0x10,0x30,0x60,0xE0,0xE0,0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x20,0x20,0x20,0xA0,0xF0,0x70,0x20,0x00,0x00,0x00,0x00,
0x00,0x08,0x08,0x18,0x10,0x30,0x70,0x00,0x00,0xC0,0x70,0x0C,0x02,0x00,0x02,0x06,0x1C,0x70,0xC0,0x80,0x00,0x80,0xE0,0x78,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0x78,0x0E,0x01,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x30,0x1B,0x0E,0x1B,0x71,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0x02,0x06,0x0E,0x0F,0x21,0x10,0x10,0x08,0x08,0x04,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x0E,0x0C,0x0C,0x0C,0x08,0x08},/*"æ±‰",0*/
};

#endif // OLEDFONT_H
```

4.rt_oled.c

```
/*
 * RT-Thread OLED (SSD1306) é©±åŠ¨åº“
 * ç§»æ¤è‡ª STM32 HAL åº“ç‰ˆæœ¬
 */

#include "rt_oled.h"
#include "oledfont.h"

/* å¤–éƒ¨ I2C å¥æŸ„ï¼Œéœ€è¦åœ¨ main.c æˆ–å…¶ä»–åœ°æ–¹å®šä¹‰ */
extern I2C_HandleTypeDef hi2c1;

/**
 * OLED åˆå§‹åŒ–æ§åˆ¶å­—
 */
static rt_uint8_t initcmd1[] = {
    0xAE,       // display off
    0xD5, 0x80, // Set Display Clock Divide Ratio/Oscillator Frequency
    0xA8, 0x1F, // set multiplex Ratio
    0xD3, 0x00, // display offset
    0x40,       // set display start line
    0x8d, 0x14, // set charge pump
    0xa1,       // set segment remap
    0xc8,       // set com output scan direction
    0xda, 0x00, // set com pins hardware configuration
    0x81, 0x80, // set contrast control
    0xd9, 0x1f, // set pre-charge period
    0xdb, 0x40, // set vcom deselect level
    0xa4,       // Set Entire Display On/Off
    0xaf,       // set display on
};

/**
 * @brief OLED å†™å‘½ä»¤
 * @param cmd å‘½ä»¤å­—èŠ‚
 */
void rt_oled_write_cmd(rt_uint8_t cmd)
{
    HAL_I2C_Mem_Write(&hi2c1, OLED_ADDR, 0x00, I2C_MEMADD_SIZE_8BIT, &cmd, 1, 0x100);
}

/**
 * @brief OLED å†™æ•°æ®
 * @param data æ•°æ®å­—èŠ‚
 */
void rt_oled_write_data(rt_uint8_t data)
{
    HAL_I2C_Mem_Write(&hi2c1, OLED_ADDR, 0x40, I2C_MEMADD_SIZE_8BIT, &data, 1, 0x100);
}

/**
 * @brief å›¾åƒæ˜¾ç¤ºå‡½æ•°
 * @param x0  å›¾åƒæ˜¾ç¤ºèµ·å§‹ä½ç½® x è½´
 * @param y0  å›¾åƒæ˜¾ç¤ºèµ·å§‹ä½ç½® y è½´
 * @param x1  å›¾åƒæ˜¾ç¤ºç»“æŸä½ç½® x è½´ 1 - 127
 * @param y1  å›¾åƒæ˜¾ç¤ºç»“æŸä½ç½® y è½´ 1 - 4
 * @param BMP å›¾åƒæ˜¾ç¤ºæŒ‡é’ˆåœ°å€
 */
void rt_oled_show_pic(rt_uint8_t x0, rt_uint8_t y0, rt_uint8_t x1, rt_uint8_t y1, rt_uint8_t BMP[])
{
    rt_uint16_t i = 0;
    rt_uint8_t x, y;
    for (y = y0; y < y1; y++)
    {
        rt_oled_set_position(x0, y);
        for (x = x0; x < x1; x++)
        {
            rt_oled_write_data(BMP[i++]);
        }
    }
}

/**
 * @brief æ˜¾ç¤º 16*16 åƒç´ æ±‰å­—
 * @param x  ä½ç½® x è½´  0 - 127
 * @param y  ä½ç½® y è½´  0 - 3
 * @param no hzk[] æ•°ç»„ä¸­æ±‰å­—çš„é¡ºåº
 */
void rt_oled_show_hanzi(rt_uint8_t x, rt_uint8_t y, rt_uint8_t no)
{
    rt_uint8_t t, adder = 0;
    rt_oled_set_position(x, y);
    for (t = 0; t < 16; t++)
    {
        rt_oled_write_data(Hzk[2 * no][t]);
        adder += 1;
    }
    rt_oled_set_position(x, y + 1);
    for (t = 0; t < 16; t++)
    {
        rt_oled_write_data(Hzk[2 * no + 1][t]);
        adder += 1;
    }
}

/**
 * @brief æ˜¾ç¤º 32*32 åƒç´ æ±‰å­—ï¼Œå…¨å±æ˜¾ç¤º
 * @param x  ä½ç½® x è½´  0 - 127
 * @param y  ä½ç½® y è½´  0
 * @param n  Hzb[] æ•°ç»„ä¸­æ±‰å­—çš„é¡ºåº
 */
void rt_oled_show_hzbig(rt_uint8_t x, rt_uint8_t y, rt_uint8_t n)
{
    rt_uint8_t t, adder = 0;
    rt_oled_set_position(x, y);
    for (t = 0; t < 32; t++)
    {
        rt_oled_write_data(Hzb[4 * n][t]);
        adder += 1;
    }
    rt_oled_set_position(x, y + 1);
    for (t = 0; t < 32; t++)
    {
        rt_oled_write_data(Hzb[4 * n + 1][t]);
        adder += 1;
    }

    rt_oled_set_position(x, y + 2);
    for (t = 0; t < 32; t++)
    {
        rt_oled_write_data(Hzb[4 * n + 2][t]);
        adder += 1;
    }
    rt_oled_set_position(x, y + 3);
    for (t = 0; t < 32; t++)
    {
        rt_oled_write_data(Hzb[4 * n + 3][t]);
        adder += 1;
    }
}

/**
 * @brief æ˜¾ç¤ºæµ®ç‚¹æ•°
 * @param x  ä½ç½® x è½´  0 - 127
 * @param y  ä½ç½® y è½´  0
 * @param num  è¦æ˜¾ç¤ºçš„æµ®ç‚¹æ•°
 * @param accuracy ä¿ç•™å°æ•°ä½æ•°
 * @param fontsize å­—ä½“å¤§å° 8/16
 */
void rt_oled_show_float(rt_uint8_t x, rt_uint8_t y, float num, rt_uint8_t accuracy, rt_uint8_t fontsize)
{
    rt_uint8_t i = 0;
    rt_uint8_t j = 0;
    rt_uint8_t t = 0;
    rt_uint8_t temp = 0;
    rt_uint16_t numel = 0;
    rt_uint32_t integer = 0;
    float decimals = 0;

    // æ˜¯å¦ä¸ºè´Ÿæ•°ï¼Ÿ
    if (num < 0)
    {
        rt_oled_show_char(x, y, '-', fontsize);
        num = 0 - num;
        i++;
    }

    integer = (rt_uint32_t)num;
    decimals = num - integer;

    // æ•´æ•°éƒ¨åˆ†
    if (integer)
    {
        numel = integer;

        while (numel)
        {
            numel /= 10;
            j++;
        }
        i += (j - 1);
        for (temp = 0; temp < j; temp++)
        {
            rt_oled_show_char(x + 8 * (i - temp), y, integer % 10 + '0', fontsize);
            integer /= 10;
        }
    }
    else
    {
        rt_oled_show_char(x + 8 * i, y, temp + '0', fontsize);
    }
    i++;
    // å°æ•°éƒ¨åˆ†
    if (accuracy)
    {
        rt_oled_show_char(x + 8 * i, y, '.', fontsize);

        i++;
        for (t = 0; t < accuracy; t++)
        {
            decimals *= 10;
            temp = (rt_uint8_t)decimals;
            rt_oled_show_char(x + 8 * (i + t), y, temp + '0', fontsize);
            decimals -= temp;
        }
    }
}

/**
 * @brief OLED å¹‚å‡½æ•°
 * @param a åº•æ•°
 * @param n æŒ‡æ•°
 * @return ç»“æœ
 */
static rt_uint32_t rt_oled_pow(rt_uint8_t a, rt_uint8_t n)
{
    rt_uint32_t result = 1;
    while (n--)
    {
        result *= a;
    }
    return result;
}

/**
 * @brief æ˜¾ç¤º uint32 æ•´æ•°
 * @param x  ä½ç½® x è½´  0 - 127
 * @param y  ä½ç½® y è½´  0 - 3
 * @param num  æ˜¾ç¤ºçš„æ•´æ•°
 * @param length æ•´æ•°ä½æ•°
 * @param fontsize å­—ä½“å¤§å°
 */
void rt_oled_show_num(rt_uint8_t x, rt_uint8_t y, rt_uint32_t num, rt_uint8_t length, rt_uint8_t fontsize)
{
    rt_uint8_t t, temp;
    rt_uint8_t enshow = 0;
    rt_uint8_t char_width = (fontsize == 16) ? 8 : 6;  // 16å·å­—ä½“å®½åº¦8ï¼Œ8å·å­—ä½“å®½åº¦6
    
    for (t = 0; t < length; t++)
    {
        temp = (num / rt_oled_pow(10, length - t - 1)) % 10;
        if (enshow == 0 && t < (length - 1))
        {
            if (temp == 0)
            {
                rt_oled_show_char(x + char_width * t, y, ' ', fontsize);
                continue;
            }
            else
                enshow = 1;
        }
        rt_oled_show_char(x + char_width * t, y, temp + '0', fontsize);
    }
}

/**
 * @brief æ˜¾ç¤º ASCII å­—ç¬¦ä¸²
 * @param x  å­—ç¬¦ä¸²åœ¨ X è½´çš„èµ·å§‹ä½ç½®  èŒƒå›´ï¼š0 - 127
 * @param y  å­—ç¬¦ä¸²åœ¨ Y è½´çš„èµ·å§‹ä½ç½®  èŒƒå›´ï¼š0 - 3 
 * @param ch  å­—ç¬¦ä¸²æŒ‡é’ˆ
 * @param fontsize å­—ä½“å¤§å° 8/16
 */
void rt_oled_show_str(rt_uint8_t x, rt_uint8_t y, char *ch, rt_uint8_t fontsize)
{
    rt_uint8_t j = 0;
    while (ch[j] != '\0')
    {
        rt_oled_show_char(x, y, ch[j], fontsize);
        x += 8;
        if (x > 120)
        {
            x = 0;
            y += 2;
        }
        j++;
    }
}

/**
 * @brief æ˜¾ç¤º ASCII å­—ç¬¦
 * @param x  å­—ç¬¦åœ¨ X è½´çš„ä½ç½®  èŒƒå›´ï¼š0 - 127
 * @param y  å­—ç¬¦åœ¨ Y è½´çš„ä½ç½®  èŒƒå›´ï¼š0 - 3 
 * @param ch  å­—ç¬¦
 * @param fontsize å­—ä½“å¤§å° 8/16
 */
void rt_oled_show_char(rt_uint8_t x, rt_uint8_t y, rt_uint8_t ch, rt_uint8_t fontsize)
{
    rt_uint8_t c = 0, i = 0;
    c = ch - ' ';

    if (x > 127) // è¶…å‡ºå³è¾¹ç•Œ
    {
        x = 0;
        y++;
    }

    if (fontsize == 16)
    {
        rt_oled_set_position(x, y);
        for (i = 0; i < 8; i++)
        {
            rt_oled_write_data(F8X16[c * 16 + i]);
        }
        rt_oled_set_position(x, y + 1);
        for (i = 0; i < 8; i++)
        {
            rt_oled_write_data(F8X16[c * 16 + i + 8]);
        }
    }
    else
    {
        rt_oled_set_position(x, y);
        for (i = 0; i < 6; i++)
        {
            rt_oled_write_data(F6X8[c][i]);
        }
    }
}

/**
 * OLED å¡«å……å‡½æ•°ï¼Œä½¿ç”¨å 0.91 è‹±å¯¸ OLED å±å¹•å˜ä¸ºå…¨ç™½
 */
void rt_oled_allfill(void)
{
    rt_uint8_t i, j;
    for (i = 0; i < 4; i++)
    {
        rt_oled_write_cmd(0xb0 + i);
        rt_oled_write_cmd(0x00);
        rt_oled_write_cmd(0x10);
        for (j = 0; j < 128; j++)
        {
            rt_oled_write_data(0xFF);
        }
    }
}

/**
 * @brief è®¾ç½®åæ ‡
 * @param x X ä½ç½®ï¼ŒèŒƒå›´ 0 - 127
 * @param y Y ä½ç½®ï¼ŒèŒƒå›´ 0 - 3
 */
void rt_oled_set_position(rt_uint8_t x, rt_uint8_t y)
{
    rt_oled_write_cmd(0xb0 + y);
    rt_oled_write_cmd(((x & 0xf0) >> 4) | 0x10);
    rt_oled_write_cmd((x & 0x0f) | 0x00);
}

/**
 * æ¸…å±å‡½æ•°
 * ç”¨ 0 å¡«å……æ¯è¡Œæ¯åˆ—
 */
void rt_oled_clear(void)
{
    rt_uint8_t i, n;
    for (i = 0; i < 4; i++)
    {
        rt_oled_write_cmd(0xb0 + i);
        rt_oled_write_cmd(0x00);
        rt_oled_write_cmd(0x10);
        for (n = 0; n < 128; n++)
        {
            rt_oled_write_data(0);
        }
    }
}

/**
 * å¼€å¯å’Œå…³é—­å±å¹•æ˜¾ç¤º
 */
void rt_oled_display_on(void)
{
    rt_oled_write_cmd(0x8D);
    rt_oled_write_cmd(0x14);
    rt_oled_write_cmd(0xAF);
}

void rt_oled_display_off(void)
{
    rt_oled_write_cmd(0x8D);
    rt_oled_write_cmd(0x10);
    rt_oled_write_cmd(0xAF);
}

/**
 * @brief åˆå§‹åŒ– OLED
 * @return RT_EOK æˆåŠŸï¼Œå…¶ä»–å€¼å¤±è´¥
 */
rt_err_t rt_oled_init(void)
{
    rt_uint8_t i;
    
    rt_thread_mdelay(100);
    
    /* å‘é€åˆå§‹åŒ–å‘½ä»¤ */
    for (i = 0; i < sizeof(initcmd1); i++)
    {
        rt_oled_write_cmd(initcmd1[i]);
    }

    rt_oled_clear();
    rt_oled_set_position(0, 0);
    
    rt_kprintf("OLED initialized successfully\n");
    return RT_EOK;
}
```

5.rt_oled.h

```
#ifndef __RT_OLED_H__
#define __RT_OLED_H__

#include <rtthread.h>
#include <rtdevice.h>
#include "stm32f4xx_hal.h"

#define OLED_ADDR 0x78

#define OLED_WIDTH 128
#define OLED_HEIGHT 32

/* å‡½æ•°å£°æ˜ */
rt_err_t rt_oled_init(void);
void rt_oled_write_cmd(rt_uint8_t cmd);
void rt_oled_write_data(rt_uint8_t data);
void rt_oled_show_pic(rt_uint8_t x0, rt_uint8_t y0, rt_uint8_t x1, rt_uint8_t y1, rt_uint8_t BMP[]);
void rt_oled_show_hanzi(rt_uint8_t x, rt_uint8_t y, rt_uint8_t no);
void rt_oled_show_hzbig(rt_uint8_t x, rt_uint8_t y, rt_uint8_t n);
void rt_oled_show_float(rt_uint8_t x, rt_uint8_t y, float num, rt_uint8_t accuracy, rt_uint8_t fontsize);
void rt_oled_show_num(rt_uint8_t x, rt_uint8_t y, rt_uint32_t num, rt_uint8_t length, rt_uint8_t fontsize);
void rt_oled_show_str(rt_uint8_t x, rt_uint8_t y, char *ch, rt_uint8_t fontsize);
void rt_oled_show_char(rt_uint8_t x, rt_uint8_t y, rt_uint8_t ch, rt_uint8_t fontsize);
void rt_oled_allfill(void);
void rt_oled_set_position(rt_uint8_t x, rt_uint8_t y);
void rt_oled_clear(void);
void rt_oled_display_on(void);
void rt_oled_display_off(void);

#endif  /*__RT_OLED_H__*/
```





### 4.Uartä¸²å£

1.ä»£ç 

```
#include <uart_app.h>
#include <rtthread.h>

#define SAMPLE_UART_NAME "uart1"

/* ä¿¡å·é‡ï¼Œç”¨äºæ¥æ”¶æ•°æ®é€šçŸ¥ */
static struct rt_semaphore rx_sem;
static rt_device_t serial;

/* æ¥æ”¶å›è°ƒå‡½æ•° */
static rt_err_t uart_input(rt_device_t dev, rt_size_t size)
{
    rt_sem_release(&rx_sem);  // å‘é€ä¿¡å·é‡
    return RT_EOK;
}

/* å¤„ç†ä¸²å£æ¥æ”¶åˆ°çš„æ•°æ® */
static void serial_thread_entry(void *parameter)
{
    char ch;
    while (1)
    {
        rt_sem_take(&rx_sem, RT_WAITING_FOREVER);  // ç­‰å¾…ä¿¡å·é‡
        while (rt_device_read(serial, -1, &ch, 1) == 1)
        {
            rt_device_write(serial, 0, &ch, 1);  // å›æ˜¾æ¥æ”¶åˆ°çš„æ•°æ®
        }
    }
}

static int uart_sample(void)
{
    /* æŸ¥æ‰¾å¹¶æ‰“å¼€ä¸²å£è®¾å¤‡ */
    serial = rt_device_find(SAMPLE_UART_NAME);
    rt_device_open(serial, RT_DEVICE_FLAG_INT_RX);

    /* åˆå§‹åŒ–ä¿¡å·é‡å’Œæ¥æ”¶å›è°ƒ */
    rt_sem_init(&rx_sem, "rx_sem", 0, RT_IPC_FLAG_FIFO);
    rt_device_set_rx_indicate(serial, uart_input);

    /* åˆ›å»ºçº¿ç¨‹å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ® */
    rt_thread_t thread = rt_thread_create("serial", serial_thread_entry, RT_NULL, 1024, 25, 10);
    rt_thread_startup(thread);

    return 0;
}

INIT_APP_EXPORT(uart_sample);

```

2.å…³é—­msh shellå‘½ä»¤è¡Œ

![image-20251006093508576](C:\Users\13615\AppData\Roaming\Typora\typora-user-images\image-20251006093508576.png)

3.æ€»ç»“

------

ğŸ§  ä¸€ã€ä»£ç æ€»ä½“åŠŸèƒ½

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªéå¸¸ç»å…¸çš„ **RT-Thread ä¸²å£é€šä¿¡ç¤ºä¾‹**ï¼š

ğŸ‘‰ ä» UART æ¥å£æ¥æ”¶æ•°æ® â†’ é€šçŸ¥æ¥æ”¶çº¿ç¨‹ â†’ åœ¨çº¿ç¨‹ä¸­è¯»å–å¹¶å›æ˜¾æ”¶åˆ°çš„å­—ç¬¦ã€‚

æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªç¨‹åºå¯ä»¥è®©å¼€å‘æ¿ä¸Šçš„ä¸²å£åƒâ€œå›æ˜¾ç»ˆç«¯â€ä¸€æ ·å·¥ä½œï¼šä½ å‘ä¸€ä¸ªå­—ç¬¦ï¼Œå®ƒå°±è¿”å›åŒæ ·çš„å­—ç¬¦ã€‚

------

âš™ï¸ äºŒã€ä»£ç ç»“æ„ä¸å·¥ä½œæµç¨‹

æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š

```
uart_sample()
 â”œâ”€â”€ æŸ¥æ‰¾å¹¶æ‰“å¼€ä¸²å£è®¾å¤‡ uart1
 â”œâ”€â”€ åˆå§‹åŒ–ä¿¡å·é‡ rx_sem
 â”œâ”€â”€ è®¾ç½®æ¥æ”¶å›è°ƒ uart_input()
 â”œâ”€â”€ åˆ›å»ºæ¥æ”¶å¤„ç†çº¿ç¨‹ serial_thread_entry()
 â””â”€â”€ å¯åŠ¨çº¿ç¨‹
```

çº¿ç¨‹è¿è¡Œé€»è¾‘ï¼š

```
serial_thread_entry()
 â”œâ”€â”€ ç­‰å¾…ä¿¡å·é‡ï¼ˆè¡¨ç¤ºæœ‰æ–°æ•°æ®ï¼‰
 â”œâ”€â”€ ä»ä¸²å£è¯»å–æ•°æ®
 â””â”€â”€ å›æ˜¾æ•°æ®
```

------

ğŸ§© ä¸‰ã€ä¸»è¦å‡½æ•°é€è¡Œè®²è§£

1. å®ä¸å…¨å±€å˜é‡

```c
#define SAMPLE_UART_NAME "uart1"
static struct rt_semaphore rx_sem;
static rt_device_t serial;
```

- `SAMPLE_UART_NAME`ï¼šå®šä¹‰è¦ä½¿ç”¨çš„ä¸²å£è®¾å¤‡åï¼Œè¿™ä¸ªåå­—å¿…é¡»ä¸ **RT-Thread è®¾å¤‡ç®¡ç†å™¨**ä¸­æ³¨å†Œçš„è®¾å¤‡ä¸€è‡´ï¼ˆä¸€èˆ¬ä¸º `uart1`, `uart2` ç­‰ï¼‰ã€‚
- `rx_sem`ï¼šå®šä¹‰ä¸€ä¸ªä¿¡å·é‡ï¼Œç”¨äºçº¿ç¨‹é—´åŒæ­¥ã€‚
- `serial`ï¼šå®šä¹‰ä¸€ä¸ªä¸²å£è®¾å¤‡å¯¹è±¡æŒ‡é’ˆã€‚

------

2. æ¥æ”¶å›è°ƒå‡½æ•°

```c
static rt_err_t uart_input(rt_device_t dev, rt_size_t size)
{
    rt_sem_release(&rx_sem);  // é€šçŸ¥çº¿ç¨‹æœ‰æ•°æ®åˆ°è¾¾
    return RT_EOK;
}
```

- å½“ UART æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼ŒRT-Thread ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚
- å‡½æ•°ä¸­è°ƒç”¨ `rt_sem_release()` é‡Šæ”¾ä¿¡å·é‡ï¼Œå‘Šè¯‰æ¥æ”¶çº¿ç¨‹â€œæœ‰æ•°æ®æ¥äº†â€ã€‚

è¿™æ˜¯ä¸€ä¸ª **ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è§¦å‘çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶**ã€‚

------

3. ä¸²å£å¤„ç†çº¿ç¨‹

```c
static void serial_thread_entry(void *parameter)
{
    char ch;
    while (1)
    {
        rt_sem_take(&rx_sem, RT_WAITING_FOREVER);  // ç­‰å¾…ä¿¡å·é‡ï¼ˆé˜»å¡ï¼‰
        while (rt_device_read(serial, -1, &ch, 1) == 1)
        {
            rt_device_write(serial, 0, &ch, 1);  // å›æ˜¾æ”¶åˆ°çš„å­—ç¬¦
        }
    }
}
```

**å…³é”®æœºåˆ¶è§£é‡Šï¼š**

- `rt_sem_take()`ï¼šçº¿ç¨‹ä¼šåœ¨æ­¤é˜»å¡ç­‰å¾…ä¿¡å·é‡ã€‚
- ä¸€æ—¦æœ‰æ•°æ®ï¼Œ`uart_input()` é‡Šæ”¾ä¿¡å·é‡ â†’ çº¿ç¨‹è¢«å”¤é†’ã€‚
- `rt_device_read()`ï¼šä»ä¸²å£ç¼“å†²åŒºè¯»å–æ•°æ®ã€‚
- `rt_device_write()`ï¼šæŠŠæ•°æ®å†å‘å›å»ï¼ˆå›æ˜¾åŠŸèƒ½ï¼‰ã€‚

ğŸŸ¢ è¿™å°±å®ç°äº†ä¸€ä¸ª **â€œäº‹ä»¶è§¦å‘ + æ•°æ®å¤„ç†â€** çš„ä¸²å£æ¥æ”¶æ¨¡å‹ã€‚

------

4. åˆå§‹åŒ–å‡½æ•°

```c
static int uart_sample(void)
{
    serial = rt_device_find(SAMPLE_UART_NAME);
    rt_device_open(serial, RT_DEVICE_FLAG_INT_RX);

    rt_sem_init(&rx_sem, "rx_sem", 0, RT_IPC_FLAG_FIFO);
    rt_device_set_rx_indicate(serial, uart_input);

    rt_thread_t thread = rt_thread_create("serial", serial_thread_entry, RT_NULL, 1024, 25, 10);
    rt_thread_startup(thread);

    return 0;
}
```

æ­¥éª¤è§£æï¼š

1. **æŸ¥æ‰¾å¹¶æ‰“å¼€è®¾å¤‡ï¼š**

   ```c
   serial = rt_device_find("uart1");
   rt_device_open(serial, RT_DEVICE_FLAG_INT_RX);
   ```

   - `rt_device_find()` æ ¹æ®è®¾å¤‡åæ‰¾åˆ°æ³¨å†Œçš„ UART è®¾å¤‡ã€‚
   - `RT_DEVICE_FLAG_INT_RX` è¡¨ç¤ºå¼€å¯æ¥æ”¶ä¸­æ–­æ¨¡å¼ã€‚

2. **åˆå§‹åŒ–ä¿¡å·é‡ï¼š**

   ```c
   rt_sem_init(&rx_sem, "rx_sem", 0, RT_IPC_FLAG_FIFO);
   ```

   - åˆ›å»ºä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„ä¿¡å·é‡ï¼ˆFIFO è°ƒåº¦æ–¹å¼ï¼‰ã€‚
   - è¡¨ç¤ºâ€œå½“å‰æ²¡æœ‰æ¥æ”¶åˆ°æ–°æ•°æ®â€ã€‚

3. **è®¾ç½®å›è°ƒå‡½æ•°ï¼š**

   ```c
   rt_device_set_rx_indicate(serial, uart_input);
   ```

   - æ³¨å†Œæ•°æ®æ¥æ”¶å›è°ƒï¼Œå½“ä¸²å£æ¥æ”¶ä¸­æ–­è§¦å‘æ—¶ä¼šè°ƒç”¨ã€‚

4. **åˆ›å»ºçº¿ç¨‹ï¼š**

   ```c
   rt_thread_create("serial", serial_thread_entry, RT_NULL, 1024, 25, 10);
   ```

   - åˆ›å»ºä¸€ä¸ªåä¸º `serial` çš„çº¿ç¨‹ï¼Œå †æ ˆ 1024 å­—èŠ‚ï¼Œä¼˜å…ˆçº§ 25ã€‚

5. **å¯åŠ¨çº¿ç¨‹ï¼š**

   ```c
   rt_thread_startup(thread);
   ```

6. **æ³¨å†Œåˆ°è‡ªåŠ¨åˆå§‹åŒ–ç³»ç»Ÿï¼š**

   ```c
   INIT_APP_EXPORT(uart_sample);
   ```

   - RT-Thread ä¼šåœ¨åº”ç”¨å±‚è‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°ï¼ˆç³»ç»Ÿå¯åŠ¨åè‡ªåŠ¨è¿è¡Œï¼‰ã€‚

------

ğŸ§© å››ã€RT-Thread çŸ¥è¯†ç‚¹æ€»ç»“

| æ¦‚å¿µ                     | å«ä¹‰                                                         |
| ------------------------ | ------------------------------------------------------------ |
| **è®¾å¤‡æ¨¡å‹**             | RT-Thread çš„æ‰€æœ‰å¤–è®¾ï¼ˆUARTã€SPIã€I2C ç­‰ï¼‰éƒ½é€šè¿‡ç»Ÿä¸€çš„ `rt_device_t` æ¥å£è®¿é—® |
| **ä¿¡å·é‡ï¼ˆSemaphoreï¼‰**  | ä¸€ç§çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œç”¨äºé€šçŸ¥äº‹ä»¶æˆ–ä¿æŠ¤å…±äº«èµ„æº                 |
| **å›è°ƒå‡½æ•°ï¼ˆCallbackï¼‰** | å½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿï¼ˆå¦‚ä¸²å£æ¥æ”¶ä¸­æ–­ï¼‰æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨             |
| **çº¿ç¨‹ï¼ˆThreadï¼‰**       | RT-Thread çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œæ”¯æŒä¼˜å…ˆçº§è°ƒåº¦                     |
| **INIT_APP_EXPORT**      | è‡ªåŠ¨åˆå§‹åŒ–å®ï¼Œç”¨äºåº”ç”¨å±‚ç»„ä»¶åˆå§‹åŒ–                           |

------

ğŸ§° äº”ã€ç¨‹åºè¿è¡Œç»“æœ

å‡è®¾ä½ çš„å¼€å‘æ¿è¿æ¥åˆ° UART1ï¼š

- æ‰“å¼€ä¸²å£è°ƒè¯•åŠ©æ‰‹ï¼Œè®¾ç½®æ³¢ç‰¹ç‡æ­£ç¡®ï¼ˆä¾‹å¦‚ 115200ï¼‰ã€‚
- æ¯å½“ä½ è¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼ˆæ¯”å¦‚ `A`ï¼‰ï¼Œç³»ç»Ÿä¼šç«‹å³å›æ˜¾åŒæ ·çš„å­—ç¬¦ã€‚
- çº¿ç¨‹ä¼šæŒç»­è¿è¡Œï¼Œå¤„ç†æ¯æ¬¡æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

ç»ˆç«¯è¾“å‡ºç¤ºä¾‹ï¼š

```
A â†’ A
Hello â†’ Hello
```

------

## RT-Thread UART ä¸²å£é€šä¿¡ç¤ºä¾‹è®²è§£

ä¸€ã€ç¤ºä¾‹åŠŸèƒ½

è¯¥ç¤ºä¾‹å®ç°äº†ä¸€ä¸ªä¸²å£å›æ˜¾ç¨‹åºï¼š
 å½“ä¸²å£æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼Œé€šè¿‡ä¿¡å·é‡é€šçŸ¥å¤„ç†çº¿ç¨‹ï¼Œå†ç”±çº¿ç¨‹è¯»å–å¹¶å°†æ•°æ®åŸæ ·å‘é€å›å»ï¼Œå®ç°â€œå›æ˜¾â€åŠŸèƒ½ã€‚

------

äºŒã€ç¨‹åºæµç¨‹å›¾

```mermaid
flowchart TD
    A[ç³»ç»Ÿå¯åŠ¨] --> B[åˆå§‹åŒ– UART è®¾å¤‡]
    B --> C[è®¾ç½®å›è°ƒå‡½æ•° uart_input]
    C --> D[åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹ serial_thread_entry]
    D --> E[ç­‰å¾…ä¸²å£æ¥æ”¶æ•°æ®]
    E --> F[ä¸­æ–­è§¦å‘ â†’ uart_input]
    F --> G[é‡Šæ”¾ä¿¡å·é‡ rx_sem]
    G --> H[çº¿ç¨‹è¢«å”¤é†’]
    H --> I[è¯»å–ä¸²å£æ•°æ®]
    I --> J[å›æ˜¾å‘é€æ•°æ®]
    J --> E
```

------

ä¸‰ã€å…³é”®å‡½æ•°è¯´æ˜

| å‡½æ•°                          | ä½œç”¨                 |
| ----------------------------- | -------------------- |
| `rt_device_find()`            | æŸ¥æ‰¾æŒ‡å®šåç§°çš„è®¾å¤‡   |
| `rt_device_open()`            | æ‰“å¼€è®¾å¤‡             |
| `rt_sem_init()`               | åˆå§‹åŒ–ä¿¡å·é‡         |
| `rt_device_set_rx_indicate()` | è®¾ç½®è®¾å¤‡æ¥æ”¶å›è°ƒå‡½æ•° |
| `rt_sem_take()`               | ç­‰å¾…ä¿¡å·é‡ï¼ˆé˜»å¡ï¼‰   |
| `rt_device_read()`            | è¯»å–è®¾å¤‡æ•°æ®         |
| `rt_device_write()`           | å†™å…¥è®¾å¤‡æ•°æ®ï¼ˆå‘é€ï¼‰ |
| `rt_thread_create()`          | åˆ›å»ºçº¿ç¨‹             |
| `rt_thread_startup()`         | å¯åŠ¨çº¿ç¨‹             |

------

å››ã€è¿è¡Œæ•ˆæœ

æ‰“å¼€ä¸²å£è°ƒè¯•å·¥å…·ï¼Œè¿æ¥å¯¹åº”ä¸²å£åï¼Œè¾“å…¥ä»»æ„å­—ç¬¦ï¼Œä¼šç«‹å³çœ‹åˆ°å›æ˜¾è¾“å‡ºã€‚

ç¤ºä¾‹ï¼š

```
Input:  H
Output: H
Input:  Hello RT-Thread!
Output: Hello RT-Thread!
```

------

äº”ã€æ‰©å±•æ€è€ƒ

ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•åŠŸèƒ½ï¼š

- æ·»åŠ æ¥æ”¶ç¼“å­˜åŒºï¼Œå®ç°æ•´è¡Œå›æ˜¾ï¼›
- å®ç°ä¸²å£å‘½ä»¤è§£æï¼›
- åˆ©ç”¨ `rt_mq`ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰åœ¨å¤šä¸ªçº¿ç¨‹é—´ä¼ é€’æ•°æ®ï¼›
- æ”¯æŒå¤šä¸ªä¸²å£è®¾å¤‡å¹¶è¡Œé€šä¿¡ã€‚



##  RT-Thread å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—å®éªŒ â€”â€” LEDã€æŒ‰é”®ä¸ä¸²å£é€šä¿¡

### ğŸ§© ä¸€ã€å®éªŒç›®çš„

é€šè¿‡æœ¬å®éªŒï¼Œå­¦ç”Ÿå°†å­¦ä¹ å¦‚ä½•åœ¨ RT-Thread å®æ—¶æ“ä½œç³»ç»Ÿä¸­ï¼š

- åˆ›å»ºå¤šçº¿ç¨‹ä»»åŠ¡ï¼ˆThreadï¼‰
- ä½¿ç”¨ **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰** å®ç°çº¿ç¨‹é—´é€šä¿¡
- å®ç°æŒ‰é”®æ§åˆ¶ LEDã€å¹¶é€šè¿‡ä¸²å£è¾“å‡ºçŠ¶æ€ä¿¡æ¯
- ç†è§£äº’æ–¥é”ï¼ˆMutexï¼‰åœ¨å…±äº«èµ„æºè®¿é—®ä¸­çš„ä½œç”¨

------

### âš™ï¸ äºŒã€å®éªŒç¯å¢ƒ

- å¼€å‘å¹³å°ï¼šSTM32 ç³»åˆ—å¼€å‘æ¿ï¼ˆRT-Thread æ”¯æŒçš„ä»»æ„å‹å·ï¼‰
- RTOSï¼šRT-Thread 5.x
- å·¥å…·é“¾ï¼šarm-none-eabi-gcc
- è°ƒè¯•æ–¹å¼ï¼šRT-Thread Studio æˆ–å‘½ä»¤è¡Œ make

------

### ğŸ§  ä¸‰ã€ç³»ç»ŸåŠŸèƒ½è®¾è®¡

ç³»ç»Ÿä¸»è¦ç”± **ä¸‰ä¸ªçº¿ç¨‹** ç»„æˆï¼š

| æ¨¡å—         | åŠŸèƒ½æè¿°                           | é€šä¿¡æ–¹å¼           |
| ------------ | ---------------------------------- | ------------------ |
| **key_app**  | è½®è¯¢æŒ‰é”®çŠ¶æ€ï¼Œç”ŸæˆæŒ‰é”®äº‹ä»¶æ¶ˆæ¯     | å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ— |
| **led_app**  | æ¥æ”¶æŒ‰é”®æ¶ˆæ¯ï¼Œç‚¹äº®æˆ–ç†„ç­å¯¹åº” LED   | ä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ |
| **uart_app** | æ¥æ”¶æŒ‰é”®æ¶ˆæ¯ï¼Œå¹¶å°†çŠ¶æ€é€šè¿‡ä¸²å£æ‰“å° | ä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ |

ä¸‰ä¸ªæ¨¡å—é€šè¿‡ä¸€ä¸ª **å…¨å±€æ¶ˆæ¯é˜Ÿåˆ— `key_mq`** å®ç°åŒæ­¥ä¸é€šä¿¡ã€‚

------

### ğŸ”„ å››ã€ç³»ç»Ÿé€šä¿¡ç»“æ„å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  key_appçº¿ç¨‹ â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  key_mqé˜Ÿåˆ— â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  led_appçº¿ç¨‹ â”‚
â”‚  æŒ‰é”®æ£€æµ‹    â”‚        â”‚ æ¶ˆæ¯ä¼ é€’   â”‚        â”‚ æ§åˆ¶LEDæ˜¾ç¤º  â”‚
â”‚  ç”Ÿæˆäº‹ä»¶    â”‚        â”‚             â”‚        â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â–²
       â”‚                                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      åŒæ—¶æ¶ˆæ¯å‘é€ç»™
                      â””â”€â”€â–¶ uart_appçº¿ç¨‹ï¼ˆä¸²å£è¾“å‡ºï¼‰
```

------

### ğŸ§© äº”ã€å…³é”®ä»£ç åˆ†æ

#### 1ï¸âƒ£ æ¶ˆæ¯ç»“æ„ä½“å®šä¹‰ï¼ˆ`key_app.h`ï¼‰

```c
typedef struct
{
    uint8_t key_id;   // æŒ‰é”®ç¼–å·ï¼ˆ1~6ï¼‰
    uint8_t action;   // åŠ¨ä½œï¼š1=æŒ‰ä¸‹, 0=æ¾å¼€
} key_msg_t;
```

#### 2ï¸âƒ£ æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºï¼ˆ`led_app.c`ï¼‰

```c
key_mq = rt_mq_create("key_mq",
                      sizeof(key_msg_t), // æ¯æ¡æ¶ˆæ¯å¤§å°
                      8,                 // é˜Ÿåˆ—æœ€å¤šä¿å­˜8æ¡
                      RT_IPC_FLAG_FIFO); // å…ˆè¿›å…ˆå‡º
```

è¯¥æ¶ˆæ¯é˜Ÿåˆ—ç”± LED æ¨¡å—åˆ›å»ºï¼Œ**æŒ‰é”®çº¿ç¨‹å’Œä¸²å£çº¿ç¨‹å…±äº«**ä½¿ç”¨ã€‚

#### 3ï¸âƒ£ æŒ‰é”®çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼ˆ`key_proc()`ï¼‰

```c
if (key_down >= 1 && key_down <= 6)
{
    msg.key_id = key_down;
    msg.action = 1; // æŒ‰ä¸‹
    rt_mq_send(key_mq, &msg, sizeof(msg));
}
```

å½“æ£€æµ‹åˆ°æŒ‰é”®æŒ‰ä¸‹æˆ–æ¾å¼€æ—¶ï¼Œå°†æ¶ˆæ¯ç»“æ„ä½“å‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ—ã€‚

#### 4ï¸âƒ£ LED çº¿ç¨‹æ¥æ”¶å¹¶æ˜¾ç¤ºï¼ˆ`led_proc()`ï¼‰

```c
if (rt_mq_recv(key_mq, &msg, sizeof(msg), RT_WAITING_FOREVER) == RT_EOK)
{
    rt_mutex_take(ucled_mutex, RT_WAITING_FOREVER);
    ucLed[msg.key_id - 1] = (msg.action == 1) ? 0 : 1; // ä½ç”µå¹³ç‚¹äº®
    rt_mutex_release(ucled_mutex);
    led_disp(ucLed);
}
```

LED æ¨¡å—é€šè¿‡äº’æ–¥é”ä¿æŠ¤ `ucLed` æ•°ç»„ï¼Œé˜²æ­¢çº¿ç¨‹ç«äº‰ã€‚

#### 5ï¸âƒ£ ä¸²å£çº¿ç¨‹æ‰“å°æ¶ˆæ¯ï¼ˆ`uart_proc()`ï¼‰

```c
if (rt_mq_recv(key_mq, &msg, sizeof(msg), RT_WAITING_FOREVER) == RT_EOK)
{
    if (msg.action == 1)
        rt_sprintf(buf, "key%d press\r\n", msg.key_id);
    else
        rt_sprintf(buf, "key%d release\r\n", msg.key_id);

    rt_device_write(serial, 0, buf, rt_strlen(buf));
}
```

æ­¤çº¿ç¨‹ä¸ LED æ¨¡å—å…±äº«åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°**å¤šçº¿ç¨‹åŒæ­¥æ¶ˆè´¹**ã€‚

------

### ğŸ§© å…­ã€çº¿ç¨‹åŒæ­¥æœºåˆ¶è¯´æ˜

1. **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ`rt_mq_t`ï¼‰**
   - ç”¨äºè·¨çº¿ç¨‹ä¼ é€’æŒ‰é”®äº‹ä»¶ã€‚
   - `key_app` â†’ `led_app` / `uart_app`ã€‚
   - çº¿ç¨‹å¯é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚
2. **äº’æ–¥é”ï¼ˆ`rt_mutex_t`ï¼‰**
   - ç”¨äºä¿æŠ¤å…±äº«å˜é‡ `ucLed[6]`ã€‚
   - ä¿è¯ LED çŠ¶æ€æ›´æ–°çš„åŸå­æ€§ã€‚
3. **ä¿¡å·é‡ï¼ˆ`rt_sem_t`ï¼‰**
   - åœ¨ UART é©±åŠ¨å›è°ƒä¸­ç”¨äºé€šçŸ¥æ¥æ”¶çº¿ç¨‹æœ‰æ–°æ•°æ®ã€‚

------

### ğŸ§ª ä¸ƒã€è°ƒè¯•ä¸é—®é¢˜åˆ†æ

åœ¨å®é™…è°ƒè¯•ä¸­ï¼Œé‡åˆ°äº†å‡ ä¸ªå…¸å‹é—®é¢˜ï¼š

#### âŒ 1. LED å…¨äº®é—®é¢˜

- **ç°è±¡**ï¼šç¨‹åºå¯åŠ¨åï¼ŒæŒ‰ä¸‹ä¸€ä¸ªé”®ï¼Œ6 ä¸ª LED åŒæ—¶ç‚¹äº®ã€‚

- **åŸå› **ï¼šLED æ•°ç»„åˆå§‹åŒ–é”™è¯¯ï¼ˆåªåˆå§‹åŒ–äº†ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚

- **è§£å†³**ï¼š

  ```c
  uint8_t ucLed[6] = {1,1,1,1,1,1};
  ```

#### âŒ 2. ä¸²å£ç¼–è¯‘è­¦å‘Š

- **è­¦å‘Šå†…å®¹**ï¼š

  ```
  warning: initialization from incompatible pointer type [-Wincompatible-pointer-types]
  ```

- **åŸå› **ï¼šUART å›è°ƒå‡½æ•°åŸå‹ä¸ RT-Thread API ä¸åŒ¹é…ã€‚

- **æ­£ç¡®å†™æ³•**ï¼š

  ```c
  static rt_err_t uart_input(rt_device_t dev, rt_size_t size)
  {
      rt_sem_release(&rx_sem);
      return RT_EOK;
  }
  ```

#### âŒ 3. LED çŠ¶æ€ä¸æŒ‰é”®é€»è¾‘ç›¸å

- **åŸå› **ï¼šLED ä¸ºä½ç”µå¹³ç‚¹äº®ï¼Œä½†é€»è¾‘æœªå–åã€‚

- **è§£å†³**ï¼š`ucLed[i] = 0` è¡¨ç¤ºç‚¹äº®ï¼Œ`ucLed[i] = 1` è¡¨ç¤ºç†„ç­ã€‚
   åœ¨ `led_disp()` ä¸­ç”¨ï¼š

  ```c
  if ((temp >> i) & 0x01)
      rt_pin_write(LED_PIN_BASE + i, PIN_LOW);
  else
      rt_pin_write(LED_PIN_BASE + i, PIN_HIGH);
  ```

------

### âœ… å…«ã€å®éªŒç»“æœ

è¿è¡Œæ•ˆæœï¼š

- æ‰€æœ‰ LED åˆå§‹ä¸ºç†„ç­çŠ¶æ€ï¼›

- æŒ‰ä¸‹ `KEY1`ï¼Œä»…å¯¹åº” LED1 ç‚¹äº®ï¼ŒåŒæ—¶ä¸²å£è¾“å‡ºï¼š

  ```
  key1 press
  ```

- æ¾å¼€ `KEY1`ï¼ŒLED ç†„ç­ï¼ŒåŒæ—¶ä¸²å£è¾“å‡ºï¼š

  ```
  key1 release
  ```

------

### ğŸ“ ä¹ã€æ€»ç»“ä¸æ€è€ƒ

é€šè¿‡æœ¬å®éªŒï¼Œå­¦ç”Ÿå¯ä»¥æŒæ¡ï¼š

- **å¤šçº¿ç¨‹åŒæ­¥** ä¸ **æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡** çš„å®é™…åº”ç”¨ï¼›
- å¦‚ä½•ç”¨ RT-Thread çš„ **IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰æœºåˆ¶** è®©ä»»åŠ¡è§£è€¦ï¼›
- å¦‚ä½•ç”¨äº’æ–¥é”é˜²æ­¢å…±äº«èµ„æºå†²çªï¼›
- å¦‚ä½•è®¾è®¡æ¨¡å—åŒ–åµŒå…¥å¼ç¨‹åºæ¶æ„ã€‚

------

## ğŸ“˜ åã€æ‰©å±•æ€è·¯

- åœ¨ UART çº¿ç¨‹ä¸­å¢åŠ å‘½ä»¤è§£æåŠŸèƒ½ï¼Œå®ç°è¿œç¨‹æ§åˆ¶ LEDï¼›
- ä½¿ç”¨å®šæ—¶å™¨ï¼ˆ`rt_timer_t`ï¼‰æ¨¡æ‹ŸæŒ‰é”®é˜²æŠ–ï¼›
- é€šè¿‡ `rt_event` æœºåˆ¶ä¼˜åŒ–å¤šçº¿ç¨‹ä¿¡å·åŒæ­¥ã€‚

------

âœ³ï¸ **ç»“è¯­**ï¼š
 æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå…¸å‹çš„ RTOS åˆçº§å¤šçº¿ç¨‹é€šä¿¡æ¡ˆä¾‹ã€‚
 æŒæ¡äº†è¿™ä¸€å®éªŒï¼Œä½ å°±å­¦ä¼šäº† RT-Thread æœ€æ ¸å¿ƒçš„ä¸‰ä¸ªæ¦‚å¿µï¼š**çº¿ç¨‹ã€æ¶ˆæ¯é˜Ÿåˆ—ã€äº’æ–¥é”ã€‚



